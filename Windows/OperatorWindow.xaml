<Window x:Class="IspAudit.Windows.OperatorWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
    xmlns:models="clr-namespace:IspAudit.Models"
        Title="ISP Audit — Оператор"
        Height="720" Width="1100"
        MinHeight="600" MinWidth="980"
        WindowStartupLocation="CenterScreen"
        Background="{DynamicResource MaterialDesignPaper}"
        FontFamily="{DynamicResource MaterialDesignFont}"
        TextElement.Foreground="{DynamicResource MaterialDesignBody}"
        TextElement.FontWeight="Regular"
        TextElement.FontSize="14">

    <Grid Margin="16">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Header -->
        <Grid Grid.Row="0" Margin="0,0,0,12">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <StackPanel>
                <TextBlock Text="Проверка сети" Style="{StaticResource H2Style}"/>
                <TextBlock Text="Режим: оператор" Opacity="0.7" FontSize="12"/>
            </StackPanel>

            <StackPanel Grid.Column="1" Orientation="Horizontal">
                <Button Style="{StaticResource ThemeToggleButtonStyle}"
                        Command="{Binding Main.ToggleThemeCommand}"
                        ToolTip="Переключить тему"
                        Height="30" Width="34" Margin="0,0,8,0">
                    <materialDesign:PackIcon Kind="ThemeLightDark" Width="20" Height="20"/>
                </Button>
                <Button Content="Инженерный режим"
                        Style="{StaticResource SecondaryButtonStyle}"
                        Padding="12,6"
                    Command="{Binding EngineerCommand}"/>
            </StackPanel>
        </Grid>

        <!-- Body -->
        <Border Grid.Row="1" Style="{StaticResource CardStyle}" Padding="16">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- Hero статус -->
                <Border Grid.Row="0" Padding="14" CornerRadius="10" BorderThickness="1" BorderBrush="{DynamicResource MaterialDesignDivider}" Background="{DynamicResource MaterialDesignCardBackground}" Margin="0,0,0,14">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>

                        <materialDesign:PackIcon Kind="{Binding Vm.HeroIconKind}"
                                                Width="38" Height="38" Margin="0,0,12,0"
                                                Foreground="{Binding Vm.HeroAccentBrush}"/>

                        <StackPanel Grid.Column="1">
                            <TextBlock Text="{Binding Vm.Headline}" FontSize="22" FontWeight="SemiBold"/>
                            <TextBlock Text="{Binding Vm.SummaryLine}" Margin="0,6,0,0" Opacity="0.85" TextWrapping="Wrap"/>
                        </StackPanel>
                    </Grid>
                </Border>

                <!-- Источник трафика (как в инженерном режиме) -->
                <StackPanel Grid.Row="1" Margin="0,0,0,14"
                            Visibility="{Binding Vm.IsSourceStepVisible, Converter={StaticResource BoolToVisibilityConverter}}">
                    <TextBlock Text="Источник трафика" Opacity="0.85" Margin="0,0,0,6"/>

                    <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
                        <RadioButton Content="Быстрая проверка интернета"
                                     IsChecked="{Binding Main.IsBasicTestMode, Mode=TwoWay}"
                                     IsEnabled="{Binding Vm.IsSourceSelectionEnabled}"
                                     Margin="0,0,14,0"/>
                        <RadioButton Content="Проверка выбранного приложения (.exe)"
                                     IsChecked="{Binding Main.IsBasicTestMode, Mode=TwoWay, Converter={StaticResource InverseBoolConverter}}"
                                     IsEnabled="{Binding Vm.IsSourceSelectionEnabled}"/>
                    </StackPanel>

                    <TextBlock TextWrapping="Wrap" Opacity="0.75" FontSize="12" Margin="0,0,0,10">
                        Быстрая проверка использует встроенный генератор тестового трафика. Проверка приложения анализирует трафик выбранной программы.
                    </TextBlock>

                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <TextBox Grid.Column="0"
                                 Style="{StaticResource ModernTextBoxStyle}"
                                 Text="{Binding Main.ExePath, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                 IsEnabled="{Binding Main.IsBasicTestMode, Converter={StaticResource InverseBoolConverter}}"
                                 IsReadOnly="{Binding Vm.IsSourceSelectionEnabled, Converter={StaticResource InverseBoolConverter}}"
                                 Height="36"
                                 materialDesign:HintAssist.Hint="Путь к .exe приложения/игры"
                                 ToolTip="Выберите .exe приложения/игры. Если выбран режим базовых сервисов — поле отключено."/>

                        <Button Grid.Column="1"
                                Content="Обзор..."
                                Style="{StaticResource SecondaryButtonStyle}"
                                Command="{Binding Main.BrowseExeCommand}"
                                IsEnabled="{Binding Main.IsBasicTestMode, Converter={StaticResource InverseBoolConverter}}"
                                Height="36" Margin="10,0,0,0"/>
                    </Grid>
                </StackPanel>

                <!-- Шаг 2: прогресс -->
                <Border Grid.Row="2" Padding="12" CornerRadius="8" BorderThickness="1" BorderBrush="{DynamicResource MaterialDesignDivider}" Background="{DynamicResource MaterialDesignCardBackground}" Margin="0,0,0,12"
                        Visibility="{Binding Vm.IsProgressStepVisible, Converter={StaticResource BoolToVisibilityConverter}}">
                    <StackPanel>
                        <TextBlock Text="Анализ сети…" FontWeight="SemiBold"/>
                        <ProgressBar Height="10" Margin="0,8,0,0"
                                     Minimum="0"
                                     Maximum="{Binding Main.ProgressBarMax}"
                                     Value="{Binding Main.CompletedTests, Mode=OneWay}"/>
                        <TextBlock Text="{Binding Main.RunningStatusText}" Opacity="0.8" Margin="0,6,0,0"/>
                    </StackPanel>
                </Border>

                <!-- Шаг 3: итог -->
                <Border Grid.Row="3" Padding="12" CornerRadius="8" BorderThickness="1" BorderBrush="{DynamicResource MaterialDesignDivider}" Background="{DynamicResource MaterialDesignCardBackground}" Margin="0,0,0,12"
                        Visibility="{Binding Vm.IsSummaryStepVisible, Converter={StaticResource BoolToVisibilityConverter}}">
                    <StackPanel>
                        <TextBlock Text="Итог" FontWeight="SemiBold"/>
                        <TextBlock Text="{Binding Vm.SummaryLine}" Opacity="0.85" Margin="0,6,0,0"/>
                    </StackPanel>
                </Border>

                <StackPanel Grid.Row="4" Margin="0,8,0,0">
                    <!-- CTA: один главный -->
                    <StackPanel Orientation="Horizontal" VerticalAlignment="Top">
                        <Button Content="{Binding Vm.PrimaryButtonText}"
                                Style="{StaticResource PrimaryButtonStyle}"
                                MinWidth="180" Height="44"
                                Command="{Binding Vm.PrimaryCommand}"
                                IsEnabled="{Binding Main.IsApplyRunning, Converter={StaticResource InverseBoolConverter}}"/>

                        <Button Content="Откатить"
                                Style="{StaticResource SecondaryButtonStyle}"
                                MinWidth="120" Height="44"
                                Margin="12,0,0,0"
                                Command="{Binding Vm.RollbackCommand}"/>
                    </StackPanel>

                    <!-- Детали (пока минимально) -->
                    <Expander Header="Подробности" Margin="0,12,0,0" IsExpanded="False">
                        <StackPanel>
                            <TextBlock Text="Состояние:" FontWeight="SemiBold"/>
                            <TextBlock Text="{Binding Main.DiagnosticStatus}"/>
                            <TextBlock Text="" Height="8"/>

                            <TextBlock Text="Автопилот обхода:" FontWeight="SemiBold"/>
                            <TextBlock Text="{Binding Main.AutoBypassStatus}"/>
                            <TextBlock Text="{Binding Main.AutoBypassVerdict}"/>
                            <TextBlock Text="{Binding Main.AutoBypassMetrics}"/>
                        </StackPanel>
                    </Expander>

                    <!-- История активности -->
                    <Expander Header="История активности" Margin="0,10,0,0" IsExpanded="False">
                        <StackPanel>
                            <WrapPanel Margin="0,0,0,10">
                                <TextBlock Text="Период:" Opacity="0.75" VerticalAlignment="Center"/>
                                <ComboBox Margin="8,0,16,0" MinWidth="140"
                                          SelectedValuePath="Tag"
                                          SelectedValue="{Binding Vm.HistoryTimeRange, Mode=TwoWay}">
                                    <ComboBoxItem Content="Сегодня" Tag="{x:Static models:OperatorHistoryTimeRange.Today}"/>
                                    <ComboBoxItem Content="7 дней" Tag="{x:Static models:OperatorHistoryTimeRange.Last7Days}"/>
                                    <ComboBoxItem Content="Всё" Tag="{x:Static models:OperatorHistoryTimeRange.All}"/>
                                </ComboBox>

                                <TextBlock Text="Тип:" Opacity="0.75" VerticalAlignment="Center"/>
                                <ComboBox Margin="8,0,16,0" MinWidth="180"
                                          SelectedValuePath="Tag"
                                          SelectedValue="{Binding Vm.HistoryTypeFilter, Mode=TwoWay}">
                                    <ComboBoxItem Content="Все" Tag="{x:Static models:OperatorHistoryTypeFilter.All}"/>
                                    <ComboBoxItem Content="Проверки" Tag="{x:Static models:OperatorHistoryTypeFilter.Checks}"/>
                                    <ComboBoxItem Content="Исправления/Откаты" Tag="{x:Static models:OperatorHistoryTypeFilter.Fixes}"/>
                                    <ComboBoxItem Content="Ошибки" Tag="{x:Static models:OperatorHistoryTypeFilter.Errors}"/>
                                </ComboBox>

                                <TextBlock Text="Группа:" Opacity="0.75" VerticalAlignment="Center"/>
                                <ComboBox Margin="8,0,16,0" MinWidth="180"
                                          ItemsSource="{Binding Vm.HistoryGroupOptions}"
                                          DisplayMemberPath="Title"
                                          SelectedValuePath="Key"
                                          SelectedValue="{Binding Vm.HistoryGroupKey, Mode=TwoWay}"/>

                                <Button Content="Очистить"
                                        Style="{StaticResource SecondaryButtonStyle}"
                                        Padding="10,4"
                                        Command="{Binding Vm.ClearHistoryCommand}"/>
                            </WrapPanel>

                            <ItemsControl ItemsSource="{Binding Vm.HistoryEvents}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Border BorderThickness="1" BorderBrush="{DynamicResource MaterialDesignDivider}" CornerRadius="8" Padding="10" Margin="0,0,0,8" Background="{DynamicResource MaterialDesignCardBackground}">
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="Auto"/>
                                                </Grid.ColumnDefinitions>

                                                <StackPanel>
                                                    <TextBlock Text="{Binding Title}" FontWeight="SemiBold"/>
                                                    <TextBlock Text="{Binding Details}" Opacity="0.75" TextWrapping="Wrap" Margin="0,3,0,0"/>
                                                </StackPanel>

                                                <TextBlock Grid.Column="1" Text="{Binding OccurredAtLocalText}" Opacity="0.65" Margin="12,0,0,0" VerticalAlignment="Top"/>
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>

                            <TextBlock Text="История пуста." Opacity="0.7"
                                       Visibility="{Binding Vm.HasHistory, Converter={StaticResource InverseBoolToVisibilityConverter}}"/>
                        </StackPanel>
                    </Expander>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Footer -->
        <Border Grid.Row="2" Margin="0,12,0,0" Padding="12" Background="{DynamicResource MaterialDesignCardBackground}" CornerRadius="8">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <StackPanel>
                    <TextBlock Text="Бортовой щит" FontWeight="SemiBold"/>
                    <TextBlock Text="Автопилот сам подберёт действия при проблемах. Стратегии не выбираются вручную в операторском режиме." Opacity="0.75" FontSize="12"/>
                    <TextBlock Text="{Binding Main.Bypass.IsBypassActive, StringFormat=Текущий обход активен: {0}}" Opacity="0.75" FontSize="12"/>
                </StackPanel>

                <ToggleButton Grid.Column="1"
                              Content="Автопилот"
                              Style="{StaticResource BypassToggleButtonStyle}"
                              IsChecked="{Binding Main.EnableAutoBypass, Mode=TwoWay}"
                              Margin="8,0,0,0"/>
            </Grid>
        </Border>
    </Grid>
</Window>
