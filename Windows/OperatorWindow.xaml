<Window x:Class="IspAudit.Windows.OperatorWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
        Title="ISP Audit — Оператор"
        Height="720" Width="1100"
        MinHeight="600" MinWidth="980"
        WindowStartupLocation="CenterScreen"
        Background="{DynamicResource MaterialDesignPaper}"
        FontFamily="{DynamicResource MaterialDesignFont}"
        TextElement.Foreground="{DynamicResource MaterialDesignBody}"
        TextElement.FontWeight="Regular"
        TextElement.FontSize="14">

    <Grid Margin="16">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Header -->
        <Grid Grid.Row="0" Margin="0,0,0,12">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <StackPanel>
                <TextBlock Text="Проверка сети" Style="{StaticResource H2Style}"/>
                <TextBlock Text="Режим: оператор" Opacity="0.7" FontSize="12"/>
            </StackPanel>

            <StackPanel Grid.Column="1" Orientation="Horizontal">
                <Button Style="{StaticResource ThemeToggleButtonStyle}"
                        Command="{Binding Main.ToggleThemeCommand}"
                        ToolTip="Переключить тему"
                        Height="30" Width="34" Margin="0,0,8,0">
                    <materialDesign:PackIcon Kind="ThemeLightDark" Width="20" Height="20"/>
                </Button>
                <Button Content="Инженерный режим"
                        Style="{StaticResource SecondaryButtonStyle}"
                        Padding="12,6"
                    Command="{Binding EngineerCommand}"/>
            </StackPanel>
        </Grid>

        <!-- Body -->
        <Border Grid.Row="1" Style="{StaticResource CardStyle}" Padding="16">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- Источник трафика (как в инженерном режиме) -->
                <StackPanel Grid.Row="0" Margin="0,0,0,14">
                    <TextBlock Text="Источник трафика" Opacity="0.85" Margin="0,0,0,6"/>

                    <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
                        <RadioButton Content="Быстрая проверка интернета"
                                     IsChecked="{Binding Main.IsBasicTestMode, Mode=TwoWay}"
                                     Margin="0,0,14,0"/>
                        <RadioButton Content="Проверка выбранного приложения (.exe)"
                                     IsChecked="{Binding Main.IsBasicTestMode, Mode=TwoWay, Converter={StaticResource InverseBoolConverter}}"/>
                    </StackPanel>

                    <TextBlock TextWrapping="Wrap" Opacity="0.75" FontSize="12" Margin="0,0,0,10">
                        Быстрая проверка использует встроенный генератор тестового трафика. Проверка приложения анализирует трафик выбранной программы.
                    </TextBlock>

                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <TextBox Grid.Column="0"
                                 Style="{StaticResource ModernTextBoxStyle}"
                                 Text="{Binding Main.ExePath, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                 IsEnabled="{Binding Main.IsBasicTestMode, Converter={StaticResource InverseBoolConverter}}"
                                 Height="36"
                                 materialDesign:HintAssist.Hint="Путь к .exe приложения/игры"
                                 ToolTip="Выберите .exe приложения/игры. Если выбран режим базовых сервисов — поле отключено."/>

                        <Button Grid.Column="1"
                                Content="Обзор..."
                                Style="{StaticResource SecondaryButtonStyle}"
                                Command="{Binding Main.BrowseExeCommand}"
                                IsEnabled="{Binding Main.IsBasicTestMode, Converter={StaticResource InverseBoolConverter}}"
                                Height="36" Margin="10,0,0,0"/>
                    </Grid>
                </StackPanel>

                <TextBlock Grid.Row="1" Text="{Binding Vm.Headline}" FontSize="22" FontWeight="SemiBold"/>
                <TextBlock Grid.Row="2" Text="{Binding Vm.SummaryLine}" Margin="0,6,0,0" Opacity="0.85"/>

                <StackPanel Grid.Row="3" Orientation="Horizontal" Margin="0,16,0,0">
                        <Button Content="{Binding Vm.PrimaryButtonText}"
                            Style="{StaticResource PrimaryButtonStyle}"
                            MinWidth="160" Height="42"
                            Command="{Binding Vm.PrimaryCommand}"
                            Visibility="{Binding Vm.ShowPrimaryButton, Converter={StaticResource BoolToVisibilityConverter}}"/>

                        <Button Content="{Binding Vm.FixButtonText}"
                            Style="{StaticResource PrimaryButtonStyle}"
                            MinWidth="160" Height="42"
                            Margin="0,0,0,0"
                            Command="{Binding Vm.FixCommand}"
                            IsEnabled="{Binding Main.IsApplyRunning, Converter={StaticResource InverseBoolConverter}}"
                            Visibility="{Binding Vm.ShowFixButton, Converter={StaticResource BoolToVisibilityConverter}}"/>

                    <Button Content="Откатить"
                            Style="{StaticResource SecondaryButtonStyle}"
                            MinWidth="120" Height="42"
                            Margin="12,0,0,0"
                            Command="{Binding RollbackCommand}"/>
                </StackPanel>

                <!-- Детали (пока минимально) -->
                <Expander Grid.Row="4" Header="Подробности" Margin="0,18,0,0" IsExpanded="False">
                    <StackPanel>
                        <TextBlock Text="Состояние:" FontWeight="SemiBold"/>
                        <TextBlock Text="{Binding Main.DiagnosticStatus}"/>
                        <TextBlock Text="" Height="8"/>

                        <TextBlock Text="Автопилот обхода:" FontWeight="SemiBold"/>
                        <TextBlock Text="{Binding Main.AutoBypassStatus}"/>
                        <TextBlock Text="{Binding Main.AutoBypassVerdict}"/>
                        <TextBlock Text="{Binding Main.AutoBypassMetrics}"/>
                    </StackPanel>
                </Expander>
            </Grid>
        </Border>

        <!-- Footer -->
        <Border Grid.Row="2" Margin="0,12,0,0" Padding="12" Background="{DynamicResource MaterialDesignCardBackground}" CornerRadius="8">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <StackPanel>
                    <TextBlock Text="Бортовой щит" FontWeight="SemiBold"/>
                    <TextBlock Text="Автопилот сам подберёт действия при проблемах. Стратегии не выбираются вручную в операторском режиме." Opacity="0.75" FontSize="12"/>
                    <TextBlock Text="{Binding Main.Bypass.IsBypassActive, StringFormat=Текущий обход активен: {0}}" Opacity="0.75" FontSize="12"/>
                </StackPanel>

                <ToggleButton Grid.Column="1"
                              Content="Автопилот"
                              Style="{StaticResource BypassToggleButtonStyle}"
                              IsChecked="{Binding Main.EnableAutoBypass, Mode=TwoWay}"
                              Margin="8,0,0,0"/>
            </Grid>
        </Border>
    </Grid>
</Window>
