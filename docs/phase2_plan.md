# Фаза 2 / DPI-intelligence v2 — план и статус

## Как читать этот документ
Этот файл теперь разделён на две части:
- **Часть A (Phase 2, историческая)**: фиксирует уже сделанное и идеи стратегий (2.1–2.6).
- **Часть B (DPI-intelligence v2, актуальная)**: новый контракт архитектуры и пошаговый план внедрения.

Ключевое решение при смене стратегии:
- Уже реализованные доработки **не выбрасываем** — они становятся “исполнительными возможностями” (strategies/executor).
- Но **не продолжаем развивать** старый подход “эвристики → рекомендации” как основной путь. Новые изменения делаем только как шаги v2.

## Короткий ответ на вопрос “нужны ли прежние доработки?”
Да, но в другой роли.
- 2.6 (TLS fragmentation/disorder) и 2.5 (TTL/AutoTTL) — это готовые **атомарные стратегии** и опции, которые пригодятся в v2 на уровне **Executor**.
- 2.4 (auto-hostlist) полезен как источник контекста “какие хосты подозрительные”, но **не обязателен для MVP v2** (первые шаги v2 можно делать без него).
- 2.1/2.2/2.3 — стоит отложить до тех пор, пока не стабилизированы **Signals → Diagnosis → Selector** (иначе будут регрессии и “винегрет”).

---

## Часть B — DPI-intelligence v2 (актуально, зафиксировано на 16.12.2025)

### Цель
Перевести рекомендации/обход из смеси эвристик в **экспертную систему** с объяснимыми решениями и контролируемыми регрессиями.

### Жёсткая архитектура слоёв (контракт)
```
[ Sensors ]
  ↓
[ Signals ]                 // только факты
  ↓
[ Diagnosis Engine ]        // что происходит
  ↓
[ DpiDiagnosis + Confidence ]
  ↓
[ Strategy Selector ]       // что делать
  ↓
[ BypassPlan ]
  ↓
[ Executor ]                // применяет план, не думает
  ↓
[ Outcome ]
  ↓
[ Feedback Store ]          // ранжирование, без удаления правил
```

### Запрещено
- Диагностике знать про фрагментацию/TTL/порядок чанков.
- Стратегиям смотреть на TTL/ретрансмиссии/тайминги/пакеты.
- Feedback менять диагноз напрямую (только корректирует приоритеты стратегий).

### MVP-граница
- Стартуем с 2 диагнозов и доводим до качества.
- Feedback: без автоудаления правил, только ранжирование.
- В MVP запрещено: ML, динамические JSON-условия, автогенерация правил.

### Пошаговый план внедрения (без “сюрпризов”)
0) **Design Contract (документ)**: этот раздел — единственный источник правды для моделей/границ слоёв.
   - Критерий: однозначные определения моделей/интерфейсов, без внедрения в runtime.
1) **Signals Adapter (логирование)**: собрать `BlockageSignals(v2)` из текущих данных (`HostTested` + state store), логировать и сравнить с реальностью.
   - Критерий: сигналы заполняются предсказуемо на 10+ хостах.
2) **Diagnosis Engine v2 (2 диагноза)**: реализовать 2 диагноза и правила к ним + объяснение (RuleName/Confidence).
   - Критерий: диагноз стабилен между запусками и объясним.
3) **Strategy Selector v2**: таблица `Diagnosis → Strategy + priority`, выдаёт `BypassPlan`.
   - Критерий: план детерминированный, без доступа к Sensors.
4) **Executor/Outcome/Feedback (без авто-применения)**: в MVP советник только рекомендует; исполнение остаётся ручным.
   - Критерий: никакого авто-включения bypass по ходу диагностики.
5) **Интеграция в UI-рекомендации**: заменить текущие рекомендации на v2 только когда шаги 1–4 готовы.
   - Критерий: новые рекомендации не ухудшают поведение браузера “по умолчанию”, слабые диагнозы не предлагают агрессивные стратегии.

---

## Часть A — Phase 2 (историческая) как “каталог стратегий” + фактический статус

### Статус по коду (актуально на 16.12.2025)
- [x] 2.6: TLS Fragment/Disorder параметризация — реализовано.
- [x] 2.5: TTL Fake/AutoTTL + сохранение в профиль — реализовано.
- [ ] 2.4: Auto-hostlist — частично: сбор/отображение кандидатов в UI реализовано; доведение “качества списка” отдельно.
- [ ] 2.1: HTTP Host трюки — не реализовано.
- [ ] 2.2: Bad checksum — не реализовано; есть блокер на уровне движка (checksum пересчитывается).
- [ ] 2.3: QUIC/UDP обфускация — не реализовано.

### Как пункты 2.1–2.6 ложатся на v2 (чтобы не смешивать ответственность)
- **Sensors/Signals**: должны описывать факты (RST/ретрансмиссии/редиректы/ошибки), но не выбирать байпас.
- **Diagnosis**: интерпретирует Signals.
- **Selector**: выбирает стратегию.
- **Executor**: применяет конкретную стратегию.

Маппинг “Phase2 пункт → слой v2”:
- 2.6 TLS Fragment/Disorder → **Executor strategy**.
- 2.5 TTL/AutoTTL → **Executor strategy**.
- 2.4 Auto-hostlist → **Signals enrichment / HostContext** (подсказка “какие хосты важны”, но без автоприменения).
- 2.1 HTTP Host трюки → **Executor strategy** (per-host).
- 2.2 Bad checksum/sequence → **Executor strategy** (после снятия блокера движка).
- 2.3 QUIC/UDP obfuscation → **Executor strategy** (per-host).

### Блокеры
- 2.2 Bad checksum: пока `TrafficEngine` пересчитывает checksum перед отправкой, режим «bad checksum» физически не достижим — нужен явный режим отправки без пересчёта для специально инъецируемых пакетов.

---

## Приложение: факты реализации (кратко)

### 2.6 TLS Fragment/Disorder — что именно реализовано (факт)
- TLS bypass вынесен в `TlsBypassService`: сервис сам регистрирует/удаляет `BypassFilter`, нормализует опции, шлёт события `MetricsUpdated/VerdictChanged/StateChanged`.
- Параметры фрагментации сохраняются в `bypass_profile.json`; пресеты восстанавливаются из профиля; есть валидация (мин. 4 байта, сумма в диапазоне, иначе откат к безопасному списку).
- Ограничения применения: только TLS ClientHello на порту 443 с SNI и длиной ≥ threshold.

### 2.5 TTL Fake/AutoTTL — что именно реализовано (факт)
- Сохранение/загрузка TTL-полей и флага `autoTtl` в `bypass_profile.json`.
- TTL-параметры применимы в рантайме через `TlsBypassService`.
- AutoTTL: малый перебор TTL 2..8 по метрикам, выбор и сохранение лучшего.

### 2.4 Auto-hostlist — текущий статус (факт)
- Реализован сбор и отображение кандидатов в UI без авто-применения.
- Доведение качества списка (лимиты/антишум/детерминизм) — отдельная задача, но не блокирует шаги v2 (1–3).
