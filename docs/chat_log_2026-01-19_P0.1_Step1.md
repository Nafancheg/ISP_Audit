# Chat Log — 2026-01-19 — P0.1 Step 1 (multi-group) + REG-005/006 + TCP/80 per-target

Дата: 19.01.2026

Контекст проекта: Windows-native .NET 9 WPF приложение ISP_Audit (диагностика блокировок + обход через WinDivert). Цель работ — закрыть P0.1 Step 1: поддержка нескольких активных целей/групп одновременно, где Decision Graph выбирает действие по признакам пакета.

Важно: этот файл фиксирует **то, что было доступно в контексте текущей сессии Copilot** (включая переданный “conversation-summary” и выполненные изменения в репозитории). Это **не гарантирует 100% дословный полный лог** всей переписки в UI Copilot Chat.

Если нужен именно полный дословный чат без сокращений:
- экспортируйте чат из UI VS Code Copilot (Export/Copy conversation) и положите файл в `docs/` — я оформлю ссылку и сохраню в репо.

---

## Коротко: что просили

- Пользователь: «продолжай» — продолжить P0.1 Step 1: *несколько активных групп одновременно; Decision Graph выбирает действие по признакам пакета*.
- Пользователь: «надо сделать сразу, как надо… не вижу что сделал/что осталось» — обновить `docs/TODO.md` с ясным статусом Step 1.
- Пользователь: «сохрани контекст чата в доках» — добавить chat-log в репозиторий.

---

## Что было сделано (по сути Step 1)

### 1) Multi-target QUIC fallback (UDP/443) — union по нескольким активным целям

- Реализовано: селективный `DropUdp443` (QUIC→TCP) собирает целевые IPv4 как **union** по нескольким недавно активным hostKey.
- Регресс-гейт: `REG-005`.
- Валидировано: `--smoke reg --no-skip --strict` PASS.
- Коммит в истории сессии: `5042559`.

### 2) Multi-group TCP/443 TLS strategy selection — per-target политика по dst_ip

- Реализовано: хранение небольшого кэша «активных целей» (TTL/cap) и компиляция DecisionGraph snapshot так, чтобы:
  - для каждой активной цели добавлялась политика `tcp443_tls_<hostKey>` (Priority=110, match по `dst_ip`, `tcp/443`, `tls_stage=ClientHello`),
  - плюс глобальный fallback `tcp443_tls_clienthello_strategy` (Priority=100).
- Смысл: можно последовательно применить разные стратегии к разным целям, и они **не перетирают** друг друга — выбор стратегии происходит per packet.
- Регресс-гейт: `REG-006`.
- Валидировано: `--smoke reg --no-skip --strict` PASS.
- Коммит в истории сессии: `6fb1b08`.

Ключевые места:
- `Bypass/BypassStateManager.ActiveTargets.cs` — кэш активных целей.
- `Bypass/BypassStateManager.cs` — компиляция per-target TCP/443 policy + fallback.
- `ViewModels/BypassController.V2.cs` — запоминание per-target intent при `ApplyV2PlanAsync`.
- `TestNetworkApp/Smoke/SmokeTests.Reg.cs` — `REG-006`.
- `TestNetworkApp/Smoke/SmokeTests.Registry.cs` и `TestNetworkApp/smoke_tests_plan.md` — регистрация/описание.

### 3) Multi-group TCP/80 HTTP Host tricks — per-target политика по dst_ip (с fallback)

- Реализовано: если включён policy-driven TCP/80 и `HttpHostTricksEnabled`, то при наличии активных целей компилируются per-target политики:
  - `tcp80_http_host_tricks_<hostKey>` (Priority=110, match по `dst_ip`, `tcp/80`),
  - fallback на глобальную `tcp80_http_host_tricks` остаётся только если per-target правила собрать не удалось.
- Валидировано: `--smoke reg --no-skip --strict` PASS (косвенно: регрессии не сломались).
- Коммит в истории сессии: `066b6a4`.

---

## Документация/наблюдаемость

- Обновлено: `docs/TODO.md` — теперь у P0.1 Step 1 есть явный список «сделано/осталось».
  - Коммит: `6b21a3f`.
- Обновлено ранее в рамках этой серии изменений: `ARCHITECTURE_CURRENT.md`, `docs/full_repo_audit_v2.md` (упоминание REG-006 и multi-group логики).

---

## Что ещё осталось по P0.1 Step 1 (на момент этого лога)

Минимум, чтобы отметить Step 1 как полностью закрытый:
- Добавить отдельный regression smoke-тест на TCP/80 per-target (`tcp80_http_host_tricks_<hostKey>`), аналогичный `REG-006`, чтобы выбор по `dst_ip` был закреплён тестом.

Опционально (как усиление гарантий):
- Добавить smoke-гейт на «capabilities union»: применение плана к цели B не должно выключать capabilities, нужные цели A (например, Fragment остаётся разрешённым после Disorder для другой цели), пока обе цели остаются активными.

---

## Команды валидации, которые использовались

- `dotnet build`
- `dotnet run --project TestNetworkApp -- --smoke reg --no-skip --strict`

---

## Почему лог частичный

Copilot в режиме агента не имеет гарантированного доступа к полному “сырому” логу переписки, если он не был передан в контекст запроса.
Этот файл фиксирует максимум полезного: цели, решения, изменения в коде/доках, тесты и коммиты.
