# Multi-Layer подход: Network + Flow + Socket (WinDivert)

> **ВАЖНО**: Данный подход актуален для **Stage2** (детальный анализ конкретных целей) и **Stage1** (поиск IP-адресов).
> Используется комбинация слоев для максимального покрытия всех сценариев (включая блокировки).

## Суть

Решаем проблему атрибуции трафика и обнаружения заблокированных соединений.

Используем возможности WinDivert на 100%:
1. **Layer.Flow**: Получаем события создания успешных соединений (содержат **PID** процесса).
2. **Layer.Socket**: Получаем события *попыток* соединения (вызов `connect()`), даже если сеть недоступна.
3. **Layer.Network**: Захватываем сами пакеты (DNS, данные).

## Проблема предыдущих подходов

1. **Polling (GetExtendedTcpTable)**: Пропускает короткоживущие соединения (< 1 сек).
2. **Flow-only**: Не видит соединения, которые блокируются на этапе рукопожатия (SYN-дроп, нет `FLOW_ESTABLISHED`).
3. **Network-only**: Видим пакеты, но не знаем PID (особенно для UDP).

## Алгоритм (Multi-Layer)

Запускаем параллельные потока чтения WinDivert в режиме `Sniff` (только чтение) с разными приоритетами.

### Поток 1: Flow Monitor (Layer.Flow)
Слушает события успешных соединений.
- Приоритет: `-1000`
- Фильтр: `true` (все события)
- При событии `FLOW_ESTABLISHED`:
  - Извлекаем: `ProcessId`, `LocalPort`, `RemoteIp`, `RemotePort`, `Protocol`.
  - Генерируем событие "Новое соединение".

### Поток 2: Socket Monitor (Layer.Socket)
Слушает намерения приложений.
- Приоритет: `-1000`
- Фильтр: `true`
- При событии `SOCKET_CONNECT`:
  - Видим попытку соединения *до* отправки пакетов.
  - Позволяет детектировать ресурсы, заблокированные по IP (например, 1.1.1.1), когда SYN-пакеты дропаются и Flow-событие не наступает.

### Поток 3: DNS Sniffer (Layer.Network)
Слушает DNS-трафик.
- Приоритет: `0`
- Фильтр: `udp.DstPort == 53 or udp.SrcPort == 53`
- Парсит DNS-запросы и ответы для сопоставления IP <-> Hostname.

## Преимущества

| Критерий | Flow-only | Multi-Layer (Новый) |
|----------|-----------|---------------------|
| **Успешные соединения** | ✅ Видит | ✅ Видит |
| **Заблокированные IP** | ❌ Не видит (нет Flow) | ✅ Видит (через Socket) |
| **IPv6** | ❌ Ограничено | ✅ Полная поддержка |
| **Приоритет** | 0 (конфликт с Bypass) | -1000 (полная пассивность) |

## Реализация

См. `Utils/FlowMonitorService.cs` и `Utils/DnsParserService.cs`.
````