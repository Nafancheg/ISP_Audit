# Анализ текущего состояния ISP Audit

## 1. Назначение и текущий функционал

ISP Audit — настольное приложение на .NET для диагностики сетевых ограничений провайдера. Оно выполняет серию тестов для заданных целевых хостов и выводит подробный отчёт. Текущие проверки включают:

- **DNS**: сравнение ответов обычного резолвера и DoH Cloudflare для выявления подмены или фильтрации записей.
- **TCP**: попытки подключиться к портам 80 и 443 у целевого хоста для определения доступности HTTP(S).
- **HTTP(S)**: загрузка страниц по HTTPS (включая `https://host`, `https://www.host` и быстрый URL) с фиксацией кодов ответа, ошибок и сведений о TLS-сертификате.
- **Traceroute**: трассировка до хоста (без обратного резолвинга) на глубину до 30 прыжков для выявления точки обрыва маршрута.
- **UDP DNS**: UDP-запрос на 1.1.1.1:53 (Cloudflare) для проверки блокировок UDP/QUIC.
- **RST-эвристика**: измерение времени до принудительного закрытия TCP-соединений для детекции инъекций RST.

По окончании тестов приложение формирует сводный отчёт с техническими результатами и агрегированными рекомендациями. Пользователь может регулировать список хостов и набор тестов, управляя чекбоксами и таймаутами.

## 2. Основные несоответствия целевой задаче (Star Citizen)

1. **Нет фокуса на инфраструктуру игры.** Список целей по умолчанию содержит общеизвестные домены (YouTube, Discord и т.п.), но отсутствуют сервисы Star Citizen. Пользователю приходится вручную добавлять важные адреса лаунчера и игровых серверов.
2. **Неполное покрытие портов и протоколов.** Тесты ориентированы на веб-порты 80/443 и один UDP-кейс (DNS). Игровые сервисы Star Citizen могут использовать специфические TCP/UDP-порты, которые не проверяются.
3. **Сложный для новичка UX.** Интерфейс перегружен техническими подробностями (таблица шагов, лог, множество полей), а ключевой вывод и рекомендации скрыты в малозаметном текстовом поле внизу. Итоговый блок «txtAnalysis» расположен внизу окна и легко пропускается.
4. **Слабая видимость отчёта.** Пользователь не видит причины блокировки и текущее состояние после тестирования без прокрутки к нижней панели; итоговые выводы не сопровождаются визуальными индикаторами статуса.
5. **Рекомендации трудны для применения.** Сообщения полны технических терминов (DoH, SNI, DNSCrypt) и не сопровождаются шагами «что сделать прямо сейчас».
6. **Нет автоматизации обхода блокировок.** Приложение ограничивается диагностикой; пользователю приходится самостоятельно искать VPN/DoH и т.п.

## 3. Рекомендации по UX и интерфейсу

1. **Выделить блок итогов.** Поместить сводные результаты и советы в верхнюю/центральную часть окна или открывать их модальным окном сразу после теста. Увеличить высоту блока рекомендаций, добавить крупный статус «Проблемы обнаружены / Всё в порядке» с цветовой индикацией и кратким перечнем причин блокировки.
2. **Сократить визуальный шум.** Скрыть подробный лог и таблицу шагов за кнопкой «Подробнее» или вынести в режим эксперта. Для обычного сценария оставить кнопку «Проверить», прогресс-бар, индикатор текущего шага («Проверяем DNS», «Проверяем TLS») и итог.
3. **Упростить формулировки.** Заменить «DNS_FILTERED» и аналогичные сообщения на понятный текст («Провайдер подменяет DNS-ответы»), добавить пояснения и примеры решений, выделить цветом (зелёный/жёлтый/красный) иконками «OK/!». 
4. **Локализовать элементы.** Привести подписи к единому русскому стилю («Таймаут (с)», «Трассировка»), добавить всплывающие подсказки с понятными объяснениями сложных настроек.
5. **Готовые сценарии.** Спрятать ручное редактирование списка целей в расширенные настройки. По умолчанию — преднастроенный набор тестов для Star Citizen, чтобы новичку было достаточно нажать «Проверить».

## 4. Расширение функционала под Star Citizen

1. **Предустановленные цели.** Добавить в конфигурацию ключевые домены игры: `robertsspaceindustries.com`, хосты лаунчера/патч-сервера и игровые шлюзы. По возможности определить адреса из логов лаунчера и обновлять список по мере изменений.
2. **Расширенные порты и протоколы.** Добавить проверку TCP-портов, которые использует игра (например, 64000+), и предусмотреть отдельные UDP-тесты для игровых серверов и CDN. Опционально — дать возможность задавать порты в GUI без усложнения основного сценария.
3. **Усиленная DNS-диагностика.** Для игровых доменов явно предупреждать, если системный DNS не возвращает записи, подставляет неподходящие IP или ломает CNAME-цепочку. Показывать найденные расхождения рядом с итогами.
4. **Контекстные рекомендации.** В отчёте выделять проблемы, связанные именно с сервисами Star Citizen, и выдавать советы типа «Включите VPN перед запуском лаунчера» или «Включите безопасный DNS в Windows 11» с коротким описанием действий.
5. **Удобный экспорт.** Добавить кнопку «Скопировать итог» или генерацию HTML/PDF-отчёта для отправки в поддержку или друзьям.
6. **Автовыбор целей (опционально).** Считывать настройки установленного лаунчера Star Citizen или его логи, чтобы автоматически подставлять актуальные домены/CDN.

## 5. Обход блокировок (Stage 2, WinDivert)

1. **DPI-bypass из коробки.** Интегрировать с WinDivert стратегию блокировки RST и фрагментации TLS ClientHello (аналог GoodbyeDPI) и включать её по кнопке «Обход блокировок», когда диагностика выявляет проблемы с TLS.
2. **Избирательная фильтрация.** Настраивать WinDivert на перехват только трафика Star Citizen (определённые IP/порты), чтобы не ломать другие приложения и снизить нагрузку.
3. **Проксирование при жёсткой блокировке.** Рассмотреть возможность локального прокси/туннеля для конкретных хостов, если IP-адреса полностью недоступны. Даже частичный SOCKS5-туннель для лаунчера может помочь.
4. **Контроль из интерфейса.** Добавить переключатель «Обход включён», индикатор статуса и обработку ошибок (WinDivert требует прав администратора). Предупреждать пользователя о необходимости UAC и возможных рисках, предоставлять инструкции по перезапуску с повышенными правами.
5. **Обработка ошибок запуска.** Перехватывать коды ошибок WinDivert, выводить понятные подсказки («Не удалось загрузить драйвер, запустите программу от имени администратора») и логировать технические детали в скрытом режиме для отладки.
6. **Переход на веб-интерфейс.** Рассмотреть перенос UI на локальный веб-сервер (HTML/CSS/JS). Это упростит создание современного интерфейса, позволит легко локализовать тексты и встроить справочные ссылки или инструкции.

## 6. Следующие шаги

1. Спроектировать новый UX-макет с акцентом на итог и кнопку обхода блокировок.
2. Собрать список доменов и портов Star Citizen, обновить дефолтную конфигурацию и добавить автотесты для проверки доступности.
3. Реализовать расширенные порты/UDP-тесты, убедившись, что интерфейс остаётся простым.
4. Добавить пошаговые статусы («Проверка DNS», «Проверка TLS», «Анализ результатов»), чтобы пользователь понимал, что делает программа.
5. Интегрировать WinDivert: подготовить драйвер, реализовать включение/отключение обхода и обработку ошибок.
6. Провести пользовательское тестирование на целевой аудитории (игроки Star Citizen), уточнить формулировки рекомендаций и проверить удобство отчётов/экспорта.

Документ отражает текущее состояние приложения и шаги, необходимые для адаптации ISP Audit к сценарию помощи игрокам Star Citizen.
