# –ê–Ω–∞–ª–∏–∑ –ø–ª–∞–Ω–∞ ISP_Audit Roadmap (plan3.md)

**–î–∞—Ç–∞:** 20.01.2026
**–í–µ—Ä—Å–∏—è:** –° –ø—Ä–∏–≤—è–∑–∫–æ–π –∫ —Ä–µ–∞–ª—å–Ω–æ–º—É –∫–æ–¥—É –ø—Ä–æ–µ–∫—Ç–∞

---

## üìä –û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞

| –ö—Ä–∏—Ç–µ—Ä–∏–π | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|----------|--------|-------------|
| **–ü–æ–ª–Ω–æ—Ç–∞** | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (5/5) | –û—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –≤—Å–µ –∞—Å–ø–µ–∫—Ç—ã: —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏—è, UX, observability, –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ |
| **–†–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ—Å—Ç—å** | ‚≠ê‚≠ê‚≠ê‚≠ê (4/5) | –°—Ä–æ–∫–∏ –∞–º–±–∏—Ü–∏–æ–∑–Ω—ã–µ, –Ω–æ –¥–æ—Å—Ç–∏–∂–∏–º—ã –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ |
| **–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç—å** | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (5/5) | –ß—ë—Ç–∫–∏–µ —Ñ–∞–∑—ã, –∫—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞, deliverables |
| **–ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è** | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (5/5) | –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π P0‚ÜíP3 –ø–æ—Ä—è–¥–æ–∫, —Å–Ω–∞—á–∞–ª–∞ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å |
| **–†–∏—Å–∫-–º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç** | ‚≠ê‚≠ê‚≠ê‚≠ê (4/5) | –†–∏—Å–∫–∏ –æ–ø–∏—Å–∞–Ω—ã, –Ω–æ buffer –≤—Ä–µ–º–µ–Ω–∏ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–µ–Ω |

### –°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã –ø–ª–∞–Ω–∞:
- ‚úÖ –ù–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∫—Ä–∞—à–µ–π (P0.1) ‚Äî –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥
- ‚úÖ –î–µ—Ç–∞–ª—å–Ω—ã–π debug-–ø—Ä–æ—Ü–µ—Å—Å —Å –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–º–∏ –∑–∞–¥–∞—á–∞–º–∏
- ‚úÖ –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è Policy-Driven (–Ω–µ Big Bang)
- ‚úÖ Feature flags –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –æ—Ç–∫–∞—Ç–∞
- ‚úÖ Dual mode –¥–ª—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å—Ç–∞—Ä–æ–π –∏ –Ω–æ–≤–æ–π –ª–æ–≥–∏–∫–∏
- ‚úÖ –ú–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—Ö–∞ (KPI) —á—ë—Ç–∫–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã

### –û–±–ª–∞—Å—Ç–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è:
- ‚ö†Ô∏è 20-–Ω–µ–¥–µ–ª—å–Ω—ã–π timeline –º–æ–∂–µ—Ç —Ä–∞—Å—Ç—è–Ω—É—Ç—å—Å—è (–Ω—É–∂–µ–Ω buffer 30-40%)
- ‚ö†Ô∏è –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –∑–∞–¥–∞—á–∏ P1-P2 –º–æ–∂–Ω–æ —É–ø—Ä–æ—Å—Ç–∏—Ç—å –∏–ª–∏ –æ—Ç–ª–æ–∂–∏—Ç—å
- ‚ö†Ô∏è Policy-Driven ‚Äî –≤—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫, –Ω—É–∂–µ–Ω –±–æ–ª–µ–µ –¥–µ—Ç–∞–ª—å–Ω—ã–π spike

### –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ (–≤–∞–∂–Ω–æ!):
- ‚úÖ **Policy-Driven –±–∞–∑–æ–≤–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –£–ñ–ï —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞** (—Å–º. `FlowPolicy`, `DecisionGraphSnapshot`, `PolicySetCompiler`)
- ‚úÖ **BypassStateManager** ‚Äî –µ–¥–∏–Ω—ã–π SSoT –¥–ª—è bypass, —É–∂–µ –µ—Å—Ç—å guard-–º–µ—Ö–∞–Ω–∏–∑–º
- ‚úÖ **–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ Apply** ‚Äî –∂—É—Ä–Ω–∞–ª `BypassApplyTransactionJournal` —É–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ **–°–µ–ª–µ–∫—Ç–∏–≤–Ω—ã–π UDP/443** ‚Äî —É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω (observed IPv4 targets)
- ‚ö†Ô∏è **TrafficEngine crash** ‚Äî –ø—Ä–æ–±–ª–µ–º–∞ –∞–∫—Ç—É–∞–ª—å–Ω–∞, —Ç—Ä–µ–±—É–µ—Ç —Ñ–∏–∫—Å–∞

---

## ÔøΩÔ∏è –ö–∞—Ä—Ç–∞ —Ñ–∞–π–ª–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞ (–ø—Ä–∏–≤—è–∑–∫–∞ –∫ –∑–∞–¥–∞—á–∞–º)

### P0.1: TrafficEngine crash ‚Äî –∫–ª—é—á–µ–≤—ã–µ —Ñ–∞–π–ª—ã

| –§–∞–π–ª | –†–æ–ª—å | –ü—Ä–æ–±–ª–µ–º–∞ |
|------|------|----------|
| [Core/Traffic/TrafficEngine.cs](../Core/Traffic/TrafficEngine.cs#L268) | –ì–ª–∞–≤–Ω—ã–π loop –ø–∞–∫–µ—Ç–æ–≤ | –ú–µ—Å—Ç–æ crash: `Loop crashed: {ex.Message}` (—Å—Ç—Ä–æ–∫–∞ 268) |
| [Core/Traffic/TrafficEngine.cs](../Core/Traffic/TrafficEngine.cs#L13) | –ö–æ–ª–ª–µ–∫—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ | `_filters` (List) –ø–æ–¥ `lock`, –Ω–æ –∏—Ç–µ—Ä–∞—Ü–∏—è –≤–Ω—É—Ç—Ä–∏ lock (—Å—Ç—Ä–æ–∫–∞ 203-218) |
| [Core/Traffic/Filters/BypassFilter.ProbeFlows.cs](../Core/Traffic/Filters/BypassFilter.ProbeFlows.cs#L47) | Probe flows cleanup | ‚ö†Ô∏è **–ü–û–¢–ï–ù–¶–ò–ê–õ–¨–ù–ê–Ø –ì–û–ù–ö–ê**: `foreach` + `TryRemove` –Ω–∞ `ConcurrentDictionary` (—Å—Ç—Ä–æ–∫–∏ 47-52) |
| [Bypass/BypassStateManager.Udp443ActiveTargets.cs](../Bypass/BypassStateManager.Udp443ActiveTargets.cs#L58) | Active hosts TTL | `foreach` –Ω–∞ `ConcurrentDictionary` –ø–æ–¥ `lock` ‚Äî –±–µ–∑–æ–ø–∞—Å–Ω–æ |
| [Bypass/BypassStateManager.ObservedIpCache.cs](../Bypass/BypassStateManager.ObservedIpCache.cs#L143) | Observed IPs | `foreach` –Ω–∞ `Dictionary.Keys` –ø–æ–¥ `lock` ‚Äî –±–µ–∑–æ–ø–∞—Å–Ω–æ |

#### üî¥ –ù–∞–π–¥–µ–Ω–Ω—ã–µ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:

**1. BypassFilter.ProbeFlows.cs:47-52** ‚Äî foreach + TryRemove:
```csharp
// –°—Ç—Ä–æ–∫–∏ 47-52: –ª–µ–Ω–∏–≤–∞—è —á–∏—Å—Ç–∫–∞ –≤–æ –≤—Ä–µ–º—è –∏—Ç–µ—Ä–∞—Ü–∏–∏
foreach (var kv in _probeFlowsUntilTick)  // ConcurrentDictionary
{
    if (now > kv.Value)
    {
        _probeFlowsUntilTick.TryRemove(kv.Key, out _);  // ‚ö†Ô∏è –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è –≤–æ –≤—Ä–µ–º—è –∏—Ç–µ—Ä–∞—Ü–∏–∏
    }
}
```
**–†–µ—à–µ–Ω–∏–µ:** –°–æ–±–∏—Ä–∞—Ç—å –∫–ª—é—á–∏ –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫, –∑–∞—Ç–µ–º —É–¥–∞–ª—è—Ç—å.

**2. TrafficEngine.cs:203-218** ‚Äî foreach –ø–æ–¥ lock:
```csharp
lock (_filters)
{
    foreach (var filter in _filters)  // List<IPacketFilter>
    {
        // Process...
    }
}
```
**–°—Ç–∞—Ç—É—Å:** –ë–µ–∑–æ–ø–∞—Å–Ω–æ (lock –∑–∞—â–∏—â–∞–µ—Ç), –Ω–æ –º–æ–∂–µ—Ç –±—ã—Ç—å contention –ø—Ä–∏ —á–∞—Å—Ç–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤.

### P0.2: Apply timeout ‚Äî –∫–ª—é—á–µ–≤—ã–µ —Ñ–∞–π–ª—ã

| –§–∞–π–ª | –†–æ–ª—å | –ß—Ç–æ –¥–æ–±–∞–≤–∏—Ç—å |
|------|------|--------------|
| [Bypass/TlsBypassService.Engine.cs](../Bypass/TlsBypassService.Engine.cs#L27) | `ApplyAsync` entry point | –î–æ–±–∞–≤–∏—Ç—å —Ñ–∞–∑–æ–≤–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ |
| [Bypass/TlsBypassService.Engine.cs](../Bypass/TlsBypassService.Engine.cs#L76) | `ApplyInternalAsync` | –§–∞–∑—ã: RemoveFilter ‚Üí Options ‚Üí CreateFilter ‚Üí RegisterFilter |
| [Bypass/BypassStateManager.cs](../Bypass/BypassStateManager.cs#L601) | Manager Apply | –û–±—ë—Ä—Ç–∫–∞ Apply —Å gate –∏ scope |
| [Core/Traffic/TrafficEngine.cs](../Core/Traffic/TrafficEngine.cs#L57) | `RegisterFilter` | –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–µ –º–µ—Å—Ç–æ –∑–∞–≤–∏—Å–∞–Ω–∏—è |
| [Core/Traffic/TrafficEngine.cs](../Core/Traffic/TrafficEngine.cs#L113) | `StopAsync` | –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–µ –º–µ—Å—Ç–æ –∑–∞–≤–∏—Å–∞–Ω–∏—è (–æ–∂–∏–¥–∞–Ω–∏–µ loopTask) |

#### –¢–µ–∫—É—â–∏–π flow Apply:
```
BypassStateManager.ApplyTlsAsync()
  ‚îî‚îÄ _applyGate.WaitAsync()           // –°–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è
  ‚îî‚îÄ BypassStateManagerGuard.EnterScope()
  ‚îî‚îÄ _tlsService.SetUdp443DropTargetIpsForManager()
  ‚îî‚îÄ _tlsService.SetDecisionGraphSnapshotForManager()
  ‚îî‚îÄ _tlsService.ApplyAsync()
       ‚îî‚îÄ TlsBypassService.ApplyInternalAsync()
            ‚îî‚îÄ _trafficEngine.RemoveFilter("BypassFilter")  // ‚ö†Ô∏è –ú–æ–∂–µ—Ç –∑–∞–≤–∏—Å–∞—Ç—å
            ‚îî‚îÄ new BypassFilter(...)
            ‚îî‚îÄ _trafficEngine.RegisterFilter(filter)
            ‚îî‚îÄ _trafficEngine.StartAsync()                  // ‚ö†Ô∏è –ú–æ–∂–µ—Ç –∑–∞–≤–∏—Å–∞—Ç—å
```

### P1.2: –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –¥–æ–º–µ–Ω–æ–≤ ‚Äî –∫–ª—é—á–µ–≤—ã–µ —Ñ–∞–π–ª—ã

| –§–∞–π–ª | –†–æ–ª—å | –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ |
|------|------|-------------------|
| [Core/Bypass/GroupBypassAttachmentStore.cs](../Core/Bypass/GroupBypassAttachmentStore.cs) | –•—Ä–∞–Ω–∏–ª–∏—â–µ –≥—Ä—É–ø–ø | ‚úÖ –£–ñ–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–û ‚Äî persistence –≤ `group_participation.json` |
| [ViewModels/TestResultsManager.cs](../ViewModels/TestResultsManager.cs) | –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤ | GroupKey —É–∂–µ –µ—Å—Ç—å |
| [MainWindow.xaml](../MainWindow.xaml) | UI —Ç–∞–±–ª–∏—Ü–∞ | –ö–æ–ª–æ–Ω–∫–∞ GroupKey —É–∂–µ –µ—Å—Ç—å |

### P1.3: Visibility UDP/443 ‚Äî –∫–ª—é—á–µ–≤—ã–µ —Ñ–∞–π–ª—ã

| –§–∞–π–ª | –†–æ–ª—å | –ß—Ç–æ –ø–æ–∫–∞–∑–∞—Ç—å –≤ UI |
|------|------|-------------------|
| [Core/Traffic/Filters/BypassFilter.Udp443.cs](../Core/Traffic/Filters/BypassFilter.Udp443.cs) | Drop –ª–æ–≥–∏–∫–∞ | `_udp443DropTargetDstIps` ‚Äî —Å–ø–∏—Å–æ–∫ IP |
| [Core/Traffic/Filters/BypassFilter.Metrics.cs](../Core/Traffic/Filters/BypassFilter.Metrics.cs) | –ú–µ—Ç—Ä–∏–∫–∏ | `_udp443Dropped` ‚Äî —Å—á—ë—Ç—á–∏–∫ –¥—Ä–æ–ø–æ–≤ |
| [Bypass/TlsBypassService.Udp443.cs](../Bypass/TlsBypassService.Udp443.cs#L47) | API –¥–ª—è IP | `SetUdp443DropTargetIpsForManager()` |
| [Bypass/BypassStateManager.ObservedIpCache.cs](../Bypass/BypassStateManager.ObservedIpCache.cs) | Observed IPs | `GetObservedIpv4TargetsSnapshotForHost()` |

### Policy-Driven ‚Äî —É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

| –§–∞–π–ª | –°—Ç–∞—Ç—É—Å | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|--------|----------|
| [Core/Models/FlowPolicy.cs](../Core/Models/FlowPolicy.cs) | ‚úÖ –ì–æ—Ç–æ–≤–æ | –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–æ–ª–∏—Ç–∏–∫–∏ |
| [Core/Models/DecisionGraphSnapshot.cs](../Core/Models/DecisionGraphSnapshot.cs) | ‚úÖ –ì–æ—Ç–æ–≤–æ | Snapshot –¥–ª—è lookup |
| [Core/Models/PolicySetCompiler.cs](../Core/Models/PolicySetCompiler.cs) | ‚úÖ –ì–æ—Ç–æ–≤–æ | –ö–æ–º–ø–∏–ª—è—Ç–æ—Ä –ø–æ–ª–∏—Ç–∏–∫ |
| [Core/Traffic/Filters/BypassFilter.Udp443.cs](../Core/Traffic/Filters/BypassFilter.Udp443.cs#L81) | ‚úÖ –ì–æ—Ç–æ–≤–æ | Policy-driven –ø—É—Ç—å –¥–ª—è UDP/443 |
| [Core/Traffic/Filters/BypassFilter.TlsStrategies.cs](../Core/Traffic/Filters/BypassFilter.TlsStrategies.cs#L75) | ‚úÖ –ì–æ—Ç–æ–≤–æ | Policy-driven –¥–ª—è TLS —Å—Ç—Ä–∞—Ç–µ–≥–∏–π |
| [Bypass/BypassStateManager.cs](../Bypass/BypassStateManager.cs#L550) | ‚úÖ –ì–æ—Ç–æ–≤–æ | –°–±–æ—Ä–∫–∞ DecisionGraph –ø—Ä–∏ Apply |

### üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô (–ë–ª–æ–∫–∏—Ä—É–µ—Ç —Ä–∞–±–æ—Ç—É, P0)

| ID | –ó–∞–¥–∞—á–∞ | –ö–ª—é—á–µ–≤—ã–µ —Ñ–∞–π–ª—ã | –í—Ä–µ–º—è | –°—Ç–∞—Ç—É—Å |
|----|--------|----------------|-------|--------|
| **P0.1** | TrafficEngine crash | [TrafficEngine.cs#L268](../Core/Traffic/TrafficEngine.cs), [BypassFilter.ProbeFlows.cs#L47](../Core/Traffic/Filters/BypassFilter.ProbeFlows.cs) | 5 –¥–Ω–µ–π | ‚¨ú –ù–µ –Ω–∞—á–∞—Ç–æ |
| **P0.2** | Apply timeout | [TlsBypassService.Engine.cs#L76](../Bypass/TlsBypassService.Engine.cs), [TrafficEngine.cs#L113](../Core/Traffic/TrafficEngine.cs) | 5-8 –¥–Ω–µ–π | ‚¨ú –ù–µ –Ω–∞—á–∞—Ç–æ |
| **P0.3** | Stack trace | –í—Å–µ try-catch –±–ª–æ–∫–∏, global handler | 2-3 –¥–Ω—è | ‚¨ú –ù–µ –Ω–∞—á–∞—Ç–æ |

**–ò—Ç–æ–≥–æ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô: ~12-16 –¥–Ω–µ–π (2 –Ω–µ–¥–µ–ª–∏)**

---

### üü† –í–´–°–û–ö–ò–ô (–°–µ—Ä—å—ë–∑–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã UX, P1)

| ID | –ó–∞–¥–∞—á–∞ | –ö–ª—é—á–µ–≤—ã–µ —Ñ–∞–π–ª—ã | –í—Ä–µ–º—è | –°—Ç–∞—Ç—É—Å |
|----|--------|----------------|-------|--------|
| **P1.1** | Deduplicate Apply | [BypassStateManager.cs](../Bypass/BypassStateManager.cs), [BypassApplyTransactionJournal.cs](../Bypass/BypassApplyTransactionJournal.cs) | 3-4 –¥–Ω—è | ‚¨ú –ù–µ –Ω–∞—á–∞—Ç–æ |
| **P1.2** | –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ UI | [GroupBypassAttachmentStore.cs](../Core/Bypass/GroupBypassAttachmentStore.cs) ‚Äî **–£–ñ–ï –ï–°–¢–¨** | 3-4 –¥–Ω—è | üü° –ß–∞—Å—Ç–∏—á–Ω–æ |
| **P1.2+** | –ê–≤—Ç–æ-–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ | TestResultsManager + —ç–≤—Ä–∏—Å—Ç–∏–∫–∏ | 5-7 –¥–Ω–µ–π | ‚¨ú –ù–µ –Ω–∞—á–∞—Ç–æ |
| **P1.3** | Visibility UDP/443 | [BypassFilter.Udp443.cs](../Core/Traffic/Filters/BypassFilter.Udp443.cs), [BypassFilter.Metrics.cs](../Core/Traffic/Filters/BypassFilter.Metrics.cs) | 4-5 –¥–Ω–µ–π | ‚¨ú –ù–µ –Ω–∞—á–∞—Ç–æ |
| **P1.4** | Post-crash –¥–∏–∞–≥–Ω–æ–∑—ã | DiagnosticOrchestrator + UI | 2-3 –¥–Ω—è | ‚¨ú –ù–µ –Ω–∞—á–∞—Ç–æ |

**–ò—Ç–æ–≥–æ –í–´–°–û–ö–ò–ô: ~17-23 –¥–Ω—è (3-4 –Ω–µ–¥–µ–ª–∏)**

---

### üü° –°–†–ï–î–ù–ò–ô (UX —É–ª—É—á—à–µ–Ω–∏—è, P2)

| ID | –ó–∞–¥–∞—á–∞ | –ö–ª—é—á–µ–≤—ã–µ —Ñ–∞–π–ª—ã | –í—Ä–µ–º—è | –°—Ç–∞—Ç—É—Å |
|----|--------|----------------|-------|--------|
| **P2.1** | AutoRetest debounce | [DiagnosticOrchestrator.cs](../ViewModels/DiagnosticOrchestrator.cs) | 2-3 –¥–Ω—è | ‚¨ú –ù–µ –Ω–∞—á–∞—Ç–æ |
| **P2.2** | Early noise filter | [NoiseHostFilter](../Utils/NoiseHostFilter.cs), pipeline | 1-2 –¥–Ω—è | ‚¨ú –ù–µ –Ω–∞—á–∞—Ç–æ |
| **P2.3** | Progress indicator | [BypassController.cs](../ViewModels/BypassController.cs), UI | 2-3 –¥–Ω—è | ‚¨ú –ù–µ –Ω–∞—á–∞—Ç–æ |
| **P2.4** | –ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π | [BypassApplyTransactionJournal.cs](../Bypass/BypassApplyTransactionJournal.cs) ‚Äî **–ï–°–¢–¨** | 3-4 –¥–Ω—è | üü° –ß–∞—Å—Ç–∏—á–Ω–æ |

**–ò—Ç–æ–≥–æ –°–†–ï–î–ù–ò–ô: ~8-12 –¥–Ω–µ–π (2 –Ω–µ–¥–µ–ª–∏)**

---

### üü¢ –ù–ò–ó–ö–ò–ô (Observability, P3)

| ID | –ó–∞–¥–∞—á–∞ | –ö–ª—é—á–µ–≤—ã–µ —Ñ–∞–π–ª—ã | –í—Ä–µ–º—è | –°—Ç–∞—Ç—É—Å |
|----|--------|----------------|-------|--------|
| **P3.1** | –ú–µ—Ç—Ä–∏–∫–∏ effectiveness | [TlsBypassService.Metrics.cs](../Bypass/TlsBypassService.Metrics.cs) | 5-7 –¥–Ω–µ–π | ‚¨ú –ù–µ –Ω–∞—á–∞—Ç–æ |
| **P3.2** | –≠–∫—Å–ø–æ—Ä—Ç bug report | [BypassController.ApplyTransactions.cs](../ViewModels/BypassController.ApplyTransactions.cs) ‚Äî **—á–∞—Å—Ç–∏—á–Ω–æ –µ—Å—Ç—å** | 4-5 –¥–Ω–µ–π | üü° –ß–∞—Å—Ç–∏—á–Ω–æ |
| **P3.3** | Dashboard —Å–∏—Å—Ç–µ–º—ã | MainWindow + –Ω–æ–≤–∞—è –ø–∞–Ω–µ–ª—å | 7-10 –¥–Ω–µ–π | ‚¨ú –ù–µ –Ω–∞—á–∞—Ç–æ |

**–ò—Ç–æ–≥–æ –ù–ò–ó–ö–ò–ô: ~16-22 –¥–Ω—è (3-4 –Ω–µ–¥–µ–ª–∏)**

---

### üîµ –°–¢–†–ê–¢–ï–ì–ò–ß–ï–°–ö–ò–ô (Policy-Driven, –§–∞–∑–∞ V) ‚Äî –ß–ê–°–¢–ò–ß–ù–û –†–ï–ê–õ–ò–ó–û–í–ê–ù–û

| –≠—Ç–∞–ø | –ó–∞–¥–∞—á–∞ | –°—Ç–∞—Ç—É—Å | –ß—Ç–æ –æ—Å—Ç–∞–ª–æ—Å—å |
|------|--------|--------|--------------|
| **–≠—Ç–∞–ø 0** | –ö–æ–Ω—Ç—Ä–∞–∫—Ç—ã –∏ –∫–∞—Ä–∫–∞—Å | ‚úÖ **–ì–û–¢–û–í–û** | `FlowPolicy`, `DecisionGraphSnapshot`, `PolicySetCompiler` —É–∂–µ –µ—Å—Ç—å |
| **–≠—Ç–∞–ø 1** | UDP/443 –≤ –ø–æ–ª–∏—Ç–∏–∫–∏ | ‚úÖ **–ì–û–¢–û–í–û** | Policy-driven –ø—É—Ç—å –≤ [BypassFilter.Udp443.cs#L81](../Core/Traffic/Filters/BypassFilter.Udp443.cs) —Ä–∞–±–æ—Ç–∞–µ—Ç |
| **–≠—Ç–∞–ø 2** | TTL –ø–æ–ª–∏—Ç–∏–∫–∏ | ‚¨ú –ù–µ –Ω–∞—á–∞—Ç–æ | –ù—É–∂–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ TTL –≤ FlowPolicy |
| **–≠—Ç–∞–ø 3** | TCP/80 Host tricks | üü° –ß–∞—Å—Ç–∏—á–Ω–æ | –ë–∞–∑–æ–≤–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –µ—Å—Ç—å –≤ [BypassFilter.HttpHostTricks.cs](../Core/Traffic/Filters/BypassFilter.HttpHostTricks.cs) |
| **–≠—Ç–∞–ø 4** | TCP/443 per-domain | üü° –ß–∞—Å—Ç–∏—á–Ω–æ | [BypassFilter.TlsStrategies.cs#L75](../Core/Traffic/Filters/BypassFilter.TlsStrategies.cs) ‚Äî –µ—Å—Ç—å policy-driven –≤—ã–±–æ—Ä |
| **–≠—Ç–∞–ø 5** | Semantic Groups | üü° –ß–∞—Å—Ç–∏—á–Ω–æ | [GroupBypassAttachmentStore.cs](../Core/Bypass/GroupBypassAttachmentStore.cs) ‚Äî backend –µ—Å—Ç—å |
| **–≠—Ç–∞–ø 6** | Observability UI | ‚¨ú –ù–µ –Ω–∞—á–∞—Ç–æ | UI —Ç–∞–±–ª–∏—Ü–∞ –ø–æ–ª–∏—Ç–∏–∫ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ |

**‚ö†Ô∏è –í–ê–ñ–ù–û:** –ü–ª–∞–Ω plan3.md –æ–ø–∏—Å—ã–≤–∞–µ—Ç Policy-Driven –∫–∞–∫ –±—É–¥—É—â—É—é —Ä–∞–±–æ—Ç—É, –Ω–æ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–∞—è —á–∞—Å—Ç—å –£–ñ–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–ê –≤ –ø—Ä–æ–µ–∫—Ç–µ!

---

## üìã –ê–∫—Ç—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–ª–∞–Ω —Ä–∞–±–æ—Ç

### üèÉ –°–ø—Ä–∏–Ω—Ç 1 (–ù–µ–¥–µ–ª—è 1): –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –°–¢–ê–ë–ò–õ–ò–ó–ê–¶–ò–Ø

```
–§–æ–∫—É—Å: –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ crash TrafficEngine
```

#### –î–µ–Ω—å 1: –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è

| –ó–∞–¥–∞—á–∞ | –§–∞–π–ª | –û–ø–∏—Å–∞–Ω–∏–µ |
|--------|------|----------|
| –ê–Ω–∞–ª–∏–∑ –ª–æ–≥–æ–≤ | artifacts/*.log.txt | –ù–∞–π—Ç–∏ ¬±100 —Å—Ç—Ä–æ–∫ –≤–æ–∫—Ä—É–≥ crash |
| Stack trace | [TrafficEngine.cs#L268](../Core/Traffic/TrafficEngine.cs) | –î–æ–±–∞–≤–∏—Ç—å `ex.ToString()` –≤–º–µ—Å—Ç–æ `ex.Message` |
| –ö–∞—Ä—Ç–∞ –∫–æ–ª–ª–µ–∫—Ü–∏–π | –°–º. –Ω–∏–∂–µ | –°–æ—Å—Ç–∞–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∫–æ–ª–ª–µ–∫—Ü–∏–π –≤ hot path |

**–ü–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º—ã–µ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ (–∏–∑ –∞–Ω–∞–ª–∏–∑–∞ –∫–æ–¥–∞):**

| –ö–æ–ª–ª–µ–∫—Ü–∏—è | –§–∞–π–ª | –¢–∏–ø | –ó–∞—â–∏—Ç–∞ | –†–∏—Å–∫ |
|-----------|------|-----|--------|------|
| `_filters` | [TrafficEngine.cs#L13](../Core/Traffic/TrafficEngine.cs) | `List<IPacketFilter>` | `lock(_filters)` | üü¢ –ù–∏–∑–∫–∏–π |
| `_probeFlowsUntilTick` | [BypassFilter.ProbeFlows.cs#L11](../Core/Traffic/Filters/BypassFilter.ProbeFlows.cs) | `ConcurrentDictionary` | –ù–µ—Ç | üî¥ **–í–´–°–û–ö–ò–ô** |
| `_connections` | [BypassFilter.TlsStrategies.cs#L15](../Core/Traffic/Filters/BypassFilter.TlsStrategies.cs) | `ConcurrentDictionary` | –ù–µ—Ç | üü¢ –ù–∏–∑–∫–∏–π (thread-safe API) |
| `_udp443ActiveHostsUntilTick` | [BypassStateManager.Udp443ActiveTargets.cs#L18](../Bypass/BypassStateManager.Udp443ActiveTargets.cs) | `ConcurrentDictionary` | `lock` | üü¢ –ù–∏–∑–∫–∏–π |
| `entry.UntilTickByIp` | [BypassStateManager.ObservedIpCache.cs#L23](../Bypass/BypassStateManager.ObservedIpCache.cs) | `Dictionary` | `lock(entry.Sync)` | üü¢ –ù–∏–∑–∫–∏–π |

#### üî¥ –ì–ª–∞–≤–Ω—ã–π –ø–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º—ã–π: `_probeFlowsUntilTick`

**–ü—Ä–æ–±–ª–µ–º–Ω—ã–π –∫–æ–¥** ([BypassFilter.ProbeFlows.cs#L45-52](../Core/Traffic/Filters/BypassFilter.ProbeFlows.cs)):
```csharp
// –õ–µ–Ω–∏–≤–∞—è —á–∏—Å—Ç–∫–∞: –µ—Å–ª–∏ —Å–ª–æ–≤–∞—Ä—å —Ä–∞–∑—Ä–æ—Å—Å—è (—Ä–µ–¥–∫–æ), —É–¥–∞–ª—è–µ–º –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏.
if (_probeFlowsUntilTick.Count > 64)
{
    foreach (var kv in _probeFlowsUntilTick)  // ‚ö†Ô∏è –ò—Ç–µ—Ä–∞—Ü–∏—è
    {
        if (now > kv.Value)
        {
            _probeFlowsUntilTick.TryRemove(kv.Key, out _);  // ‚ö†Ô∏è –ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è
        }
    }
}
```

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```csharp
if (_probeFlowsUntilTick.Count > 64)
{
    // –°–æ–±–∏—Ä–∞–µ–º –∫–ª—é—á–∏ –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ
    var toRemove = new List<ConnectionKey>();
    foreach (var kv in _probeFlowsUntilTick)
    {
        if (now > kv.Value)
        {
            toRemove.Add(kv.Key);
        }
    }
    // –£–¥–∞–ª—è–µ–º –ø–æ—Å–ª–µ –∏—Ç–µ—Ä–∞—Ü–∏–∏
    foreach (var key in toRemove)
    {
        _probeFlowsUntilTick.TryRemove(key, out _);
    }
}
```

#### –î–µ–Ω—å 2-3: –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ + Hotfix

| –ó–∞–¥–∞—á–∞ | –û–ø–∏—Å–∞–Ω–∏–µ |
|--------|----------|
| Regression test | –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç: rapid apply/retest –≤–æ –≤—Ä–µ–º—è –∞–∫—Ç–∏–≤–Ω–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ |
| Hotfix | –ò—Å–ø—Ä–∞–≤–∏—Ç—å foreach+TryRemove –≤ ProbeFlows.cs |
| –ê—É–¥–∏—Ç | –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –≤ –ø—Ä–æ–µ–∫—Ç–µ |

#### –î–µ–Ω—å 4-5: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ + –†–µ–ª–∏–∑

| –ó–∞–¥–∞—á–∞ | –û–ø–∏—Å–∞–Ω–∏–µ |
|--------|----------|
| Stress test | 1000 –æ–ø–µ—Ä–∞—Ü–∏–π Apply/Rollback –∑–∞ –º–∏–Ω—É—Ç—É |
| Performance | –°—Ä–∞–≤–Ω–∏—Ç—å latency —Å baseline |
| Workaround | Debounce –Ω–∞ –±—ã—Å—Ç—Ä—ã–µ Apply –≤–æ –≤—Ä–µ–º—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ |

---

### üèÉ –°–ø—Ä–∏–Ω—Ç 2 (–ù–µ–¥–µ–ª—è 2): APPLY TIMEOUT + STACK TRACE

```
–§–æ–∫—É—Å: –ü–æ–ª–Ω–∞—è observability –¥–ª—è debug Apply
```

#### P0.2: –§–∞–∑–æ–≤–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ Apply

**–¢–µ–∫—É—â–∏–π –∫–æ–¥** ([TlsBypassService.Engine.cs#L76](../Bypass/TlsBypassService.Engine.cs)):
```csharp
private async Task ApplyInternalAsync(CancellationToken cancellationToken)
{
    // –§–∞–∑—ã –Ω–µ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è!
    _trafficEngine.RemoveFilter("BypassFilter");
    // ...
    _trafficEngine.RegisterFilter(filter);
    await _trafficEngine.StartAsync(cancellationToken);
}
```

**–ß—Ç–æ –¥–æ–±–∞–≤–∏—Ç—å:**
```csharp
private async Task ApplyInternalAsync(CancellationToken cancellationToken)
{
    var sw = Stopwatch.StartNew();
    _log?.Invoke("[Apply] Phase 1: Preparing config...");
    
    _log?.Invoke($"[Apply] Phase 2: Removing old filter... ({sw.ElapsedMilliseconds}ms)");
    _trafficEngine.RemoveFilter("BypassFilter");
    
    _log?.Invoke($"[Apply] Phase 3: Creating new filter... ({sw.ElapsedMilliseconds}ms)");
    // ...
    
    _log?.Invoke($"[Apply] Phase 4: Registering filter... ({sw.ElapsedMilliseconds}ms)");
    _trafficEngine.RegisterFilter(filter);
    
    _log?.Invoke($"[Apply] Phase 5: Starting engine... ({sw.ElapsedMilliseconds}ms)");
    await _trafficEngine.StartAsync(cancellationToken);
    
    _log?.Invoke($"[Apply] Complete: {sw.ElapsedMilliseconds}ms total");
}
```

#### P0.3: Global Exception Handler

**–§–∞–π–ª—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è:**
- [App.xaml.cs](../App.xaml.cs) ‚Äî `AppDomain.CurrentDomain.UnhandledException`
- [Program.cs](../Program.cs) ‚Äî `TaskScheduler.UnobservedTaskException`

---

### üèÉ –°–ø—Ä–∏–Ω—Ç 3 (–ù–µ–¥–µ–ª—è 3): –í–´–°–û–ö–û–ü–†–ò–û–†–ò–¢–ï–¢–ù–´–ï –£–õ–£–ß–®–ï–ù–ò–Ø

```
–§–æ–∫—É—Å: Deduplicate + UDP visibility (–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –£–ñ–ï –µ—Å—Ç—å)
```

#### P1.1: Deduplicate Apply

**–¢–µ–∫—É—â–∞—è –ø—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ IP –¥–ª—è googlevideo.com –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ–ª–Ω—ã–π Apply.

**–†–µ—à–µ–Ω–∏–µ –≤** [BypassStateManager.cs](../Bypass/BypassStateManager.cs):
```csharp
public async Task ApplyTlsAsync(...)
{
    // –ü—Ä–æ–≤–µ—Ä–∫–∞: –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å –ª–∏ effective config?
    var currentEffective = GetCurrentEffectiveConfig();
    if (currentEffective.Equals(newEffective))
    {
        _log?.Invoke("[Bypass] Skip Apply: config unchanged");
        return;
    }
    // ...
}
```

#### P1.2: –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ ‚Äî –£–ñ–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–û

**–§–∞–π–ª—ã:**
- [GroupBypassAttachmentStore.cs](../Core/Bypass/GroupBypassAttachmentStore.cs) ‚Äî backend —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
- [MainWindow.xaml](../MainWindow.xaml) ‚Äî –∫–æ–ª–æ–Ω–∫–∞ GroupKey —É–∂–µ –µ—Å—Ç—å
- `group_participation.json` ‚Äî persistence

**–ß—Ç–æ –æ—Å—Ç–∞–ª–æ—Å—å:** UI collapsible —Å–µ–∫—Ü–∏–∏ (–≤–∏–∑—É–∞–ª—å–Ω–∞—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞).

#### P1.3: Visibility UDP/443

**API —É–∂–µ –µ—Å—Ç—å:**
- `TlsBypassService.GetUdp443DropTargetIpsSnapshot()` ‚Äî —Å–ø–∏—Å–æ–∫ IP
- `BypassFilter._udp443Dropped` ‚Äî —Å—á—ë—Ç—á–∏–∫

**–ß—Ç–æ –¥–æ–±–∞–≤–∏—Ç—å –≤ UI** ([MainWindow.xaml](../MainWindow.xaml)):
```xml
<Expander Header="–ê–∫—Ç–∏–≤–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è UDP/443">
    <ItemsControl ItemsSource="{Binding Udp443BlockedIps}">
        <ItemsControl.ItemTemplate>
            <DataTemplate>
                <TextBlock Text="{Binding}" />
            </DataTemplate>
        </ItemsControl.ItemTemplate>
    </ItemsControl>
    <TextBlock Text="{Binding Udp443DroppedCount, StringFormat='–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ –ø–∞–∫–µ—Ç–æ–≤: {0}'}" />
</Expander>
```

---

### üèÉ –°–ø—Ä–∏–Ω—Ç 4-8: –û–°–¢–ê–í–®–ò–ï–°–Ø –ó–ê–î–ê–ß–ò

| –ù–µ–¥–µ–ª—è | –ó–∞–¥–∞—á–∏ | –§–∞–π–ª—ã |
|--------|--------|-------|
| 4 | P1.4 Post-crash + P2.1 Debounce | DiagnosticOrchestrator.cs |
| 5 | P2.3 Progress + P2.4 –ò—Å—Ç–æ—Ä–∏—è | BypassController.cs, UI |
| 6 | P3.1 –ú–µ—Ç—Ä–∏–∫–∏ effectiveness | TlsBypassService.Metrics.cs |
| 7 | P3.2 –≠–∫—Å–ø–æ—Ä—Ç | BypassController.ApplyTransactions.cs ‚Äî **—á–∞—Å—Ç–∏—á–Ω–æ –µ—Å—Ç—å** |
| 8 | P3.3 Dashboard | –ù–æ–≤–∞—è –ø–∞–Ω–µ–ª—å –≤ MainWindow |

---

### üèÉ Policy-Driven: –ê–ö–¢–£–ê–õ–¨–ù–´–ô –°–¢–ê–¢–£–°

**‚ö†Ô∏è –ü–ª–∞–Ω plan3.md —É—Å—Ç–∞—Ä–µ–ª –≤ —á–∞—Å—Ç–∏ Policy-Driven ‚Äî –±–æ–ª—å—à–∞—è —á–∞—Å—Ç—å —É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞!**

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –°—Ç–∞—Ç—É—Å | –§–∞–π–ª |
|-----------|--------|------|
| `FlowPolicy` | ‚úÖ | [Core/Models/FlowPolicy.cs](../Core/Models/FlowPolicy.cs) |
| `DecisionGraphSnapshot` | ‚úÖ | [Core/Models/DecisionGraphSnapshot.cs](../Core/Models/DecisionGraphSnapshot.cs) |
| `PolicySetCompiler` | ‚úÖ | [Core/Models/PolicySetCompiler.cs](../Core/Models/PolicySetCompiler.cs) |
| UDP/443 policy-driven | ‚úÖ | [BypassFilter.Udp443.cs#L81](../Core/Traffic/Filters/BypassFilter.Udp443.cs) |
| TLS strategy policy-driven | ‚úÖ | [BypassFilter.TlsStrategies.cs#L75](../Core/Traffic/Filters/BypassFilter.TlsStrategies.cs) |
| Policy metrics | ‚úÖ | [BypassFilter.PolicyMetrics.cs](../Core/Traffic/Filters/BypassFilter.PolicyMetrics.cs) |
| Feature gates | ‚úÖ | `PolicyDrivenExecutionGates` |
| SemanticGroups backend | üü° | [GroupBypassAttachmentStore.cs](../Core/Bypass/GroupBypassAttachmentStore.cs) |
| TTL policies | ‚¨ú | –ù—É–∂–Ω–∞ –¥–æ—Ä–∞–±–æ—Ç–∫–∞ FlowPolicy |
| Observability UI | ‚¨ú | –ù—É–∂–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ –ø–æ–ª–∏—Ç–∏–∫ –≤ UI |

**–ß—Ç–æ —Ä–µ–∞–ª—å–Ω–æ –æ—Å—Ç–∞–ª–æ—Å—å –ø–æ Policy-Driven:**
1. TTL –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –≤ FlowPolicy (1 –Ω–µ–¥–µ–ª—è)
2. UI —Ç–∞–±–ª–∏—Ü–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª–∏—Ç–∏–∫ (1 –Ω–µ–¥–µ–ª—è)
3. –≠–∫—Å–ø–æ—Ä—Ç policy snapshot (—É–∂–µ —á–∞—Å—Ç–∏—á–Ω–æ –µ—Å—Ç—å –≤ ApplyTransactions)

---

## ‚öñÔ∏è –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏–∏ (—Å —É—á—ë—Ç–æ–º —Ä–µ–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è)

### ‚úÖ –ù–ï–ú–ï–î–õ–ï–ù–ù–û (–ù–µ–¥–µ–ª—è 1):

| –ó–∞–¥–∞—á–∞ | –§–∞–π–ª | –°–ª–æ–∂–Ω–æ—Å—Ç—å |
|--------|------|-----------|
| **P0.1 Hotfix crash** | [BypassFilter.ProbeFlows.cs#L45-52](../Core/Traffic/Filters/BypassFilter.ProbeFlows.cs) | üü¢ –ù–∏–∑–∫–∞—è |
| Stack trace –≤ Loop | [TrafficEngine.cs#L268](../Core/Traffic/TrafficEngine.cs) | üü¢ –ù–∏–∑–∫–∞—è |
| –ê—É–¥–∏—Ç foreach+modify | –í—Å–µ ConcurrentDictionary | üü° –°—Ä–µ–¥–Ω—è—è |

### ‚úÖ –ü–†–ò–û–†–ò–¢–ï–¢ (–ù–µ–¥–µ–ª–∏ 2-3):

| –ó–∞–¥–∞—á–∞ | –§–∞–π–ª | –°–ª–æ–∂–Ω–æ—Å—Ç—å |
|--------|------|-----------|
| **P0.2 –§–∞–∑–æ–≤–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** | [TlsBypassService.Engine.cs#L76](../Bypass/TlsBypassService.Engine.cs) | üü¢ –ù–∏–∑–∫–∞—è |
| **P1.3 UDP visibility** | UI + `GetUdp443DropTargetIpsSnapshot()` | üü° –°—Ä–µ–¥–Ω—è—è |
| **P1.1 Deduplicate Apply** | [BypassStateManager.cs](../Bypass/BypassStateManager.cs) | üü° –°—Ä–µ–¥–Ω—è—è |

### ‚è∏Ô∏è –£–ñ–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–û (–Ω–µ —Ç—Ä–µ–±—É–µ—Ç —Ä–∞–±–æ—Ç—ã):

| –ó–∞–¥–∞—á–∞ –∏–∑ plan3.md | –§–∞–π–ª | –°—Ç–∞—Ç—É—Å |
|--------------------|------|--------|
| Policy-Driven –≠—Ç–∞–ø 0-1 | FlowPolicy, DecisionGraph | ‚úÖ –ì–æ—Ç–æ–≤–æ |
| –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ backend | GroupBypassAttachmentStore | ‚úÖ –ì–æ—Ç–æ–≤–æ |
| –ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π backend | BypassApplyTransactionJournal | ‚úÖ –ì–æ—Ç–æ–≤–æ |
| –°–µ–ª–µ–∫—Ç–∏–≤–Ω—ã–π UDP/443 | BypassFilter.Udp443.cs | ‚úÖ –ì–æ—Ç–æ–≤–æ |

### üö´ –£—Å—Ç–∞—Ä–µ–≤—à–∏–µ –ø—É–Ω–∫—Ç—ã plan3.md:

- **–≠—Ç–∞–ø 0 (–ö–æ–Ω—Ç—Ä–∞–∫—Ç—ã)** ‚Äî —É–∂–µ –µ—Å—Ç—å `FlowPolicy`, `DecisionGraphSnapshot`
- **–≠—Ç–∞–ø 1 (UDP/443)** ‚Äî —É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω policy-driven –ø—É—Ç—å
- **–≠—Ç–∞–ø 4-6** ‚Äî —á–∞—Å—Ç–∏—á–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã, –Ω—É–∂–Ω–∞ —Ç–æ–ª—å–∫–æ UI —á–∞—Å—Ç—å

---

## üìà –°–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π Timeline

```
–ë–´–õ–û (plan3.md):    20 –Ω–µ–¥–µ–ª—å
–ê–ö–¢–£–ê–õ–¨–ù–û:          8-10 –Ω–µ–¥–µ–ª—å (—Å —É—á—ë—Ç–æ–º —É–∂–µ —Å–¥–µ–ª–∞–Ω–Ω–æ–≥–æ)

–†–µ–∞–ª—å–Ω—ã–π scope:
- P0.1-P0.3 (crash + logging): 2 –Ω–µ–¥–µ–ª–∏
- P1.1-P1.4 (UX):              2-3 –Ω–µ–¥–µ–ª–∏
- P2.1-P2.4 (polish):          2 –Ω–µ–¥–µ–ª–∏
- P3.1-P3.3 (observability):   2-3 –Ω–µ–¥–µ–ª–∏
- Policy-Driven –æ—Å—Ç–∞—Ç–æ–∫:       1-2 –Ω–µ–¥–µ–ª–∏ (TTL + UI)
```

---

## üéØ –ù–µ–º–µ–¥–ª–µ–Ω–Ω—ã–π —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ crash `_probeFlowsUntilTick`

**–§–∞–π–ª:** [Core/Traffic/Filters/BypassFilter.ProbeFlows.cs](../Core/Traffic/Filters/BypassFilter.ProbeFlows.cs)

**–¢–µ–∫—É—â–∏–π –ø—Ä–æ–±–ª–µ–º–Ω—ã–π –∫–æ–¥ (—Å—Ç—Ä–æ–∫–∏ 45-52):**
```csharp
if (_probeFlowsUntilTick.Count > 64)
{
    foreach (var kv in _probeFlowsUntilTick)
    {
        if (now > kv.Value)
        {
            _probeFlowsUntilTick.TryRemove(kv.Key, out _);
        }
    }
}
```

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```csharp
if (_probeFlowsUntilTick.Count > 64)
{
    var toRemove = new List<ConnectionKey>();
    foreach (var kv in _probeFlowsUntilTick)
    {
        if (now > kv.Value)
        {
            toRemove.Add(kv.Key);
        }
    }
    foreach (var key in toRemove)
    {
        _probeFlowsUntilTick.TryRemove(key, out _);
    }
}
```

**–ì–æ—Ç–æ–≤ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ?**
