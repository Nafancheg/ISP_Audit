# Chat Log — 2026-01-16 — P0.2 Stage 4 (DPI2-044) + обсуждение Stage 5/P0.1

Дата: 16.01.2026

Контекст проекта: Windows-native .NET 9 WPF приложение ISP_Audit (диагностика блокировок + обход через WinDivert). Работа велась по workflow: feature gate (default off) → `dotnet build` → строгий smoke (elevated, `--no-skip`) → отдельный commit/push → обновление доков.

---

## Запрос

Пользователь попросил продолжить **P0.2 Stage 4**: policy-driven выбор TLS-стратегии на TCP/443 ClientHello (per-endpoint/per-domain) с fallback на legacy логику.

---

## Что было сделано (Stage 4)

Ключевая функциональность Stage 4:
- Добавлен новый feature gate: `ISP_AUDIT_POLICY_DRIVEN_TCP443` (по умолчанию выключен).
- Расширен policy-driven слой (Action/Match/Evaluate) для поддержки стратегии TLS bypass на TCP/443.
- В hot path `BypassFilter` добавлен выбор **effective** TLS стратегии через `DecisionGraphSnapshot`, с fallback на legacy `BypassProfile.TlsStrategy`.
- Добавлены per-policy метрики применений (счётчик инкрементится при применении выбранного policy-id).
- Добавлен smoke-тест `DPI2-044` и регистрация в реестре smoke.
- Обновлён smoke plan.

---

## Инцидент: падение strict smoke и исправление

Первый прогон строгого smoke (elevated) завершился с:
- PASS: 127
- FAIL: 1
- SKIP: 0

Падающий тест:
- `DPI2-044 TCP/443 TLS strategy: policy-driven выбор стратегии (per-endpoint) + fallback`
- Симптом: для `ipA` ожидали 2 отправки (Fragment), получали 1 (fallback на Fake).

Причина:
- В runtime-выборе стратегии при отсутствии SNI использовался `TlsStage.NoSni`, а в smoke-политиках был задан `TlsStage.ClientHello`. В итоге policy не матчилось и срабатывал legacy fallback.

Фикс:
- Добавлен fallback в выборе стадии: `NoSni → ClientHello`, если политика по `NoSni` не нашлась.

Повторный прогон strict smoke:
- PASS: 128
- FAIL: 0
- SKIP: 0

Артефакты строгого smoke после фикса:
- `artifacts/smoke_strict_20260116_163141.json`
- `artifacts/smoke_strict_20260116_163141.log.txt`

---

## Документация и Git

Документация обновлялась для отражения Stage 4:
- Добавлен статус P0.2 Stage 4 в архитектуре.
- Обновлён Roadmap (full repo audit).
- В `docs/TODO.md` Stage 3 и Stage 4 отмечены как выполненные.

Коммиты:
- Stage 3 ранее завершён: `4210af7`
- Stage 4 завершён и запушен: `e53b642` — "P0.2 Stage 4: policy-driven TCP/443 TLS strategy (DPI2-044)"

---

## Обсуждение Stage 5 и P0.1

В P0.2 Stage 5 есть подзадача 5.4: интеграция с P0.1 (Accumulative Attachment Model).

Вывод:
- Stage 5 можно выполнять без «факапа», если разнести работы:
  - **5.1–5.3** (Semantic Groups + статусы `ENABLED/PARTIAL/NO_TRAFFIC`) делать как MVP без транзакций.
  - **5.4** явно считать зависимой от P0.1 и выполнять позже.

Рекомендация:
- Зафиксировать в доках и критериях gate `DPI2-045`, что он проверяет только 5.1–5.3 (без обязательной реализации P0.1).

---

## Как переносить историю на другой ПК

Самый надёжный способ — хранить такой лог в репозитории (этот файл) и подтягивать через `git pull` на другом ПК.
