# P1.11 — YouTube/Google: эталонный сценарий (baseline)

Цель: получить **воспроизводимую** ручную проверку для кейса «YouTube/Google не грузится/фризит» и быстро понять:
- это QUIC/HTTP3 (UDP/443) vs TCP/TLS,
- помогает ли QUIC→TCP (DropUdp443),
- помогает ли TLS fragmentation,
- корректно ли работает группировка `group-youtube` и якорная цель (`OutcomeTargetHost`).

Важно:
- Сценарий рассчитан на обычного пользователя (GUI). Никаких необратимых системных изменений без явного согласия.
- Пиннед‑группа YouTube по умолчанию задаётся через каталог `state/domain_groups.json` (ключ `group-youtube`).

---

## 0) Шаблон протокола прогона (заполнить)

- Дата/время: 
- Провайдер/регион: 
- ОС: Windows 
- Версия приложения: 
- VPN/Proxy: (выкл/вкл; если вкл — какой)
- Браузер: (Chrome/Edge/Firefox) + версия
- QUIC в браузере: (вкл/выкл)
- QUIC→TCP в приложении: (выкл/селективно/глобально)
- Цель (якорь): (ожидаемо: `youtube.com`)

Артефакты:
- Лог приложения: папка `Logs/` рядом с exe (`isp_audit_vm_*.log`)
- State файлы (если нужно): `state/` рядом с exe
- Скриншоты UI: 1) результаты, 2) панель bypass, 3) карточка группы/домена

---

## 1) Подготовка

1. Закрыть браузер (чтобы не было фонового трафика).
2. (Опционально) Для «чистого» прогона переименовать папку `state/` (например в `state.bak/`).
   - Это сбросит pinned/learned и историю wins/retest.
3. Запустить ISP_Audit.
4. Убедиться, что каталог групп существует:
   - Должен появиться файл `state/domain_groups.json`.
   - Внутри должна быть pinned‑группа `group-youtube` (youtube.com + googlevideo.com + ytimg.com + ggpht.com).

---

## 2) Прогон A — QUIC включён (как в реальности)

### 2.1 Запуск проверки

1. В ISP_Audit нажать «Проверить» (или запуск диагностики из выбранного exe — как обычно).
2. Открыть браузер и перейти на:
   - `https://www.youtube.com/`
3. Попробовать запустить видео (любое короткое) и подождать 20–40 секунд.

### 2.2 Что должно появиться в результатах

Ожидаемое (best-effort):
- Появляются домены семейства YouTube.
- Должна стабильно срабатывать pinned‑группа:
  - агрегированная строка/карточка с UI‑ключом **`group-youtube`**.
- Якорная цель (OutcomeTargetHost) должна быть человеко‑понятной:
  - обычно `youtube.com` (иногда может стать `googlevideo.com`, если первыми пришли CDN‑хосты).

### 2.3 Диагноз по QUIC

Если проблема проявляется только при QUIC:
- В результатах могут быть признаки QUIC/HTTP3 проблем.
- В панели bypass/рекомендациях должен быть понятный путь «QUIC→TCP» (DropUdp443).

Зафиксировать:
- Скрин «до исправления».
- Логи: строки про H3/QUIC и `Udp443Dropped` (если включали).

---

## 3) Прогон B — QUIC выключен (контрольный)

Цель: отличить «блокируется QUIC» от «блокируется TCP/TLS».

Варианты выключения QUIC:
- В браузере: отключить QUIC/HTTP3 (например, через настройки/флаги браузера).
- В приложении: включить тумблер/assist **QUIC→TCP** (селективно по цели, если доступно).

Шаги:
1. Закрыть вкладки YouTube.
2. Выключить QUIC выбранным способом.
3. Повторить действия из прогона A (открыть YouTube, запустить видео).

Ожидаемая интерпретация:
- Если при отключённом QUIC стало стабильно — это сильный сигнал в пользу QUIC‑интерференции.
- Если всё равно не работает — вероятнее DPI/TLS или DNS‑фильтрация, и нужно смотреть TLS fragmentation/DoH/DNS.

---

## 4) Проверка «исправление → пост‑Apply ретест»

Если есть рекомендации/кнопка Apply:
1. Применить исправление для:
   - группы `group-youtube` (предпочтительно), либо
   - якорного домена (OutcomeTargetHost).
2. Дождаться **пост‑Apply ретеста**.

Ожидаемое:
- Post‑Apply ретест должен дать `OK`/`FAIL`/`PARTIAL`/`UNKNOWN` и обновить UI.
- При `OK` и наличии `txId` (корреляция apply) должен появиться «win» (wins‑библиотека).

Примечание для YouTube:
- `OK` в post‑Apply ретесте означает, что outcome-probe успешно получил ожидаемый `204` от `https://www.youtube.com/generate_204` и `https://redirector.googlevideo.com/generate_204`.
- Это более строгий сигнал, чем «успех» на `youtube.com`, который часто даёт обычный редирект `301`.

Зафиксировать:
- Скрин «после исправления».
- Короткая выжимка: что применили (QUIC→TCP? TLS fragment?) и какой вердикт.

---

## 5) Если стало хуже (регресс)

1. Сохранить лог из `Logs/` и JSON‑артефакты из `state/` (если они нужны).
2. Сравнить с предыдущей версией приложения:
   - если действительно хуже — делать `git bisect` до коммита.

---

## 6) Примечания по группам

- `group-youtube` — это **UX‑группа** (агрегация карточек + групповое применение).
- Каталог pinned‑групп хранится в `state/domain_groups.json`.
- Если нужно расширить список доменов (например, новые поддомены), это лучше делать через pinned‑группу, а не хардкодом.
