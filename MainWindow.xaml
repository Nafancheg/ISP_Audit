<Window x:Class="ISPAudit.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:local="clr-namespace:ISPAudit.Controls"
        xmlns:vm="clr-namespace:ISPAudit.ViewModels"
        Title="ISP Audit - Ð”Ð¸Ð°Ð³Ð½Ð¾ÑÑ‚Ð¸ÐºÐ° ÑÐµÑ‚Ð¸"
        Height="800" Width="1400"
        MinHeight="600" MinWidth="1000"
        WindowStartupLocation="Manual"
        Loaded="Window_Loaded"
        Background="{StaticResource BgBrush}"
        FontFamily="Segoe UI"
        TextOptions.TextFormattingMode="Display"
        TextOptions.TextRenderingMode="ClearType">
    
    <Window.DataContext>
        <vm:MainViewModel/>
    </Window.DataContext>

    <Grid Margin="16">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Header: Fix Status Bar (Collapsible) -->
        <Border Grid.Row="0" 
                x:Name="FixStatusBar"
                Background="#FEF3F2" 
                BorderBrush="#FEE2E2"
                BorderThickness="1"
                CornerRadius="8" 
                Padding="12,8"
                Margin="0,0,0,12"
                Visibility="{Binding HasActiveFixes, Converter={StaticResource BoolToVisibilityConverter}}"
                AutomationProperties.AutomationId="FixStatusBar">
            <!-- Ð‘ÑƒÐ´ÐµÑ‚ Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°Ñ‚ÑŒÑÑ Ñ‡ÐµÑ€ÐµÐ· ViewModel ÐºÐ¾Ð³Ð´Ð° ÐµÑÑ‚ÑŒ Ð°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ðµ Ñ„Ð¸ÐºÑÑ‹ -->
            <StackPanel>
                <!-- A3: Bypass Warning -->
                <Border Background="#FEF2F2" BorderBrush="#FECACA" BorderThickness="1" CornerRadius="6" Margin="0,0,0,12" Padding="12,8"
                        Visibility="{Binding BypassWarningText, Converter={StaticResource StringToVisibilityConverter}}">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Text="âš ï¸" Foreground="#DC2626" Margin="0,0,8,0" FontWeight="Bold"/>
                        <TextBlock Text="{Binding BypassWarningText}" Foreground="#B91C1C" FontWeight="Medium"/>
                    </StackPanel>
                </Border>

                <!-- Compact Header (always visible) -->
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    
                    <!-- Warning Icon + Title + Count -->
                    <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                        <TextBlock Text="âš ï¸" FontSize="18" Margin="0,0,12,0"/>
                        <TextBlock Text="{Binding ActiveFixesMessage}" 
                                   Style="{StaticResource BodyStyle}" 
                                   FontWeight="SemiBold" 
                                   Foreground="{StaticResource FailBrush}"
                                   AutomationProperties.AutomationId="ActiveFixesMessage"/>
                    </StackPanel>
                    
                    <!-- Expand/Collapse Button -->
                    <Button Grid.Column="2"
                            x:Name="ToggleFixDetailsButton"
                            Content="â–¼ ÐŸÐ¾Ð´Ñ€Ð¾Ð±Ð½ÐµÐµ"
                            Padding="12,6"
                            FontSize="12"
                            Margin="0,0,12,0"
                            Style="{StaticResource SecondaryButtonStyle}"
                            Click="ToggleFixDetails_Click"
                            AutomationProperties.AutomationId="ToggleFixDetailsButton"/>
                    
                    <!-- Rollback All Button -->
                    <Button Grid.Column="3"
                            Content="ÐžÑ‚ÐºÐ°Ñ‚Ð¸Ñ‚ÑŒ Ð²ÑÑ‘"
                            Style="{StaticResource SecondaryButtonStyle}"
                            Command="{Binding RollbackAllCommand}"
                            Padding="14,6"
                            AutomationProperties.AutomationId="RollbackAllButton"/>
                </Grid>
                
                <!-- Expandable Fix List -->
                <StackPanel x:Name="FixDetailsList" 
                            Visibility="Collapsed" 
                            Margin="0,16,0,0"
                            AutomationProperties.AutomationId="FixDetailsList">
                    <ItemsControl ItemsSource="{Binding ActiveFixes}"
                                  AutomationProperties.AutomationId="ActiveFixesItemsControl">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Grid Margin="0,0,0,8">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Grid.Column="0" 
                                               Text="{Binding Description, StringFormat='â€¢ {0}'}"
                                               Style="{StaticResource BodyStyle}" 
                                               Foreground="#374151" 
                                               FontWeight="Medium"/>
                                    <Button Grid.Column="1" 
                                            Content="ÐžÑ‚ÐºÐ°Ñ‚Ð¸Ñ‚ÑŒ" 
                                            Padding="12,4"
                                            FontSize="12"
                                            Margin="12,0,0,0"
                                            Style="{StaticResource SecondaryButtonStyle}"
                                            Command="{Binding DataContext.RollbackFixCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                            CommandParameter="{Binding}"
                                            AutomationProperties.AutomationId="RollbackFixButton"/>
                                </Grid>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </StackPanel>
            </StackPanel>
        </Border>

        <!-- Scenario Selector -->
        <Border Grid.Row="1" 
                Style="{StaticResource CardStyle}" 
                Padding="16" 
                Margin="0,0,0,12"
                AutomationProperties.AutomationId="ScenarioSelector">
            <StackPanel>
                <TextBlock Text="Ð”Ð¸Ð°Ð³Ð½Ð¾ÑÑ‚Ð¸ÐºÐ° Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ" Style="{StaticResource H2Style}" Margin="0,0,0,8"/>
                
                <!-- Exe Selection -->
                <StackPanel Margin="0,0,0,0" 
                            IsEnabled="{Binding IsBasicTestMode, Converter={StaticResource InverseBoolConverter}}"
                            AutomationProperties.AutomationId="ExeScenarioPanel">
                    <TextBlock Text="Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ exe Ñ„Ð°Ð¹Ð» Ð¸Ð³Ñ€Ñ‹ Ð¸Ð»Ð¸ Ð»Ð°ÑƒÐ½Ñ‡ÐµÑ€Ð°" Style="{StaticResource BodyStyle}" Margin="0,0,0,4"/>
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <TextBox Grid.Column="0" Style="{StaticResource ModernTextBoxStyle}" 
                                 Text="{Binding ExePath, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                 AutomationProperties.AutomationId="ExePathTextBox"/>
                        <Button Grid.Column="1" Content="ÐžÐ±Ð·Ð¾Ñ€..." 
                                Style="{StaticResource SecondaryButtonStyle}"
                                Command="{Binding BrowseExeCommand}"
                                IsEnabled="{Binding IsStart}"
                                Margin="8,0,0,0"
                                AutomationProperties.AutomationId="BrowseButton"/>
                    </Grid>
                </StackPanel>

                <Grid Margin="0,12,0,0">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <StackPanel Grid.Column="0">
                        <!-- Basic Services Test Checkbox -->
                        <CheckBox Content="Ð¢ÐµÑÑ‚ Ð±Ð°Ð·Ð¾Ð²Ñ‹Ñ… ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð² (Google, YouTube, Discord)"
                                  IsChecked="{Binding IsBasicTestMode}"
                                  IsEnabled="{Binding IsStart}"
                                  AutomationProperties.AutomationId="BasicTestCheckbox"/>

                        <!-- Auto Bypass Options - Ð¡ÐšÐ Ð«Ð¢Ðž: bypass Ð²ÐºÐ»ÑŽÑ‡Ð°ÐµÑ‚ÑÑ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð¿Ñ€Ð¸ ÑÑ‚Ð°Ñ€Ñ‚Ðµ
                             ÐŸÐµÑ€ÐµÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ ÑÑ‚Ñ€Ð°Ñ‚ÐµÐ³Ð¸Ð¹ Ð±ÑƒÐ´ÐµÑ‚ Ñ€ÐµÐ°Ð»Ð¸Ð·Ð¾Ð²Ð°Ð½Ð¾ Ð¾Ñ‚Ð´ÐµÐ»ÑŒÐ½Ð¾ -->
                    </StackPanel>

                    <!-- Start Button (Unified) -->
                    <Button Grid.Column="1"
                            Content="{Binding StartButtonText}" 
                            Style="{StaticResource PrimaryButtonStyle}"
                            Command="{Binding StartLiveTestingCommand}"
                            VerticalAlignment="Bottom"
                            Margin="16,0,0,0"
                            AutomationProperties.AutomationId="StartButton"/>
                </Grid>

                <!-- Bypass Control Panel (ÐŸÑƒÐ»ÑŒÑ‚ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ) -->
                <Border Background="#F8FAFC" BorderBrush="#E2E8F0" BorderThickness="1" CornerRadius="8" 
                        Margin="0,16,0,0" Padding="16,12"
                        Visibility="{Binding ShowBypassPanel, Converter={StaticResource BoolToVisibilityConverter}}">
                    <StackPanel>
                        <!-- Header Row -->
                        <Grid Margin="0,0,0,12">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            
                            <!-- Title -->
                            <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                                <TextBlock Text="ðŸŽ›ï¸" FontSize="18" Margin="0,0,10,0" VerticalAlignment="Center"/>
                                <TextBlock Text="Bypass Control" FontWeight="Bold" FontSize="14" Foreground="#1F2937" VerticalAlignment="Center"/>
                            </StackPanel>
                            
                            <!-- Status Badge -->
                            <StackPanel Grid.Column="1" Orientation="Horizontal">
                                <!-- DoH Active Badge -->
                                <Border Background="#DBEAFE" CornerRadius="6" Padding="10,4" Margin="0,0,8,0"
                                        Visibility="{Binding IsDoHActive, Converter={StaticResource BoolToVisibilityConverter}}">
                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="ðŸ”’" FontSize="10" VerticalAlignment="Center" Margin="0,0,6,0"/>
                                        <TextBlock Text="DoH (Cloudflare)" FontWeight="SemiBold" FontSize="12" Foreground="#1E40AF"/>
                                    </StackPanel>
                                </Border>
                                <!-- Bypass Active Badge -->
                                <Border Background="#DCFCE7" CornerRadius="6" Padding="10,4"
                                        Visibility="{Binding IsBypassActive, Converter={StaticResource BoolToVisibilityConverter}}">
                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="â—" Foreground="#22C55E" FontSize="10" VerticalAlignment="Center" Margin="0,0,6,0"/>
                                        <TextBlock Text="{Binding CurrentBypassStrategy}" FontWeight="SemiBold" FontSize="12" Foreground="#166534"/>
                                    </StackPanel>
                                </Border>
                                <Border Background="#FEE2E2" CornerRadius="6" Padding="10,4"
                                        Visibility="{Binding IsBypassActive, Converter={StaticResource InverseBoolToVisibilityConverter}}">
                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="â—" Foreground="#EF4444" FontSize="10" VerticalAlignment="Center" Margin="0,0,6,0"/>
                                        <TextBlock Text="Ð’Ñ‹ÐºÐ»ÑŽÑ‡ÐµÐ½" FontWeight="SemiBold" FontSize="12" Foreground="#991B1B"/>
                                    </StackPanel>
                                </Border>
                            </StackPanel>
                        </Grid>

                        <!-- VPN Warning -->
                        <Border Background="#FEF3C7" BorderBrush="#FCD34D" BorderThickness="1" CornerRadius="6" 
                                Padding="10,6" Margin="0,0,0,12"
                                Visibility="{Binding IsVpnDetected, Converter={StaticResource BoolToVisibilityConverter}}">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="ðŸ”’" FontSize="14" Margin="0,0,8,0" VerticalAlignment="Center"/>
                                <TextBlock Text="{Binding VpnWarningText}" FontSize="12" Foreground="#92400E" VerticalAlignment="Center" TextWrapping="Wrap"/>
                            </StackPanel>
                        </Border>
                        
                        <!-- WinDivert Strategy Buttons (5 ÑÑ‚Ñ€Ð°Ñ‚ÐµÐ³Ð¸Ð¹ + Ð²Ñ‹ÐºÐ») -->
                        <Grid Margin="0,0,0,0">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            
                            <!-- FULL (Recommended) -->
                            <Button Grid.Column="0" Command="{Binding SetBypassStrategyCommand}" CommandParameter="FULL"
                                    Height="36" FontSize="12" FontWeight="SemiBold" Cursor="Hand" Margin="0,0,4,0"
                                    ToolTip="Ð ÐµÐºÐ¾Ð¼ÐµÐ½Ð´ÑƒÐµÐ¼Ñ‹Ð¹: TLS Fragment + DROP RST&#x0a;ÐŸÐ¾ÐºÑ€Ñ‹Ð²Ð°ÐµÑ‚ 90% Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²Ð¾Ðº">
                                <Button.Style>
                                    <Style TargetType="Button" BasedOn="{StaticResource SecondaryButtonStyle}">
                                        <Setter Property="Content" Value="âš¡ FULL"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding IsFullActive}" Value="True">
                                                <Setter Property="Background" Value="#3B82F6"/>
                                                <Setter Property="Foreground" Value="White"/>
                                                <Setter Property="BorderBrush" Value="#2563EB"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Button.Style>
                            </Button>
                            
                            <!-- TLS Fragment -->
                            <Button Grid.Column="1" Command="{Binding SetBypassStrategyCommand}" CommandParameter="TLS_FRAGMENT"
                                    Height="36" FontSize="12" FontWeight="Medium" Cursor="Hand" Margin="0,0,4,0"
                                    ToolTip="Ð¤Ñ€Ð°Ð³Ð¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ TLS ClientHello&#x0a;ÐžÐ±Ñ…Ð¾Ð´ SNI-Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ð°Ñ†Ð¸Ð¸">
                                <Button.Style>
                                    <Style TargetType="Button" BasedOn="{StaticResource SecondaryButtonStyle}">
                                        <Setter Property="Content" Value="Fragment"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding IsTlsFragmentActive}" Value="True">
                                                <Setter Property="Background" Value="#3B82F6"/>
                                                <Setter Property="Foreground" Value="White"/>
                                                <Setter Property="BorderBrush" Value="#2563EB"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Button.Style>
                            </Button>
                            
                            <!-- TLS Fake -->
                            <Button Grid.Column="2" Command="{Binding SetBypassStrategyCommand}" CommandParameter="TLS_FAKE"
                                    Height="36" FontSize="12" FontWeight="Medium" Cursor="Hand" Margin="0,0,4,0"
                                    ToolTip="Fake TTL Ð¿Ð°ÐºÐµÑ‚&#x0a;ÐžÐ±Ñ…Ð¾Ð´ active probing">
                                <Button.Style>
                                    <Style TargetType="Button" BasedOn="{StaticResource SecondaryButtonStyle}">
                                        <Setter Property="Content" Value="Fake"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding IsTlsFakeActive}" Value="True">
                                                <Setter Property="Background" Value="#3B82F6"/>
                                                <Setter Property="Foreground" Value="White"/>
                                                <Setter Property="BorderBrush" Value="#2563EB"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Button.Style>
                            </Button>
                            
                            <!-- Fake + Fragment -->
                            <Button Grid.Column="3" Command="{Binding SetBypassStrategyCommand}" CommandParameter="TLS_FAKE_FRAGMENT"
                                    Height="36" FontSize="12" FontWeight="Medium" Cursor="Hand" Margin="0,0,4,0"
                                    ToolTip="ÐšÐ¾Ð¼Ð±Ð¸Ð½Ð°Ñ†Ð¸Ñ Fake + Fragment&#x0a;ÐÐ³Ñ€ÐµÑÑÐ¸Ð²Ð½Ñ‹Ð¹ Ð¾Ð±Ñ…Ð¾Ð´">
                                <Button.Style>
                                    <Style TargetType="Button" BasedOn="{StaticResource SecondaryButtonStyle}">
                                        <Setter Property="Content" Value="Fake+Frag"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding IsFakeFragmentActive}" Value="True">
                                                <Setter Property="Background" Value="#3B82F6"/>
                                                <Setter Property="Foreground" Value="White"/>
                                                <Setter Property="BorderBrush" Value="#2563EB"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Button.Style>
                            </Button>
                            
                            <!-- DROP RST -->
                            <Button Grid.Column="4" Command="{Binding SetBypassStrategyCommand}" CommandParameter="DROP_RST"
                                    Height="36" FontSize="12" FontWeight="Medium" Cursor="Hand" Margin="0,0,8,0"
                                    ToolTip="Ð‘Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²ÐºÐ° TCP RST Ð¿Ð°ÐºÐµÑ‚Ð¾Ð²&#x0a;Ð—Ð°Ñ‰Ð¸Ñ‚Ð° Ð¾Ñ‚ Ñ€Ð°Ð·Ñ€Ñ‹Ð²Ð° ÑÐ¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ð¹">
                                <Button.Style>
                                    <Style TargetType="Button" BasedOn="{StaticResource SecondaryButtonStyle}">
                                        <Setter Property="Content" Value="DROP RST"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding IsDropRstActive}" Value="True">
                                                <Setter Property="Background" Value="#3B82F6"/>
                                                <Setter Property="Foreground" Value="White"/>
                                                <Setter Property="BorderBrush" Value="#2563EB"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Button.Style>
                            </Button>
                            
                            <!-- Disable -->
                            <Button Grid.Column="5" Command="{Binding DisableBypassCommand}"
                                    Height="36" Width="80" FontSize="12" FontWeight="SemiBold" Cursor="Hand"
                                    ToolTip="ÐžÑ‚ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ bypass">
                                <Button.Style>
                                    <Style TargetType="Button" BasedOn="{StaticResource SecondaryButtonStyle}">
                                        <Setter Property="Content" Value="âœ• Ð’Ñ‹ÐºÐ»"/>
                                        <Setter Property="Background" Value="#FEE2E2"/>
                                        <Setter Property="Foreground" Value="#DC2626"/>
                                        <Setter Property="BorderBrush" Value="#FECACA"/>
                                    </Style>
                                </Button.Style>
                            </Button>
                        </Grid>
                    </StackPanel>
                </Border>
            </StackPanel>
        </Border>

        <!-- Test Results -->
        <Border Grid.Row="2" 
                Style="{StaticResource CardStyle}" 
                Padding="0"
                AutomationProperties.AutomationId="TestResults">
            <Grid>
                <!-- Start State -->
                <StackPanel Visibility="{Binding IsStart, Converter={StaticResource BoolToVisibilityConverter}}"
                            VerticalAlignment="Center" 
                            HorizontalAlignment="Center"
                            Margin="16"
                            AutomationProperties.AutomationId="StartState">
                    <TextBlock Text="Ð“Ð¾Ñ‚Ð¾Ð² Ðº Ð´Ð¸Ð°Ð³Ð½Ð¾ÑÑ‚Ð¸ÐºÐµ" Style="{StaticResource H2Style}" 
                               Foreground="{StaticResource MutedBrush}" TextAlignment="Center"/>
                    <TextBlock Text="Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÑÑ†ÐµÐ½Ð°Ñ€Ð¸Ð¹ Ð¸ Ð½Ð°Ð¶Ð¼Ð¸Ñ‚Ðµ 'ÐÐ°Ñ‡Ð°Ñ‚ÑŒ Ð´Ð¸Ð°Ð³Ð½Ð¾ÑÑ‚Ð¸ÐºÑƒ'" 
                               Style="{StaticResource BodyStyle}"
                               Foreground="{StaticResource MutedBrush}"
                               TextAlignment="Center" Margin="0,4,0,0"/>
                </StackPanel>

                <!-- Active State (Running OR Done) -->
                <Grid Visibility="{Binding IsStart, Converter={StaticResource InverseBoolToVisibilityConverter}}">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/> <!-- Header (Running) -->
                        <RowDefinition Height="Auto"/> <!-- Header (Done) -->
                        <RowDefinition Height="*"/>    <!-- DataGrid -->
                    </Grid.RowDefinitions>

                    <!-- Running Header -->
                    <StackPanel Grid.Row="0" 
                                Visibility="{Binding IsRunning, Converter={StaticResource BoolToVisibilityConverter}}"
                                Margin="16,16,16,8">
                        
                        <!-- Title Row with Badge -->
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                            <TextBlock Text="Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÑ‚ÑÑ Ð´Ð¸Ð°Ð³Ð½Ð¾ÑÑ‚Ð¸ÐºÐ°..." Style="{StaticResource H2Style}" VerticalAlignment="Center"/>
                            
                            <!-- Bypass Badge - Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÑ‚ Ñ‡Ñ‚Ð¾ bypass Ð°ÐºÑ‚Ð¸Ð²ÐµÐ½ -->
                            <Border Background="#DCFCE7" BorderBrush="#86EFAC" BorderThickness="1" CornerRadius="4" Margin="12,0,0,0" Padding="6,2"
                                    VerticalAlignment="Center"
                                    Visibility="{Binding IsBypassActive, Converter={StaticResource BoolToVisibilityConverter}}">
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock Text="ðŸ›¡ï¸ Bypass Active" Foreground="#166534" FontWeight="SemiBold" FontSize="11"/>
                                </StackPanel>
                            </Border>
                        </StackPanel>

                        <TextBlock Text="{Binding CurrentAction}" 
                                   Foreground="{StaticResource MutedBrush}"
                                   FontSize="13"
                                   Margin="0,0,0,8"
                                   TextWrapping="Wrap"
                                   Visibility="{Binding CurrentAction, Converter={StaticResource StringToVisibilityConverter}}"/>
                        <ProgressBar IsIndeterminate="True"
                                     Height="2" 
                                     BorderThickness="0"
                                     Background="#E5E7EB"
                                     Foreground="{StaticResource PrimaryBrush}"/>
                        
                        <!-- D2: Flow Stats -->
                        <StackPanel Orientation="Horizontal" Margin="0,8,0,0">
                            <TextBlock Text="ÐÐºÑ‚Ð¸Ð²Ð½Ð¾ÑÑ‚ÑŒ ÑÐµÑ‚Ð¸:" FontWeight="SemiBold" Margin="0,0,8,0" Foreground="#4B5563" FontSize="12"/>
                            <TextBlock Text="{Binding FlowModeText, StringFormat='Ð ÐµÐ¶Ð¸Ð¼: {0}'}" Margin="0,0,12,0" Foreground="#4B5563" FontWeight="Medium" FontSize="12"/>
                            <TextBlock Text="{Binding ConnectionsDiscovered, StringFormat='Ð¡Ð¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ð¹: {0}'}" Margin="0,0,12,0" Foreground="#374151" FontSize="12"/>
                            <TextBlock Text="{Binding FlowEventsCount, StringFormat='Ð¡Ð¾Ð±Ñ‹Ñ‚Ð¸Ð¹ Flow: {0}'}" Foreground="#6B7280" FontSize="12"/>
                        </StackPanel>
                    </StackPanel>

                    <!-- Done Header -->
                    <StackPanel Grid.Row="1" 
                                Visibility="{Binding IsDone, Converter={StaticResource BoolToVisibilityConverter}}"
                                Margin="16,16,16,8">
                        <Grid Margin="0,0,0,12">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            
                            <TextBlock Text="Ð”Ð¸Ð°Ð³Ð½Ð¾ÑÑ‚Ð¸ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°" Style="{StaticResource H2Style}"/>
                            
                            <StackPanel Grid.Column="1" Orientation="Horizontal">
                                <Button Content="Ð­ÐºÑÐ¿Ð¾Ñ€Ñ‚ Ð¾Ñ‚Ñ‡ÐµÑ‚Ð°" 
                                        Style="{StaticResource SecondaryButtonStyle}"
                                        Command="{Binding ReportCommand}"
                                        Margin="0,0,8,0"
                                        Padding="10,4"
                                        FontSize="12"/>
                                <Button Content="ÐÐ¾Ð²Ð°Ñ Ð´Ð¸Ð°Ð³Ð½Ð¾ÑÑ‚Ð¸ÐºÐ°" 
                                        Style="{StaticResource PrimaryButtonStyle}"
                                        Command="{Binding SetStateCommand}"
                                        CommandParameter="start"
                                        Padding="10,4"
                                        FontSize="12"/>
                            </StackPanel>
                        </Grid>

                        <!-- Summary Stats -->
                        <Border Background="#F9FAFB" 
                                CornerRadius="8" 
                                Padding="12">
                            <Grid>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                
                                <StackPanel Grid.Row="0" Grid.Column="0">
                                    <TextBlock Text="Ð£ÑÐ¿ÐµÑˆÐ½Ð¾" Style="{StaticResource CaptionStyle}"/>
                                    <TextBlock Text="{Binding PassCount}" Style="{StaticResource H2Style}" Foreground="{StaticResource PassBrush}"/>
                                </StackPanel>
                                
                                <StackPanel Grid.Row="0" Grid.Column="1">
                                    <TextBlock Text="ÐžÑˆÐ¸Ð±ÐºÐ¸" Style="{StaticResource CaptionStyle}"/>
                                    <TextBlock Text="{Binding FailCount}" Style="{StaticResource H2Style}" Foreground="{StaticResource FailBrush}"/>
                                </StackPanel>
                                
                                <StackPanel Grid.Row="0" Grid.Column="2">
                                    <TextBlock Text="ÐŸÑ€ÐµÐ´ÑƒÐ¿Ñ€ÐµÐ¶Ð´ÐµÐ½Ð¸Ñ" Style="{StaticResource CaptionStyle}"/>
                                    <TextBlock Text="{Binding WarnCount}" Style="{StaticResource H2Style}" Foreground="{StaticResource WarnBrush}"/>
                                </StackPanel>

                                <!-- Profile Saved Notification -->
                                <Border Grid.Row="1" Grid.ColumnSpan="3" 
                                        Margin="0,8,0,0" 
                                        Background="#ECFDF5" 
                                        BorderBrush="#A7F3D0" 
                                        BorderThickness="1" 
                                        CornerRadius="4" 
                                        Padding="8,4"
                                        Visibility="{Binding DiagnosticStatus, Converter={StaticResource StringToVisibilityConverter}}">
                                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                                        <TextBlock Text="ðŸ’¾" Margin="0,0,8,0" FontSize="12"/>
                                        <TextBlock Text="{Binding DiagnosticStatus}" Foreground="#047857" FontWeight="Medium" FontSize="12"/>
                                    </StackPanel>
                                </Border>
                            </Grid>
                        </Border>
                    </StackPanel>

                    <!-- Unified DataGrid -->
                    <DataGrid Grid.Row="2"
                              ItemsSource="{Binding TestResults}"
                              AutoGenerateColumns="False"
                              CanUserAddRows="False"
                              CanUserDeleteRows="False"
                              CanUserResizeRows="False"
                              IsReadOnly="True"
                              SelectionMode="Single"
                              SelectionUnit="FullRow"
                              ClipboardCopyMode="IncludeHeader"
                              HeadersVisibility="Column"
                              GridLinesVisibility="Horizontal"
                              HorizontalGridLinesBrush="#E5E7EB"
                              VerticalGridLinesBrush="#E5E7EB"
                              Background="White"
                              BorderThickness="1"
                              BorderBrush="#E5E7EB"
                              RowBackground="White"
                              AlternatingRowBackground="#F9FAFB"
                              Padding="0"
                              FontSize="14"
                              HorizontalScrollBarVisibility="Disabled"
                              VerticalScrollBarVisibility="Auto"
                              AutomationProperties.AutomationId="TestResultsDataGrid">
                        
                        <DataGrid.Resources>
                            <!-- Override Selection Colors to Light Blue so buttons and gray text are visible -->
                            <SolidColorBrush x:Key="{x:Static SystemColors.HighlightBrushKey}" Color="#DBEAFE"/>
                            <SolidColorBrush x:Key="{x:Static SystemColors.HighlightTextBrushKey}" Color="Black"/>
                            <SolidColorBrush x:Key="{x:Static SystemColors.InactiveSelectionHighlightBrushKey}" Color="#F3F4F6"/>
                            <SolidColorBrush x:Key="{x:Static SystemColors.InactiveSelectionHighlightTextBrushKey}" Color="Black"/>

                            <Style TargetType="DataGridColumnHeader">
                                <Setter Property="Padding" Value="8,6"/>
                                <Setter Property="Background" Value="#F3F4F6"/>
                                <Setter Property="FontWeight" Value="SemiBold"/>
                                <Setter Property="Foreground" Value="#374151"/>
                                <Setter Property="BorderThickness" Value="0,0,0,1"/>
                                <Setter Property="BorderBrush" Value="#E5E7EB"/>
                            </Style>
                            
                            <Style TargetType="DataGridRow">
                                <Setter Property="MinHeight" Value="36"/>
                                <EventSetter Event="MouseDoubleClick" Handler="DataGridRow_MouseDoubleClick"/>
                                <Style.Triggers>
                                    <Trigger Property="IsSelected" Value="True">
                                        <Setter Property="Background" Value="#DBEAFE"/>
                                    </Trigger>
                                </Style.Triggers>
                            </Style>
                            
                            <Style TargetType="DataGridCell">
                                <Setter Property="Padding" Value="8,4"/>
                                <Setter Property="FocusVisualStyle" Value="{x:Null}"/>
                                <Setter Property="BorderThickness" Value="0"/>
                                <Setter Property="Template">
                                    <Setter.Value>
                                        <ControlTemplate TargetType="DataGridCell">
                                            <Border Padding="{TemplateBinding Padding}" 
                                                    BorderBrush="Transparent" 
                                                    BorderThickness="0" 
                                                    Background="{TemplateBinding Background}" 
                                                    SnapsToDevicePixels="True">
                                                <ContentPresenter SnapsToDevicePixels="{TemplateBinding SnapsToDevicePixels}"/>
                                            </Border>
                                        </ControlTemplate>
                                    </Setter.Value>
                                </Setter>
                            </Style>
                        </DataGrid.Resources>

                        <DataGrid.Columns>
                            <!-- Service Name -->
                            <DataGridTextColumn Header="Ð¡ÐµÑ€Ð²Ð¸Ñ" 
                                                Binding="{Binding Target.Name}" 
                                                Width="1.5*"
                                                MinWidth="120"
                                                FontWeight="SemiBold"/>

                            <!-- Host/IP -->
                            <DataGridTextColumn Header="Ð¥Ð¾ÑÑ‚ / IP" 
                                                Binding="{Binding Target.Host}" 
                                                Width="1*"
                                                MinWidth="100"/>

                            <!-- Status -->
                            <DataGridTemplateColumn Header="Ð¡Ñ‚Ð°Ñ‚ÑƒÑ" Width="1*" MinWidth="100">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <StackPanel Orientation="Horizontal">
                                            <local:StatusDot Status="{Binding Status}" Margin="0,0,6,0"/>
                                            <TextBlock Text="{Binding StatusText}" VerticalAlignment="Center" FontWeight="Medium"/>
                                        </StackPanel>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>

                            <!-- Details -->
                            <DataGridTextColumn Header="Ð”ÐµÑ‚Ð°Ð»Ð¸" 
                                                Binding="{Binding Details}" 
                                                Width="3*"
                                                MinWidth="200">
                                <DataGridTextColumn.ElementStyle>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="TextWrapping" Value="Wrap"/>
                                        <Setter Property="Padding" Value="8,4"/>
                                        <Setter Property="VerticalAlignment" Value="Center"/>
                                        <Setter Property="FontSize" Value="12"/>
                                        <Setter Property="Foreground" Value="#4B5563"/>
                                    </Style>
                                </DataGridTextColumn.ElementStyle>
                            </DataGridTextColumn>

                            <!-- Strategy -->
                            <DataGridTextColumn Header="Ð¡Ñ‚Ñ€Ð°Ñ‚ÐµÐ³Ð¸Ñ" 
                                                Binding="{Binding BypassStrategy}" 
                                                Width="1.2*"
                                                MinWidth="110">
                                <DataGridTextColumn.ElementStyle>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="VerticalAlignment" Value="Center"/>
                                        <Setter Property="Padding" Value="8,4"/>
                                        <Setter Property="Foreground" Value="#6B7280"/>
                                        <Setter Property="FontWeight" Value="Medium"/>
                                        <Setter Property="FontSize" Value="12"/>
                                    </Style>
                                </DataGridTextColumn.ElementStyle>
                            </DataGridTextColumn>

                            <!-- Actions -->
                            <DataGridTemplateColumn Header="Ð”ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ" Width="100" MinWidth="100">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <Button Content="Ð˜ÑÐ¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ"
                                                Command="{Binding DataContext.FixCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                CommandParameter="{Binding}"
                                                Visibility="{Binding ShowFixButton, Converter={StaticResource BoolToVisibilityConverter}}"
                                                Style="{StaticResource PrimaryButtonStyle}"
                                                Padding="8,4"
                                                FontSize="11"
                                                HorizontalAlignment="Stretch"/>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                        </DataGrid.Columns>
                    </DataGrid>
                </Grid>
            </Grid>
        </Border>



        <!-- Footer: User Communication Area -->
        <Border Grid.Row="3" 
                Background="#F3F4F6" 
                CornerRadius="6" 
                Padding="12,8" 
                Margin="0,8,0,0">
            <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                <TextBlock Text="â„¹ï¸" Margin="0,0,8,0" VerticalAlignment="Center"/>
                <TextBlock Text="{Binding UserMessage}" 
                           Style="{StaticResource BodyStyle}"
                           FontWeight="Medium"
                           Foreground="#374151"
                           VerticalAlignment="Center"
                           TextTrimming="CharacterEllipsis"/>
            </StackPanel>
        </Border>
    </Grid>
</Window>
