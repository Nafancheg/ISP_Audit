<Window x:Class="ISPAudit.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:local="clr-namespace:ISPAudit.Controls"
        xmlns:vm="clr-namespace:ISPAudit.ViewModels"
        Title="ISP Audit - Диагностика сети"
        Height="800" Width="1400"
        MinHeight="600" MinWidth="1000"
        Background="{StaticResource BgBrush}"
        FontFamily="Segoe UI"
        TextOptions.TextFormattingMode="Display"
        TextOptions.TextRenderingMode="ClearType">
    
    <Window.DataContext>
        <vm:MainViewModel/>
    </Window.DataContext>

    <Grid Margin="32">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Header: Fix Status Bar (Collapsible) -->
        <Border Grid.Row="0" 
                x:Name="FixStatusBar"
                Background="#FEF3F2" 
                BorderBrush="#FEE2E2"
                BorderThickness="1"
                CornerRadius="8" 
                Padding="16,12"
                Margin="0,0,0,24"
                Visibility="{Binding HasActiveFixes, Converter={StaticResource BoolToVisibilityConverter}}"
                AutomationProperties.AutomationId="FixStatusBar">
            <!-- Будет показываться через ViewModel когда есть активные фиксы -->
            <StackPanel>
                <!-- Compact Header (always visible) -->
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    
                    <!-- Warning Icon + Title + Count -->
                    <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                        <TextBlock Text="⚠️" FontSize="18" Margin="0,0,12,0"/>
                        <TextBlock Text="{Binding ActiveFixesMessage}" 
                                   Style="{StaticResource BodyStyle}" 
                                   FontWeight="SemiBold" 
                                   Foreground="{StaticResource FailBrush}"
                                   AutomationProperties.AutomationId="ActiveFixesMessage"/>
                    </StackPanel>
                    
                    <!-- Expand/Collapse Button -->
                    <Button Grid.Column="2"
                            x:Name="ToggleFixDetailsButton"
                            Content="▼ Подробнее"
                            Padding="12,6"
                            FontSize="12"
                            Margin="0,0,12,0"
                            Style="{StaticResource SecondaryButtonStyle}"
                            Click="ToggleFixDetails_Click"
                            AutomationProperties.AutomationId="ToggleFixDetailsButton"/>
                    
                    <!-- Rollback All Button -->
                    <Button Grid.Column="3"
                            Content="Откатить всё"
                            Style="{StaticResource SecondaryButtonStyle}"
                            Command="{Binding RollbackAllCommand}"
                            Padding="14,6"
                            AutomationProperties.AutomationId="RollbackAllButton"/>
                </Grid>
                
                <!-- Expandable Fix List -->
                <StackPanel x:Name="FixDetailsList" 
                            Visibility="Collapsed" 
                            Margin="0,16,0,0"
                            AutomationProperties.AutomationId="FixDetailsList">
                    <ItemsControl ItemsSource="{Binding ActiveFixes}"
                                  AutomationProperties.AutomationId="ActiveFixesItemsControl">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Grid Margin="0,0,0,8">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Grid.Column="0" 
                                               Text="{Binding Description, StringFormat='• {0}'}"
                                               Style="{StaticResource BodyStyle}" 
                                               Foreground="#374151" 
                                               FontWeight="Medium"/>
                                    <Button Grid.Column="1" 
                                            Content="Откатить" 
                                            Padding="12,4"
                                            FontSize="12"
                                            Margin="12,0,0,0"
                                            Style="{StaticResource SecondaryButtonStyle}"
                                            Command="{Binding DataContext.RollbackFixCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                            CommandParameter="{Binding}"
                                            AutomationProperties.AutomationId="RollbackFixButton"/>
                                </Grid>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </StackPanel>
            </StackPanel>
        </Border>

        <!-- Scenario Selector -->
        <Border Grid.Row="1" 
                Style="{StaticResource CardStyle}" 
                Padding="20" 
                Margin="0,0,0,24"
                AutomationProperties.AutomationId="ScenarioSelector">
            <StackPanel>
                <TextBlock Text="Диагностика приложения" Style="{StaticResource H2Style}" Margin="0,0,0,16"/>
                
                <!-- Exe Selection -->
                <StackPanel Margin="0,0,0,0" 
                            AutomationProperties.AutomationId="ExeScenarioPanel">
                    <TextBlock Text="Выберите exe файл игры или лаунчера" Style="{StaticResource BodyStyle}" Margin="0,0,0,8"/>
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <TextBox Grid.Column="0" Style="{StaticResource ModernTextBoxStyle}" 
                                 Text="{Binding ExePath, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                 AutomationProperties.AutomationId="ExePathTextBox"/>
                        <Button Grid.Column="1" Content="Обзор..." 
                                Style="{StaticResource SecondaryButtonStyle}"
                                Command="{Binding BrowseExeCommand}"
                                IsEnabled="{Binding IsStart}"
                                Margin="8,0,0,0"
                                AutomationProperties.AutomationId="BrowseButton"/>
                    </Grid>
                </StackPanel>

                <!-- Start Button (Unified) -->
                <Button Content="{Binding StartButtonText}" 
                    Style="{StaticResource PrimaryButtonStyle}"
                    Command="{Binding StartLiveTestingCommand}"
                    HorizontalAlignment="Left"
                    Margin="0,24,0,0"
                    AutomationProperties.AutomationId="StartButton"/>
            </StackPanel>
        </Border>

        <!-- Test Results -->
        <Border Grid.Row="2" 
                Style="{StaticResource CardStyle}" 
                Padding="20"
                AutomationProperties.AutomationId="TestResults">
            <Grid>
                <!-- Start State -->
                <StackPanel Visibility="{Binding IsStart, Converter={StaticResource BoolToVisibilityConverter}}"
                            VerticalAlignment="Center" 
                            HorizontalAlignment="Center"
                            AutomationProperties.AutomationId="StartState">
                    <TextBlock Text="Готов к диагностике" Style="{StaticResource H2Style}" 
                               Foreground="{StaticResource MutedBrush}" TextAlignment="Center"/>
                    <TextBlock Text="Выберите сценарий и нажмите 'Начать диагностику'" 
                               Style="{StaticResource BodyStyle}"
                               Foreground="{StaticResource MutedBrush}"
                               TextAlignment="Center" Margin="0,8,0,0"/>
                </StackPanel>

                <!-- Active State (Running OR Done) -->
                <Grid Visibility="{Binding IsStart, Converter={StaticResource InverseBoolToVisibilityConverter}}">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/> <!-- Header (Running) -->
                        <RowDefinition Height="Auto"/> <!-- Header (Done) -->
                        <RowDefinition Height="*"/>    <!-- DataGrid -->
                    </Grid.RowDefinitions>

                    <!-- Running Header -->
                    <StackPanel Grid.Row="0" 
                                Visibility="{Binding IsRunning, Converter={StaticResource BoolToVisibilityConverter}}"
                                Margin="0,0,0,16">
                        <TextBlock Text="Выполняется диагностика..." Style="{StaticResource H2Style}" Margin="0,0,0,8"/>
                        <TextBlock Text="{Binding CurrentAction}" 
                                   Foreground="{StaticResource MutedBrush}"
                                   FontSize="14"
                                   Margin="0,0,0,16"
                                   TextWrapping="Wrap"
                                   Visibility="{Binding CurrentAction, Converter={StaticResource StringToVisibilityConverter}}"/>
                        <ProgressBar IsIndeterminate="True"
                                     Height="4" 
                                     BorderThickness="0"
                                     Background="#E5E7EB"
                                     Foreground="{StaticResource PrimaryBrush}"/>
                    </StackPanel>

                    <!-- Done Header -->
                    <StackPanel Grid.Row="1" 
                                Visibility="{Binding IsDone, Converter={StaticResource BoolToVisibilityConverter}}"
                                Margin="0,0,0,16">
                        <Grid Margin="0,0,0,24">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            
                            <TextBlock Text="Диагностика завершена" Style="{StaticResource H2Style}"/>
                            
                            <StackPanel Grid.Column="1" Orientation="Horizontal">
                                <Button Content="Экспорт отчета" 
                                        Style="{StaticResource SecondaryButtonStyle}"
                                        Command="{Binding ReportCommand}"
                                        Margin="0,0,8,0"/>
                                <Button Content="Новая диагностика" 
                                        Style="{StaticResource PrimaryButtonStyle}"
                                        Command="{Binding SetStateCommand}"
                                        CommandParameter="start"/>
                            </StackPanel>
                        </Grid>

                        <!-- Summary Stats -->
                        <Border Background="#F9FAFB" 
                                CornerRadius="12" 
                                Padding="20">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                
                                <StackPanel Grid.Column="0">
                                    <TextBlock Text="Успешно" Style="{StaticResource CaptionStyle}"/>
                                    <TextBlock Text="{Binding PassCount}" Style="{StaticResource H1Style}" Foreground="{StaticResource PassBrush}"/>
                                </StackPanel>
                                
                                <StackPanel Grid.Column="1">
                                    <TextBlock Text="Ошибки" Style="{StaticResource CaptionStyle}"/>
                                    <TextBlock Text="{Binding FailCount}" Style="{StaticResource H1Style}" Foreground="{StaticResource FailBrush}"/>
                                </StackPanel>
                                
                                <StackPanel Grid.Column="2">
                                    <TextBlock Text="Предупреждения" Style="{StaticResource CaptionStyle}"/>
                                    <TextBlock Text="{Binding WarnCount}" Style="{StaticResource H1Style}" Foreground="{StaticResource WarnBrush}"/>
                                </StackPanel>
                            </Grid>
                        </Border>
                    </StackPanel>

                    <!-- Unified DataGrid -->
                    <DataGrid Grid.Row="2"
                              ItemsSource="{Binding TestResults}"
                              AutoGenerateColumns="False"
                              CanUserAddRows="False"
                              CanUserDeleteRows="False"
                              CanUserResizeRows="False"
                              IsReadOnly="True"
                              SelectionMode="Single"
                              SelectionUnit="FullRow"
                              ClipboardCopyMode="IncludeHeader"
                              HeadersVisibility="Column"
                              GridLinesVisibility="Horizontal"
                              HorizontalGridLinesBrush="#E5E7EB"
                              VerticalGridLinesBrush="#E5E7EB"
                              Background="White"
                              BorderThickness="1"
                              BorderBrush="#E5E7EB"
                              RowBackground="White"
                              AlternatingRowBackground="#F9FAFB"
                              Padding="0"
                              FontSize="14"
                              HorizontalScrollBarVisibility="Disabled"
                              VerticalScrollBarVisibility="Auto"
                              AutomationProperties.AutomationId="TestResultsDataGrid">
                        
                        <DataGrid.Resources>
                            <!-- Override Selection Colors to Light Blue so buttons and gray text are visible -->
                            <SolidColorBrush x:Key="{x:Static SystemColors.HighlightBrushKey}" Color="#DBEAFE"/>
                            <SolidColorBrush x:Key="{x:Static SystemColors.HighlightTextBrushKey}" Color="Black"/>
                            <SolidColorBrush x:Key="{x:Static SystemColors.InactiveSelectionHighlightBrushKey}" Color="#F3F4F6"/>
                            <SolidColorBrush x:Key="{x:Static SystemColors.InactiveSelectionHighlightTextBrushKey}" Color="Black"/>

                            <Style TargetType="DataGridColumnHeader">
                                <Setter Property="Padding" Value="12,10"/>
                                <Setter Property="Background" Value="#F3F4F6"/>
                                <Setter Property="FontWeight" Value="SemiBold"/>
                                <Setter Property="Foreground" Value="#374151"/>
                                <Setter Property="BorderThickness" Value="0,0,0,1"/>
                                <Setter Property="BorderBrush" Value="#E5E7EB"/>
                            </Style>
                            
                            <Style TargetType="DataGridRow">
                                <Setter Property="MinHeight" Value="48"/>
                                <EventSetter Event="MouseDoubleClick" Handler="DataGridRow_MouseDoubleClick"/>
                                <Style.Triggers>
                                    <Trigger Property="IsSelected" Value="True">
                                        <Setter Property="Background" Value="#DBEAFE"/>
                                    </Trigger>
                                </Style.Triggers>
                            </Style>
                            
                            <Style TargetType="DataGridCell">
                                <Setter Property="Padding" Value="12,8"/>
                                <Setter Property="FocusVisualStyle" Value="{x:Null}"/>
                                <Setter Property="BorderThickness" Value="0"/>
                                <Setter Property="Template">
                                    <Setter.Value>
                                        <ControlTemplate TargetType="DataGridCell">
                                            <Border Padding="{TemplateBinding Padding}" 
                                                    BorderBrush="Transparent" 
                                                    BorderThickness="0" 
                                                    Background="{TemplateBinding Background}" 
                                                    SnapsToDevicePixels="True">
                                                <ContentPresenter SnapsToDevicePixels="{TemplateBinding SnapsToDevicePixels}"/>
                                            </Border>
                                        </ControlTemplate>
                                    </Setter.Value>
                                </Setter>
                            </Style>
                        </DataGrid.Resources>

                        <DataGrid.Columns>
                            <!-- Service Name -->
                            <DataGridTextColumn Header="Сервис" 
                                                Binding="{Binding Target.Name}" 
                                                Width="1.5*"
                                                MinWidth="120"
                                                FontWeight="SemiBold"/>

                            <!-- Host/IP -->
                            <DataGridTextColumn Header="Хост / IP" 
                                                Binding="{Binding Target.Host}" 
                                                Width="1*"
                                                MinWidth="100"/>

                            <!-- Status -->
                            <DataGridTemplateColumn Header="Статус" Width="1*" MinWidth="100">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <StackPanel Orientation="Horizontal">
                                            <local:StatusDot Status="{Binding Status}" Margin="0,0,8,0"/>
                                            <TextBlock Text="{Binding StatusText}" VerticalAlignment="Center" FontWeight="Medium"/>
                                        </StackPanel>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>

                            <!-- Details -->
                            <DataGridTextColumn Header="Детали" 
                                                Binding="{Binding Details}" 
                                                Width="3*"
                                                MinWidth="200">
                                <DataGridTextColumn.ElementStyle>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="TextWrapping" Value="Wrap"/>
                                        <Setter Property="Padding" Value="12,8"/>
                                        <Setter Property="VerticalAlignment" Value="Center"/>
                                        <Setter Property="FontSize" Value="13"/>
                                        <Setter Property="Foreground" Value="#4B5563"/>
                                    </Style>
                                </DataGridTextColumn.ElementStyle>
                            </DataGridTextColumn>

                            <!-- Strategy -->
                            <DataGridTextColumn Header="Стратегия" 
                                                Binding="{Binding BypassStrategy}" 
                                                Width="1.2*"
                                                MinWidth="110">
                                <DataGridTextColumn.ElementStyle>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="VerticalAlignment" Value="Center"/>
                                        <Setter Property="Padding" Value="12,8"/>
                                        <Setter Property="Foreground" Value="#6B7280"/>
                                        <Setter Property="FontWeight" Value="Medium"/>
                                    </Style>
                                </DataGridTextColumn.ElementStyle>
                            </DataGridTextColumn>

                            <!-- Actions -->
                            <DataGridTemplateColumn Header="Действия" Width="110" MinWidth="110">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <Button Content="Исправить"
                                                Command="{Binding DataContext.FixCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                CommandParameter="{Binding}"
                                                Visibility="{Binding ShowFixButton, Converter={StaticResource BoolToVisibilityConverter}}"
                                                Style="{StaticResource PrimaryButtonStyle}"
                                                Padding="10,6"
                                                FontSize="12"
                                                HorizontalAlignment="Stretch"/>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                        </DataGrid.Columns>
                    </DataGrid>
                </Grid>
            </Grid>
        </Border>



        <!-- Footer -->
        <TextBlock Grid.Row="3" 
                   Text="ISP Audit v2.0 • Диагностика сетевых проблем (с)DAfanasev 2025"
                   Style="{StaticResource CaptionStyle}"
                   HorizontalAlignment="Center"
                   Margin="0,16,0,0"/>
    </Grid>
</Window>
