<Window x:Class="ISPAudit.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:local="clr-namespace:ISPAudit.Controls"
        xmlns:vm="clr-namespace:ISPAudit.ViewModels"
        Title="ISP Audit - Ð”Ð¸Ð°Ð³Ð½Ð¾ÑÑ‚Ð¸ÐºÐ° ÑÐµÑ‚Ð¸"
        Height="800" Width="1400"
        MinHeight="600" MinWidth="1000"
        WindowStartupLocation="Manual"
        Loaded="Window_Loaded"
        Background="{StaticResource BgBrush}"
        FontFamily="Segoe UI"
        TextOptions.TextFormattingMode="Display"
        TextOptions.TextRenderingMode="ClearType">

    <Window.DataContext>
        <vm:MainViewModelRefactored/>
    </Window.DataContext>

    <Window.Resources>
        <ContextMenu x:Key="RowContextMenu">
            <MenuItem Header="ÐšÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Host" Click="CopyHost_Click"/>
            <MenuItem Header="ÐšÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Fallback IP" Click="CopyFallbackIp_Click"
                      Visibility="{Binding Target.FallbackIp, Converter={StaticResource StringToVisibilityConverter}}"/>
        </ContextMenu>
    </Window.Resources>

    <Grid Margin="16">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Fix Status Bar ÑƒÐ±Ñ€Ð°Ð½Ð° - ÑÑ‚Ð°Ñ‚ÑƒÑ Ð²Ð¸Ð´ÐµÐ½ Ð¿Ð¾ ÐºÐ½Ð¾Ð¿ÐºÐ°Ð¼ Bypass Control -->

        <!-- Scenario Selector -->
        <Border Grid.Row="1" 
                Style="{StaticResource CardStyle}" 
                Padding="16" 
                Margin="0,0,0,12"
                AutomationProperties.AutomationId="ScenarioSelector">
            <StackPanel>
                <TextBlock Text="Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ exe Ñ„Ð°Ð¹Ð» Ð¸Ð³Ñ€Ñ‹ Ð¸Ð»Ð¸ Ð»Ð°ÑƒÐ½Ñ‡ÐµÑ€Ð°" Style="{StaticResource BodyStyle}" Margin="0,0,0,8"/>
                
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <!-- Path TextBox -->
                    <TextBox Grid.Column="0" Style="{StaticResource ModernTextBoxStyle}" 
                             Text="{Binding ExePath, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                             IsEnabled="{Binding IsBasicTestMode, Converter={StaticResource InverseBoolConverter}}"
                             AutomationProperties.AutomationId="ExePathTextBox" 
                             Margin="0,0,8,0" VerticalAlignment="Center" Height="36"/>

                    <!-- Browse Button -->
                    <Button Grid.Column="1" Content="ÐžÐ±Ð·Ð¾Ñ€..." 
                            Style="{StaticResource SecondaryButtonStyle}"
                            Command="{Binding BrowseExeCommand}"
                            IsEnabled="{Binding IsBasicTestMode, Converter={StaticResource InverseBoolConverter}}"
                            Margin="0,0,16,0" Padding="12,0" Height="36"
                            AutomationProperties.AutomationId="BrowseButton" VerticalAlignment="Center"/>

                    <!-- Start Button -->
                    <Button Grid.Column="2"
                            Content="{Binding StartButtonText}" 
                            Style="{StaticResource PrimaryButtonStyle}"
                            Command="{Binding StartLiveTestingCommand}"
                            Margin="0,0,16,0" Padding="20,0" Height="36"
                            AutomationProperties.AutomationId="StartButton" VerticalAlignment="Center"/>

                    <!-- Checkbox -->
                    <CheckBox Grid.Column="3" 
                              Content="Ð¢ÐµÑÑ‚ Ð±Ð°Ð·Ð¾Ð²Ñ‹Ñ… ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð² (Google, YouTube, Discord)"
                              IsChecked="{Binding IsBasicTestMode}"
                              IsEnabled="{Binding IsStart}"
                              AutomationProperties.AutomationId="BasicTestCheckbox" 
                              VerticalAlignment="Center"/>
                </Grid>

                <!-- Bypass Control Panel (ÐŸÑƒÐ»ÑŒÑ‚ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ) -->
                <Border Background="#F8FAFC" BorderBrush="#E2E8F0" BorderThickness="1" CornerRadius="8" 
                        Margin="0,16,0,0" Padding="16,12"
                        Visibility="{Binding ShowBypassPanel, Converter={StaticResource BoolToVisibilityConverter}}">
                    <StackPanel>
                        <!-- Header Row -->
                        <Grid Margin="0,0,0,12">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>

                            <!-- Title -->
                            <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                                <TextBlock Text="ðŸŽ›ï¸" FontSize="18" Margin="0,0,10,0" VerticalAlignment="Center"/>
                                <TextBlock Text="Bypass Control" FontWeight="Bold" FontSize="14" Foreground="#1F2937" VerticalAlignment="Center"/>
                            </StackPanel>

                            <!-- Status Badges -->
                            <StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Right">
                                <!-- Performance Indicator -->
                                <Border Background="#F3F4F6" CornerRadius="6" Padding="8,4" Margin="0,0,8,0"
                                        ToolTip="Ð¡Ñ€ÐµÐ´Ð½ÐµÐµ Ð²Ñ€ÐµÐ¼Ñ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸ Ð¾Ð´Ð½Ð¾Ð³Ð¾ Ð¿Ð°ÐºÐµÑ‚Ð° Ð´Ð²Ð¸Ð¶ÐºÐ¾Ð¼ TrafficEngine">
                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="âš¡" FontSize="10" VerticalAlignment="Center" Margin="0,0,6,0"/>
                                        <TextBlock Text="{Binding TrafficEngineLatencyText}" FontWeight="SemiBold" FontSize="11" Foreground="{Binding TrafficEngineLatencyColor}"/>
                                    </StackPanel>
                                </Border>

                                <!-- DoH Active Badge -->
                                <Border Background="#DBEAFE" CornerRadius="6" Padding="10,4" Margin="0,0,8,0"
                                        Visibility="{Binding IsDoHActive, Converter={StaticResource BoolToVisibilityConverter}}">
                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="ðŸ”’" FontSize="10" VerticalAlignment="Center" Margin="0,0,6,0"/>
                                        <TextBlock Text="DoH (Cloudflare)" FontWeight="SemiBold" FontSize="12" Foreground="#1E40AF"/>
                                    </StackPanel>
                                </Border>
                                <!-- Bypass Active Badge -->
                                <Border Background="#DCFCE7" CornerRadius="6" Padding="10,4"
                                        Visibility="{Binding IsBypassActive, Converter={StaticResource BoolToVisibilityConverter}}">
                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="â—" Foreground="#22C55E" FontSize="10" VerticalAlignment="Center" Margin="0,0,6,0"/>
                                        <TextBlock Text="{Binding CurrentBypassStrategy}" FontWeight="SemiBold" FontSize="12" Foreground="#166534"/>
                                    </StackPanel>
                                </Border>
                            </StackPanel>
                        </Grid>

                        <!-- VPN Warning -->
                        <Border Background="#FEF3C7" BorderBrush="#FCD34D" BorderThickness="1" CornerRadius="6" 
                                Padding="10,6" Margin="0,0,0,8"
                                Visibility="{Binding IsVpnDetected, Converter={StaticResource BoolToVisibilityConverter}}">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="ðŸ”’" FontSize="14" Margin="0,0,8,0" VerticalAlignment="Center"/>
                                <TextBlock Text="{Binding VpnWarningText}" FontSize="12" Foreground="#92400E" VerticalAlignment="Center" TextWrapping="Wrap"/>
                            </StackPanel>
                        </Border>

                        <!-- Compatibility Warning (Ð½ÐµÑÐ¾Ð²Ð¼ÐµÑÑ‚Ð¸Ð¼Ð¾ÑÑ‚ÑŒ ÑÑ‚Ñ€Ð°Ñ‚ÐµÐ³Ð¸Ð¹) -->
                        <Border Background="#FEF9C3" BorderBrush="#FDE047" BorderThickness="1" CornerRadius="6" 
                                Padding="10,6" Margin="0,0,0,12"
                                Visibility="{Binding HasCompatibilityWarning, Converter={StaticResource BoolToVisibilityConverter}}">
                            <TextBlock Text="{Binding CompatibilityWarning}" FontSize="11" Foreground="#854D0E" 
                                       VerticalAlignment="Center" TextWrapping="Wrap" LineHeight="18"/>
                        </Border>

                        <!-- ÐÐµÐ·Ð°Ð²Ð¸ÑÐ¸Ð¼Ñ‹Ðµ toggle-ÐºÐ½Ð¾Ð¿ÐºÐ¸ bypass (1 Ð¾Ð¿Ñ†Ð¸Ñ = 1 ÐºÐ½Ð¾Ð¿ÐºÐ°) -->
                        <Grid Margin="0,0,0,0">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>

                            <!-- Fragment -->
                            <Button Grid.Column="0" Command="{Binding ToggleFragmentCommand}"
                                    Height="36" FontSize="11" FontWeight="Medium" Cursor="Hand" Margin="0,0,4,0"
                                    ToolTip="TLS_FRAGMENT&#x0a;Ð¤Ñ€Ð°Ð³Ð¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ ClientHello (Ð¾Ð±Ñ‹Ñ‡Ð½Ñ‹Ð¹ Ð¿Ð¾Ñ€ÑÐ´Ð¾Ðº)">
                                <Button.Style>
                                    <Style TargetType="Button" BasedOn="{StaticResource SecondaryButtonStyle}">
                                        <Setter Property="Content" Value="TLS_FRAGMENT"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding IsFragmentEnabled}" Value="True">
                                                <Setter Property="Background" Value="#3B82F6"/>
                                                <Setter Property="Foreground" Value="White"/>
                                                <Setter Property="BorderBrush" Value="#2563EB"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Button.Style>
                            </Button>

                            <!-- Disorder (Ñ„Ñ€Ð°Ð³Ð¼ÐµÐ½Ñ‚Ñ‹ Ð² Ð¾Ð±Ñ€Ð°Ñ‚Ð½Ð¾Ð¼ Ð¿Ð¾Ñ€ÑÐ´ÐºÐµ) -->
                            <Button Grid.Column="1" Command="{Binding ToggleDisorderCommand}"
                                    Height="36" FontSize="11" FontWeight="Medium" Cursor="Hand" Margin="0,0,4,0"
                                    ToolTip="TLS_DISORDER&#x0a;Ð¤Ñ€Ð°Ð³Ð¼ÐµÐ½Ñ‚Ñ‹ Ð² ÐžÐ‘Ð ÐÐ¢ÐÐžÐœ Ð¿Ð¾Ñ€ÑÐ´ÐºÐµ&#x0a;(ÑÐ½Ð°Ñ‡Ð°Ð»Ð° 2-Ð¹, Ð¿Ð¾Ñ‚Ð¾Ð¼ 1-Ð¹) â€” ÑÑ„Ñ„ÐµÐºÑ‚Ð¸Ð²Ð½ÐµÐµ Ð¿Ñ€Ð¾Ñ‚Ð¸Ð² DPI">
                                <Button.Style>
                                    <Style TargetType="Button" BasedOn="{StaticResource SecondaryButtonStyle}">
                                        <Setter Property="Content" Value="TLS_DISORDER"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding IsDisorderEnabled}" Value="True">
                                                <Setter Property="Background" Value="#8B5CF6"/>
                                                <Setter Property="Foreground" Value="White"/>
                                                <Setter Property="BorderBrush" Value="#7C3AED"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Button.Style>
                            </Button>

                            <!-- Fake -->
                            <Button Grid.Column="2" Command="{Binding ToggleFakeCommand}"
                                    Height="36" FontSize="11" FontWeight="Medium" Cursor="Hand" Margin="0,0,4,0"
                                    ToolTip="TLS_FAKE&#x0a;Fake TTL Ð¿Ð°ÐºÐµÑ‚ Ð´Ð»Ñ Ð¾Ð±Ñ…Ð¾Ð´Ð° active probing">
                                <Button.Style>
                                    <Style TargetType="Button" BasedOn="{StaticResource SecondaryButtonStyle}">
                                        <Setter Property="Content" Value="TLS_FAKE"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding IsFakeEnabled}" Value="True">
                                                <Setter Property="Background" Value="#3B82F6"/>
                                                <Setter Property="Foreground" Value="White"/>
                                                <Setter Property="BorderBrush" Value="#2563EB"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Button.Style>
                            </Button>

                            <!-- DROP RST -->
                            <Button Grid.Column="3" Command="{Binding ToggleDropRstCommand}"
                                    Height="36" FontSize="11" FontWeight="Medium" Cursor="Hand" Margin="0,0,4,0"
                                    ToolTip="DROP_RST&#x0a;Ð‘Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²ÐºÐ° TCP RST Ð¿Ð°ÐºÐµÑ‚Ð¾Ð² Ð¾Ñ‚ Ð¿Ñ€Ð¾Ð²Ð°Ð¹Ð´ÐµÑ€Ð°">
                                <Button.Style>
                                    <Style TargetType="Button" BasedOn="{StaticResource SecondaryButtonStyle}">
                                        <Setter Property="Content" Value="DROP_RST"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding IsDropRstEnabled}" Value="True">
                                                <Setter Property="Background" Value="#3B82F6"/>
                                                <Setter Property="Foreground" Value="White"/>
                                                <Setter Property="BorderBrush" Value="#2563EB"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Button.Style>
                            </Button>

                            <!-- DoH -->
                            <Button Grid.Column="4" Command="{Binding ToggleDoHCommand}"
                                    Height="36" FontSize="12" FontWeight="Medium" Cursor="Hand" Margin="0,0,8,0"
                                    ToolTip="DoH (DNS-over-HTTPS)&#x0a;Ð—Ð°Ñ‰Ð¸Ñ‚Ð° DNS (ÐŸÐšÐœ Ð´Ð»Ñ Ð²Ñ‹Ð±Ð¾Ñ€Ð° Ð¿Ñ€Ð¾Ð²Ð°Ð¹Ð´ÐµÑ€Ð°)">
                                <Button.Style>
                                    <Style TargetType="Button" BasedOn="{StaticResource SecondaryButtonStyle}">
                                        <Setter Property="Content" Value="ðŸ”’ DoH"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding IsDoHEnabled}" Value="True">
                                                <Setter Property="Background" Value="#3B82F6"/>
                                                <Setter Property="Foreground" Value="White"/>
                                                <Setter Property="BorderBrush" Value="#2563EB"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Button.Style>
                                <Button.ContextMenu>
                                    <ContextMenu ItemsSource="{Binding Bypass.AvailableDnsPresets}">
                                        <ContextMenu.ItemContainerStyle>
                                            <Style TargetType="MenuItem">
                                                <Setter Property="Header" Value="{Binding}"/>
                                                <Setter Property="Command" Value="{Binding DataContext.Bypass.SetDnsPresetCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}"/>
                                                <Setter Property="CommandParameter" Value="{Binding}"/>
                                                <Setter Property="IsChecked">
                                                    <Setter.Value>
                                                        <MultiBinding Converter="{StaticResource EqualityConverter}">
                                                            <Binding Path="DataContext.Bypass.SelectedDnsPreset" RelativeSource="{RelativeSource AncestorType=ContextMenu}"/>
                                                            <Binding Path="."/>
                                                        </MultiBinding>
                                                    </Setter.Value>
                                                </Setter>
                                            </Style>
                                        </ContextMenu.ItemContainerStyle>
                                    </ContextMenu>
                                </Button.ContextMenu>
                            </Button>

                            <!-- Ð’Ñ‹ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ Ð²ÑÑ‘ -->
                            <Button Grid.Column="5" Command="{Binding DisableAllBypassCommand}"
                                    Height="36" Width="80" FontSize="12" FontWeight="SemiBold" Cursor="Hand"
                                    ToolTip="ÐžÑ‚ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ Ð²ÑÐµ Ð¾Ð¿Ñ†Ð¸Ð¸ bypass">
                                <Button.Style>
                                    <Style TargetType="Button" BasedOn="{StaticResource SecondaryButtonStyle}">
                                        <Setter Property="Content" Value="âœ• Ð’Ñ‹ÐºÐ»"/>
                                        <Setter Property="Background" Value="#FEE2E2"/>
                                        <Setter Property="Foreground" Value="#DC2626"/>
                                        <Setter Property="BorderBrush" Value="#FECACA"/>
                                    </Style>
                                </Button.Style>
                            </Button>
                        </Grid>
                    </StackPanel>
                </Border>
            </StackPanel>
        </Border>

        <!-- Test Results -->
        <Border Grid.Row="2" 
                Style="{StaticResource CardStyle}" 
                Padding="0"
                AutomationProperties.AutomationId="TestResults">
            <Grid>
                <!-- Start State -->
                <StackPanel Visibility="{Binding IsStart, Converter={StaticResource BoolToVisibilityConverter}}"
                            VerticalAlignment="Center" 
                            HorizontalAlignment="Center"
                            Margin="16"
                            AutomationProperties.AutomationId="StartState">
                    <TextBlock Text="Ð“Ð¾Ñ‚Ð¾Ð² Ðº Ð´Ð¸Ð°Ð³Ð½Ð¾ÑÑ‚Ð¸ÐºÐµ" Style="{StaticResource H2Style}" 
                               Foreground="{StaticResource MutedBrush}" TextAlignment="Center"/>
                    <TextBlock Text="Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÑÑ†ÐµÐ½Ð°Ñ€Ð¸Ð¹ Ð¸ Ð½Ð°Ð¶Ð¼Ð¸Ñ‚Ðµ 'ÐÐ°Ñ‡Ð°Ñ‚ÑŒ Ð´Ð¸Ð°Ð³Ð½Ð¾ÑÑ‚Ð¸ÐºÑƒ'" 
                               Style="{StaticResource BodyStyle}"
                               Foreground="{StaticResource MutedBrush}"
                               TextAlignment="Center" Margin="0,4,0,0"/>
                </StackPanel>

                <!-- Active State (Running OR Done) -->
                <Grid Visibility="{Binding IsStart, Converter={StaticResource InverseBoolToVisibilityConverter}}">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <!-- Header (Running) -->
                        <RowDefinition Height="Auto"/>
                        <!-- Header (Done) -->
                        <RowDefinition Height="Auto"/>
                        <!-- Performance -->
                        <RowDefinition Height="*"/>
                        <!-- DataGrid -->
                    </Grid.RowDefinitions>

                    <!-- Running Header -->
                    <StackPanel Grid.Row="0" 
                                Visibility="{Binding IsRunning, Converter={StaticResource BoolToVisibilityConverter}}"
                                Margin="16,16,16,8">

                        <!-- Title Row with Badge -->
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                            <TextBlock Text="Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÑ‚ÑÑ Ð´Ð¸Ð°Ð³Ð½Ð¾ÑÑ‚Ð¸ÐºÐ°..." Style="{StaticResource H2Style}" VerticalAlignment="Center"/>

                            <!-- Bypass Badge - Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÑ‚ Ñ‡Ñ‚Ð¾ bypass Ð°ÐºÑ‚Ð¸Ð²ÐµÐ½ -->
                            <Border Background="#DCFCE7" BorderBrush="#86EFAC" BorderThickness="1" CornerRadius="4" Margin="12,0,0,0" Padding="6,2"
                                    VerticalAlignment="Center"
                                    Visibility="{Binding IsBypassActive, Converter={StaticResource BoolToVisibilityConverter}}">
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock Text="ðŸ›¡ï¸ Bypass Active" Foreground="#166534" FontWeight="SemiBold" FontSize="11"/>
                                </StackPanel>
                            </Border>
                        </StackPanel>

                        <TextBlock Text="{Binding CurrentAction}" 
                                   Foreground="{StaticResource MutedBrush}"
                                   FontSize="13"
                                   Margin="0,0,0,8"
                                   TextWrapping="Wrap"
                                   Visibility="{Binding CurrentAction, Converter={StaticResource StringToVisibilityConverter}}"/>
                        <ProgressBar IsIndeterminate="True"
                                     Height="2" 
                                     BorderThickness="0"
                                     Background="#E5E7EB"
                                     Foreground="{StaticResource PrimaryBrush}"/>

                        <!-- D2: Flow Stats -->
                        <StackPanel Orientation="Horizontal" Margin="0,8,0,0">
                            <TextBlock Text="ÐÐºÑ‚Ð¸Ð²Ð½Ð¾ÑÑ‚ÑŒ ÑÐµÑ‚Ð¸:" FontWeight="SemiBold" Margin="0,0,8,0" Foreground="#4B5563" FontSize="12"/>
                            <TextBlock Text="{Binding FlowModeText, StringFormat='Ð ÐµÐ¶Ð¸Ð¼: {0}'}" Margin="0,0,12,0" Foreground="#4B5563" FontWeight="Medium" FontSize="12"/>
                            <TextBlock Text="{Binding ConnectionsDiscovered, StringFormat='Ð¡Ð¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ð¹: {0}'}" Margin="0,0,12,0" Foreground="#374151" FontSize="12"/>
                            <TextBlock Text="{Binding FlowEventsCount, StringFormat='Ð¡Ð¾Ð±Ñ‹Ñ‚Ð¸Ð¹ Flow: {0}'}" Foreground="#6B7280" FontSize="12"/>
                        </StackPanel>
                    </StackPanel>

                    <!-- Done Header -->
                    <StackPanel Grid.Row="1" 
                                Visibility="{Binding IsDone, Converter={StaticResource BoolToVisibilityConverter}}"
                                Margin="16,16,16,8">
                        <Grid Margin="0,0,0,12">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>

                            <TextBlock Text="Ð”Ð¸Ð°Ð³Ð½Ð¾ÑÑ‚Ð¸ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°" Style="{StaticResource H2Style}"/>

                            <StackPanel Grid.Column="1" Orientation="Horizontal">
                                <Button Content="Ð­ÐºÑÐ¿Ð¾Ñ€Ñ‚ Ð¾Ñ‚Ñ‡ÐµÑ‚Ð°" 
                                        Style="{StaticResource SecondaryButtonStyle}"
                                        Command="{Binding ReportCommand}"
                                        Margin="0,0,8,0"
                                        Padding="10,4"
                                        FontSize="12"/>
                                <Button Content="ÐÐ¾Ð²Ð°Ñ Ð´Ð¸Ð°Ð³Ð½Ð¾ÑÑ‚Ð¸ÐºÐ°" 
                                        Style="{StaticResource PrimaryButtonStyle}"
                                        Command="{Binding SetStateCommand}"
                                        CommandParameter="start"
                                        Padding="10,4"
                                        FontSize="12"/>
                            </StackPanel>
                        </Grid>
                    </StackPanel>

                    <!-- Unified DataGrid -->
                    <DataGrid Grid.Row="3"
                              x:Name="ResultsGrid"
                              ItemsSource="{Binding TestResults}"
                              AutoGenerateColumns="False"
                              CanUserAddRows="False"
                              CanUserDeleteRows="False"
                              CanUserResizeRows="False"
                              IsReadOnly="True"
                              SelectionMode="Extended"
                              SelectionUnit="FullRow"
                              ClipboardCopyMode="IncludeHeader"
                              HeadersVisibility="Column"
                              GridLinesVisibility="Horizontal"
                              HorizontalGridLinesBrush="#E5E7EB"
                              VerticalGridLinesBrush="#E5E7EB"
                              Background="White"
                              BorderThickness="1"
                              BorderBrush="#E5E7EB"
                              RowBackground="White"
                              AlternatingRowBackground="#F9FAFB"
                              Padding="0"
                              FontSize="14"
                              HorizontalScrollBarVisibility="Disabled"
                              VerticalScrollBarVisibility="Auto"
                              AutomationProperties.AutomationId="TestResultsDataGrid">

                        <DataGrid.Resources>
                            <!-- Override Selection Colors to Light Blue so buttons and gray text are visible -->
                            <SolidColorBrush x:Key="{x:Static SystemColors.HighlightBrushKey}" Color="#DBEAFE"/>
                            <SolidColorBrush x:Key="{x:Static SystemColors.HighlightTextBrushKey}" Color="Black"/>
                            <SolidColorBrush x:Key="{x:Static SystemColors.InactiveSelectionHighlightBrushKey}" Color="#F3F4F6"/>
                            <SolidColorBrush x:Key="{x:Static SystemColors.InactiveSelectionHighlightTextBrushKey}" Color="Black"/>

                            <Style TargetType="DataGridColumnHeader">
                                <Setter Property="Padding" Value="8,6"/>
                                <Setter Property="Background" Value="#F3F4F6"/>
                                <Setter Property="FontWeight" Value="SemiBold"/>
                                <Setter Property="Foreground" Value="#374151"/>
                                <Setter Property="BorderThickness" Value="0,0,0,1"/>
                                <Setter Property="BorderBrush" Value="#E5E7EB"/>
                            </Style>

                            <Style TargetType="DataGridRow">
                                <Setter Property="MinHeight" Value="36"/>
                                <EventSetter Event="MouseDoubleClick" Handler="DataGridRow_MouseDoubleClick"/>
                                <Setter Property="ContextMenu" Value="{StaticResource RowContextMenu}"/>
                                <Style.Triggers>
                                    <Trigger Property="IsSelected" Value="True">
                                        <Setter Property="Background" Value="#DBEAFE"/>
                                    </Trigger>
                                </Style.Triggers>
                            </Style>

                            <Style TargetType="DataGridCell">
                                <Setter Property="Padding" Value="8,4"/>
                                <Setter Property="FocusVisualStyle" Value="{x:Null}"/>
                                <Setter Property="BorderThickness" Value="0"/>
                                <Setter Property="Template">
                                    <Setter.Value>
                                        <ControlTemplate TargetType="DataGridCell">
                                            <Border Padding="{TemplateBinding Padding}" 
                                                    BorderBrush="Transparent" 
                                                    BorderThickness="0" 
                                                    Background="{TemplateBinding Background}" 
                                                    SnapsToDevicePixels="True">
                                                <ContentPresenter SnapsToDevicePixels="{TemplateBinding SnapsToDevicePixels}"/>
                                            </Border>
                                        </ControlTemplate>
                                    </Setter.Value>
                                </Setter>
                            </Style>
                        </DataGrid.Resources>

                        <DataGrid.Columns>
                            <!-- Service Name -->
                            <DataGridTextColumn Header="Ð¡ÐµÑ€Ð²Ð¸Ñ" 
                                                Binding="{Binding Target.Name}" 
                                                Width="1.5*"
                                                MinWidth="120"
                                                FontWeight="SemiBold"/>

                            <!-- Host/IP -->
                            <DataGridTextColumn Header="Ð¥Ð¾ÑÑ‚ / IP" 
                                                Binding="{Binding Target.Host}" 
                                                Width="1*"
                                                MinWidth="100"/>

                            <!-- Status -->
                            <DataGridTemplateColumn Header="Ð¡Ñ‚Ð°Ñ‚ÑƒÑ" Width="1*" MinWidth="100">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <StackPanel Orientation="Horizontal">
                                            <local:StatusDot Status="{Binding Status}" Margin="0,0,6,0"/>
                                            <TextBlock Text="{Binding StatusText}" VerticalAlignment="Center" FontWeight="Medium"/>
                                        </StackPanel>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>

                            <!-- Details -->
                            <DataGridTextColumn Header="Ð”ÐµÑ‚Ð°Ð»Ð¸" 
                                                Binding="{Binding Details}" 
                                                Width="3*"
                                                MinWidth="200">
                                <DataGridTextColumn.ElementStyle>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="TextWrapping" Value="Wrap"/>
                                        <Setter Property="Padding" Value="8,4"/>
                                        <Setter Property="VerticalAlignment" Value="Center"/>
                                        <Setter Property="FontSize" Value="12"/>
                                        <Setter Property="Foreground" Value="#4B5563"/>
                                    </Style>
                                </DataGridTextColumn.ElementStyle>
                            </DataGridTextColumn>

                            <!-- Strategy -->
                            <DataGridTextColumn Header="Ð¡Ñ‚Ñ€Ð°Ñ‚ÐµÐ³Ð¸Ñ" 
                                                Binding="{Binding BypassStrategy}" 
                                                Width="1.2*"
                                                MinWidth="110">
                                <DataGridTextColumn.ElementStyle>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="VerticalAlignment" Value="Center"/>
                                        <Setter Property="Padding" Value="8,4"/>
                                        <Setter Property="Foreground" Value="#6B7280"/>
                                        <Setter Property="FontWeight" Value="Medium"/>
                                        <Setter Property="FontSize" Value="12"/>
                                    </Style>
                                </DataGridTextColumn.ElementStyle>
                            </DataGridTextColumn>
                        </DataGrid.Columns>
                    </DataGrid>
                </Grid>
            </Grid>
        </Border>



        <!-- Footer: User Communication Area -->
        <Border Grid.Row="3" 
                Background="#F3F4F6" 
                CornerRadius="6" 
                Padding="12,8" 
                Margin="0,8,0,0">
            <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                <TextBlock Text="â„¹ï¸" Margin="0,0,8,0" VerticalAlignment="Center"/>
                <TextBlock Text="{Binding UserMessage}" 
                           Style="{StaticResource BodyStyle}"
                           FontWeight="Medium"
                           Foreground="#374151"
                           VerticalAlignment="Center"
                           TextTrimming="CharacterEllipsis"/>
            </StackPanel>
        </Border>
    </Grid>
</Window>
