# План исправления проблем ISP_Audit

**Дата составления:** 2025-10-29  
**Автор:** Planning Agent (Claude Sonnet 4.5)  
**Бюджет времени:** ~7 часов (~170k токенов)

---

## Executive Summary

На основе аудита выявлено **14 проблем** различной критичности. План сфокусирован на исправлении критичных и высокоприоритетных проблем, которые напрямую влияют на корректность диагностики для пользователей.

**Ключевые фокусные области:**
1. Улучшение точности DNS-диагностики (устранение ложных срабатываний в корпоративных сетях)
2. Правильная интерпретация TCP-статусов (разделение портал vs лаунчер)
3. Добавление валидации TLS-сертификатов для детекции MITM
4. Исправление UDP-тестов (корректная интерпретация результатов)
5. Оптимизация производительности (параллельные TCP-проверки)

**Исключено из плана:** Traceroute и RST Heuristic (правильно отключены по умолчанию, низкая ценность для пользователей)

---

## Оценка времени и токенов

| Категория | Количество задач | Время (ч) | Токены |
|-----------|------------------|-----------|--------|
| **CRITICAL** | 4 | 3.0 | ~72k |
| **HIGH** | 4 | 2.5 | ~60k |
| **MEDIUM** | 3 | 1.5 | ~36k |
| **Тестирование** | - | 1.0 | ~24k |
| **ИТОГО** | 11 | **8.0** | **~192k** |

**Примечание:** План немного превышает бюджет (8 vs 7 часов). Рекомендуется начать с CRITICAL и HIGH задач, MEDIUM можно отложить на следующую сессию если времени не хватит.

---

## Приоритет 1: Смягчение эвристики RFC1918 в DNS Test

**Критичность**: CRITICAL  
**Затраты времени**: 0.5 часа  
**Затраты токенов**: ~12k

### Проблема
DNS Test помечает RFC1918 адреса (10.x, 172.16-31.x, 192.168.x) как DNS_BOGUS, что вызывает ложные срабатывания в корпоративных сетях. Пользователи за корпоративным NAT/прокси получают ошибочную диагностику блокировки.

### Решение
1. Изменить NetUtils.IsBogusIPv4() - проверять только реально мусорные диапазоны:
   - 0.0.0.0/8 (invalid)
   - 127.0.0.0/8 (loopback)
   - 169.254.0.0/16 (link-local)
   - 224.0.0.0/4 (multicast)
   - 240.0.0.0/4 (reserved)

2. RFC1918 адреса (10.x, 172.16-31.x, 192.168.x) должны вызывать WARN, а не BOGUS:
   - Добавить новый метод NetUtils.IsPrivateIPv4() для RFC1918
   - Обновить логику в DnsTest.ResolveAsync():
     - Если System DNS возвращает только private IP, а DoH - публичные → DNS_WARN (не BOGUS)
     - Добавить примечание в отчёт: "Возможно, вы за корпоративным прокси"

### Файлы для изменения
- Utils/NetUtils.cs (строки 62-77) - обновить IsBogusIPv4(), добавить IsPrivateIPv4()
- Tests/DnsTest.cs (строки 32-48) - улучшить логику определения статуса

### Критерии готовности
- [ ] IsBogusIPv4() не проверяет RFC1918
- [ ] Добавлен метод IsPrivateIPv4()
- [ ] DNS Test возвращает WARN для private IP (не BOGUS)
- [ ] Отчёт содержит пояснение про корпоративный прокси
- [ ] Ручной тест: 10.0.0.1 → WARN, 127.0.0.1 → BOGUS

### Риски
- Низкий. Изменение только эвристики, основная логика не затронута.

## Приоритет 2: Разделение TCP-статусов на группы портов

**Критичность**: CRITICAL  
**Затраты времени**: 1.0 час  
**Затраты токенов**: ~24k

### Проблема
TCP Test показывает SUCCESS если хотя бы один порт открыт. Но для Star Citizen требуются ВСЕ порты 8000-8020 + 443.

### Решение
Разделить порты на группы (Portal: 80/443, Launcher: 8000-8020). Добавить tcp_portal и tcp_launcher в Summary. Обновить GUI и рекомендации.

### Файлы
- Output/ReportWriter.cs (строки 29-36, 85-230)
- MainWindow.xaml.cs, Wpf/ServiceItemViewModel.cs

### Критерии
- [ ] Summary содержит tcp_portal и tcp_launcher
- [ ] GUI показывает два статуса
- [ ] Тест: только 443 → portal=OK, launcher=FAIL

### Риски
Средний. Изменения в GUI и отчётах.

---

## Приоритет 3: Валидация TLS-сертификатов

**Критичность**: CRITICAL  
**Затраты времени**: 0.75 часа  
**Затраты токенов**: ~18k

### Проблема
HTTP Test НЕ валидирует CN. MITM-атаки не детектируются.

### Решение
Добавить ValidateCertificateCN() с поддержкой wildcard. Добавить HttpResult.cert_cn_matches. Обновить BuildSummary() для детекции MITM.

### Файлы
- Tests/HttpTest.cs (строки 10, 30-54)
- Output/ReportWriter.cs (строки 128-152, 211-221)

### Критерии
- [ ] ValidateCertificateCN() обрабатывает wildcard
- [ ] BuildSummary() различает DPI vs MITM
- [ ] Тест: прокси → MITM_SUSPECT

### Риски
Средний. Wildcard требует внимания.

---

## Приоритет 4: Исправление UDP Raw Probe

**Критичность**: CRITICAL  
**Затраты времени**: 0.75 часа  
**Затраты токенов**: ~18k

### Проблема
UDP Raw Probe показывает success=true даже если пакет дропается.

### Решение
Добавить поле certainty. ExpectReply=false → certainty=low. BuildSummary(): certainty=low → INFO.

### Файлы
- Output/UdpProbeResult.cs
- Tests/UdpProbeRunner.cs (строки 121-128)
- Output/ReportWriter.cs (строки 113-126, 201-209)

### Критерии
- [ ] certainty=low для raw probe
- [ ] summary.udp = INFO

### Риски
Низкий.

---

## Приоритет 5: DoH Retry на все ошибки

**Критичность**: HIGH  
**Затраты времени**: 0.5 часа  
**Затраты токенов**: ~12k

### Проблема
DoH retry только при timeout.

### Решение
Retry на TaskCanceledException, HttpRequestException, SocketException.

### Файлы
- Tests/DnsTest.cs (строки 58-96)

### Критерии
- [ ] Retry на все сетевые ошибки
- [ ] Максимум 2 попытки, 250ms задержка

### Риски
Низкий.

---

## Приоритет 6: Параллельные TCP-проверки

**Критичность**: HIGH  
**Затраты времени**: 0.75 часа  
**Затраты токенов**: ~18k

### Проблема
TCP последовательно (3-4 минуты).

### Решение
Task.WhenAll() + SemaphoreSlim(10).

### Файлы
- Tests/TcpTest.cs (строки 18-66)

### Критерии
- [ ] Параллельные проверки
- [ ] Concurrency = 10
- [ ] Время < 30 сек

### Риски
Средний. Тестировать на разных сетях.

---

## Приоритет 7: Парсинг DNS probe (RCODE, ID)

**Критичность**: HIGH  
**Затраты времени**: 0.5 часа  
**Затраты токенов**: ~12k

### Проблема
DNS probe не парсит RCODE и ID.

### Решение
Проверять ID и RCODE=0.

### Файлы
- Tests/UdpProbeRunner.cs (строки 25-74, 201-228)

### Критерии
- [ ] Проверка ID и RCODE
- [ ] Только RCODE=0 → успех

### Риски
Низкий.

---

## Приоритет 8: HTTP-таймаут 6 сек

**Критичность**: HIGH  
**Затраты времени**: 0.25 часа  
**Затраты токенов**: ~6k

### Проблема
HTTP-таймаут 12 сек избыточен.

### Решение
HttpTimeoutSeconds = 6.

### Файлы
- Config.cs, CLAUDE.md

### Критерии
- [ ] HttpTimeoutSeconds = 6

### Риски
Низкий.

---

## Приоритет 9: Детекция HTML-заглушек

**Критичность**: MEDIUM  
**Затраты времени**: 0.5 часа  
**Затраты токенов**: ~12k

### Проблема
Провайдер может возвращать 200 OK с заглушкой.

### Решение
DetectBlockPage() - ищет "заблокирован", "blocked", "РКН".

### Файлы
- Tests/HttpTest.cs (строки 10, 18-58)
- Output/ReportWriter.cs (строки 128-152)

### Критерии
- [ ] DetectBlockPage() работает

### Риски
Средний. Ложные срабатывания.

---

## Приоритет 10: DNS WARN (CDN vs подмена)

**Критичность**: MEDIUM  
**Затраты времени**: 0.75 часа  
**Затраты токенов**: ~18k

### Проблема
WARN не различает CDN и подмену.

### Решение
CompareIPOwnership() - эвристика /16.

### Файлы
- Tests/DnsTest.cs (строки 12, 26-48)
- Output/ReportWriter.cs (строки 172-180)

### Критерии
- [ ] WARN_CDN и WARN_SUSPECT

### Риски
Средний.

---

## Приоритет 11: UDP DNS таймаут 2 сек

**Критичность**: MEDIUM  
**Затраты времени**: 0.25 часа  
**Затраты токенов**: ~6k

### Проблема
UDP DNS таймаут 3 сек избыточен.

### Решение
UdpDnsTimeoutSeconds = 2.

### Файлы
- Config.cs
- Tests/UdpProbeRunner.cs (строки 40-48)

### Критерии
- [ ] UdpDnsTimeoutSeconds = 2

### Риски
Низкий.

---

## Отложенные задачи (LOW Priority)

1. **Traceroute кодировка OEM866** - только для русской локали
2. **RST Heuristic интерпретация** - результат не используется
3. **Различение TCP-отказа** - refused vs timeout

---

## План тестирования

### Этап 1: Unit-тесты
1. DNS: IsBogusIPv4, IsPrivateIPv4
2. TCP: группы портов, параллель
3. HTTP: ValidateCertificateCN, DetectBlockPage
4. UDP: certainty, RCODE, ID

### Этап 2: Интеграционные тесты
1. Чистая сеть (все OK)
2. Корпсеть (private IP, MITM)
3. ISP блокировка (DNS_FILTERED, DPI)
4. Частичная блокировка (порты лаунчера)

### Этап 3: Производительность
1. TCP 69 портов < 30 сек
2. Общее время < 1 минута

### Этап 4: Обратная совместимость
1. Старые JSON читаются
2. Новые JSON с новыми полями

---

## Риски

1. **Превышение бюджета** - начать с CRITICAL
2. **Breaking changes** - обработка null
3. **Ложные срабатывания** - тестирование
4. **Производительность** - concurrency = 10

---

## Порядок выполнения

**Чекпоинт 1** (2ч): DNS оптимизация
1. Приоритет 1 (DNS RFC1918) - 0.5ч
2. Приоритет 5 (DoH retry) - 0.5ч
3. Приоритет 8 (HTTP timeout) - 0.25ч
4. Приоритет 11 (UDP timeout) - 0.25ч
5. Тестирование - 0.5ч

**Чекпоинт 2** (3.5ч): UDP исправления
6. Приоритет 4 (UDP Raw) - 0.75ч
7. Приоритет 7 (UDP DNS) - 0.5ч
8. Тестирование - 0.25ч

**Чекпоинт 3** (5ч): HTTP/TLS улучшения
9. Приоритет 3 (TLS CN) - 0.75ч
10. Приоритет 9 (Block page) - 0.5ч
11. Тестирование - 0.25ч

**Чекпоинт 4** (7ч): TCP оптимизация
12. Приоритет 2 (TCP группы) - 1.0ч
13. Приоритет 6 (TCP параллель) - 0.75ч
14. Тестирование - 0.25ч

**Опционально** (8.25ч):
15. Приоритет 10 (DNS WARN) - 0.75ч
16. Финальное тестирование - 0.5ч

---

## Заключение

План покрывает **11 из 14 проблем** (CRITICAL + HIGH приоритет).

**Результат:**
- Устранение ложных срабатываний в корпсетях
- Детекция MITM и заглушек
- Понятные рекомендации (портал vs лаунчер)
- Ускорение диагностики в 3-4 раза

**Следующие шаги:**
1. Начать с приоритета 1
2. Коммит после каждого чекпоинта
3. После 7ч оценить остаток времени
4. Приоритет 10 - если есть время
