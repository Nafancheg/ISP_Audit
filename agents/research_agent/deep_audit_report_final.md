# Глубокий аудит проекта ISP_Audit

**Дата:** 9 декабря 2025 г.
**Статус:** Завершен
**Вердикт:** Проект содержит критические ошибки, блокирующие заявленный функционал (CLI), и архитектурные несоответствия документации.

---

## 1. Критические ошибки (Critical Bugs)

### 1.1. Нерабочий CLI режим
**Файл:** `Program.cs`
**Проблема:** В методе `Main` полностью отсутствует логика обработки аргументов командной строки. Приложение **всегда** запускается в GUI режиме (`new App().Run()`), игнорируя переданные флаги (`--targets`, `--report`).
**Последствия:** Невозможность использования в скриптах и headless-режиме.
**Код:**
```csharp
// Текущая реализация
private static int Main(string[] args)
{
    Config.SetActiveProfile("Default");
    var app = new App(); // Всегда GUI
    app.Run();
    return 0;
}
```

### 1.2. Блокировка потоков (Deadlocks)
**Файл:** `Tests/UdpProbeRunner.cs` (строки 51, 105)
**Проблема:** Использование `.Result` для ожидания асинхронной задачи (`receiveTask.Result`).
**Последствия:** В GUI приложении это приводит к **Deadlock** (зависанию интерфейса), так как контекст синхронизации WPF блокируется ожиданием завершения задачи, которая пытается вернуться в этот же контекст.

### 1.3. Опасный `async void`
**Файлы:**
- `ViewModels/MainViewModelRefactored.cs`: `CheckAndRetestFailedTargets`
- `ViewModels/BypassController.cs`: `InitializeOnStartupAsync`
**Проблема:** Использование `async void` вне обработчиков событий UI.
**Последствия:** Исключения в этих методах невозможно перехватить, они приведут к **аварийному завершению процесса** (Crash).

---

## 2. Архитектурные несоответствия и Code Smells

### 2.1. Отсутствие Material Design
**Файл:** `App.xaml`, `ISP_Audit.csproj`
**Проблема:** В документации (`copilot-instructions.md`) заявлено использование `MaterialDesignInXaml 5.1.0`. По факту библиотека **отсутствует** в зависимостях `.csproj`, а в `App.xaml` используются самописные стили.
**Риск:** Введение в заблуждение разработчиков и агентов, пытающихся использовать компоненты Material Design (Card, Button, Icon), которых нет.

### 2.2. "Временный" рефакторинг
**Файл:** `ViewModels/MainViewModelRefactored.cs`
**Проблема:** Основная ViewModel имеет суффикс `Refactored`, что указывает на незавершенный процесс миграции. Старый файл `MainViewModel.cs` отсутствует (удален), но имя класса не нормализовано.
**Риск:** Путаница в навигации по коду.

### 2.3. Логирование в ViewModel
**Файл:** `ViewModels/MainViewModelRefactored.cs`
**Проблема:** Логика ротации лог-файлов и записи реализована прямо внутри ViewModel.
**Принцип:** Нарушение Single Responsibility Principle (SRP). Логирование должно быть вынесено в сервис (`ILogger` или свой `LogService`).

### 2.4. Устаревшие методы синхронизации
**Файлы:** `Utils/NetworkMonitorService.cs`, `Utils/ConnectionMonitorService.cs`
**Проблема:** Использование `Thread.Sleep(50)` внутри циклов мониторинга.
**Решение:** Заменить на `await Task.Delay(50)` для освобождения потока пула.

---

## 3. Неиспользуемые артефакты и странности

### 3.1. `todo_detect.md`
Файл описывает планы по улучшению детекции, но ссылается на классы (`StandardHostTester`), которые требуют проверки на актуальность.

### 3.2. Отсутствие DI контейнера
В `Program.cs` нет настройки Dependency Injection. Сервисы создаются вручную или статически. Для приложения такого масштаба (с сервисами, ViewModels, конфигами) это усложняет тестирование и поддержку.

---

## 4. План исправлений (Recommendations)

1.  **Fix CLI:** Восстановить логику разбора аргументов в `Program.cs` (проверка `args.Length > 0`).
2.  **Fix Async:** Заменить `.Result` на `await` в `UdpProbeRunner.cs`.
3.  **Fix Crash:** Заменить `async void` на `async Task` и добавить `try-catch` (или вызывать через `SafeFireAndForget`).
4.  **Cleanup:** Переименовать `MainViewModelRefactored` -> `MainViewModel`.
5.  **Docs:** Обновить документацию, убрав упоминание `MaterialDesignInXaml`, либо добавить пакет.
6.  **Refactor:** Заменить `Thread.Sleep` на `Task.Delay`.
