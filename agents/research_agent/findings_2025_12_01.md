# Research Agent Findings ‚Äî ISP_Audit Architecture Analysis

**–î–∞—Ç–∞:** 01.12.2025  
**–ò—Å—Ç–æ—á–Ω–∏–∫:** `ARCHITECTURE_CURRENT.md`  
**–¶–µ–ª—å:** –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞

---

## –ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ —Ñ–∞–π–ª—ã

### üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï (—Ç—Ä–µ–±—É—é—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏/—Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞)

| –§–∞–π–ª | –†–æ–ª—å | –°–æ—Å—Ç–æ—è–Ω–∏–µ | –î–µ–π—Å—Ç–≤–∏–µ |
|------|------|-----------|----------|
| `Bypass/BypassCoordinator.cs` | –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä –∞–≤—Ç–æ-–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ | ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω, ‚ùå –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è | **–ò–ù–¢–ï–ì–†–ò–†–û–í–ê–¢–¨** |
| `Core/Modules/WinDivertBypassEnforcer.cs` | –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ bypass-—Å—Ç—Ä–∞—Ç–µ–≥–∏–π —Å —Ä–µ—Ç–µ—Å—Ç–æ–º | ‚úÖ –°–æ–∑–¥–∞—ë—Ç—Å—è, ‚ùå –ù–ï –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è | **–ò–°–ü–û–õ–¨–ó–û–í–ê–¢–¨** |
| `Utils/LiveTestingPipeline.cs` | Pipeline —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ö–æ—Å—Ç–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ | ‚ö†Ô∏è Pipeline –Ω–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç bypass | **–†–ï–§–ê–ö–¢–û–†–ò–ù–ì** |
| `Utils/TrafficAnalyzer.cs` | –°–±–æ—Ä —Ç—Ä–∞—Ñ–∏–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞ | ‚ö†Ô∏è –°–æ–∑–¥–∞—ë—Ç pipeline –≤–Ω—É—Ç—Ä–∏ —Å–µ–±—è | **–†–ï–§–ê–ö–¢–û–†–ò–ù–ì** |
| `Utils/FlowMonitorService.cs` | –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π (Flow/Socket/Polling) | ‚ö†Ô∏è Socket Layer –º—ë—Ä—Ç–≤ –ø—Ä–∏ AutoBypass=true | **–í–ö–õ–Æ–ß–ò–¢–¨ Socket** |

### üü° –ú–Å–†–¢–í–´–ô –ö–û–î (—É–¥–∞–ª–∏—Ç—å)

| –§–∞–π–ª | –†–æ–ª—å | –ü—Ä–∏—á–∏–Ω–∞ —É–¥–∞–ª–µ–Ω–∏—è |
|------|------|------------------|
| `Models/FixHistory.cs` | Persistence –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π | UI –æ—Ç–∫–∞—Ç —É–¥–∞–ª—ë–Ω, –∫–æ–¥ –æ—Å—Ç–∞–ª—Å—è |
| `AuditRunner.cs` | CLI –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä | Legacy CLI –∫–æ–¥ |
| `Config.cs` ‚Üí `ParseArgs()` | CLI –ø–∞—Ä—Å–µ—Ä –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ | Legacy CLI –∫–æ–¥ |
| `Program.cs` ‚Üí `RunCliAsync()` | CLI —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã | Legacy CLI –∫–æ–¥ |
| `Output/` (–≤—Å—è –ø–∞–ø–∫–∞) | CLI –æ—Ç—á—ë—Ç—ã | Legacy CLI –∫–æ–¥ |

### üü¢ –ö–õ–Æ–ß–ï–í–´–ï –§–ê–ô–õ–´ (–Ω–µ —Ç—Ä–µ–±—É—é—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–∞–ø—Ä—è–º—É—é, –Ω–æ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏)

| –§–∞–π–ª | –†–æ–ª—å |
|------|------|
| `Bypass/WinDivertBypassManager.cs` | –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ WinDivert (RST blocker, TLS fragmenter) |
| `Bypass/StrategyMapping.cs` | –ú–∞–ø–ø–∏–Ω–≥ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ ‚Üí —Å—Ç—Ä–∞—Ç–µ–≥–∏–π |
| `Core/Modules/StandardHostTester.cs` | –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ TCP/TLS —Ö–æ—Å—Ç–æ–≤ |
| `Core/Modules/StandardBlockageClassifier.cs` | –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è —Ç–∏–ø–æ–≤ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ |
| `ViewModels/MainViewModel.cs` | –ì–ª–∞–≤–Ω–∞—è ViewModel GUI (~2400 —Å—Ç—Ä–æ–∫) |
| `Core/Models/PipelineModels.cs` | –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è pipeline |

---

## –¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

### –ü—Ä–æ–±–ª–µ–º–∞ #1: Bypass –ù–ï –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏

**–¢–µ–∫—É—â–∏–π flow:**
```
TrafficAnalyzer.AnalyzeProcessTrafficAsync()
    ‚îî‚îÄ –°–æ–∑–¥–∞—ë—Ç LiveTestingPipeline
        ‚îî‚îÄ TesterWorker: —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç —Ö–æ—Å—Ç—ã
        ‚îî‚îÄ ClassifierWorker: –∫–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏, –≤—ã–±–∏—Ä–∞–µ—Ç —Å—Ç—Ä–∞—Ç–µ–≥–∏—é
        ‚îî‚îÄ UiWorker: –¢–û–õ–¨–ö–û –ª–æ–≥–∏—Ä—É–µ—Ç "–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è: X"
            ‚îî‚îÄ ‚ùå BYPASS –ù–ï –ü–†–ò–ú–ï–ù–Ø–ï–¢–°–Ø!
```

**–ü—Ä–æ–±–ª–µ–º–Ω—ã–π –∫–æ–¥ (`LiveTestingPipeline.cs`, —Å—Ç—Ä–æ–∫–∞ ~50):**
```csharp
// –°–æ–∑–¥–∞—ë—Ç—Å—è, –Ω–æ –ù–ò–ö–û–ì–î–ê –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è:
_bypassEnforcer = new WinDivertBypassEnforcer(_bypassManager, _tester, progress);
```

**–ü—Ä–æ–±–ª–µ–º–Ω—ã–π –∫–æ–¥ (`LiveTestingPipeline.cs`, UiWorker):**
```csharp
// –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ–±—ä—è—Å–Ω—è–µ—Ç –ü–û–ß–ï–ú–£ –Ω–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è:
// ‚ö†Ô∏è –ù–ï –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º bypass –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏!
// Bypass (TLS_DISORDER + DROP_RST) —É–∂–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ.
// –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–π –ª–æ–º–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—é—â–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è,
// —Ç.–∫. bypass –≥–ª–æ–±–∞–ª—å–Ω—ã–π, –∞ —Ç–µ—Å—Ç—ã –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ.
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ï—Å–ª–∏ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –≤–∫–ª—é—á—ë–Ω–Ω—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ (Fragment + DROP_RST) –Ω–µ –ø–æ–¥—Ö–æ–¥—è—Ç –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ö–æ—Å—Ç–∞ ‚Äî —Å–∞–π—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç "–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: Disorder", –Ω–æ –Ω–∏—á–µ–≥–æ –Ω–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è.

---

### –ü—Ä–æ–±–ª–µ–º–∞ #2: –î–µ—Ç–µ–∫—Ü–∏—è –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ –ø—Ä–∏–º–∏—Ç–∏–≤–Ω–∞—è

**`StandardHostTester.cs` ‚Äî —Ç–µ–∫—É—â–∞—è –¥–µ—Ç–µ–∫—Ü–∏—è:**
```csharp
// –¢–æ–ª—å–∫–æ socket exceptions –∏ fixed timeout 3—Å–µ–∫
catch (SocketException ex) {
    if (ex.SocketErrorCode == ConnectionReset) blockageType = "TCP_RST";
}
var completedTask = await Task.WhenAny(connectTask, Task.Delay(3000));
```

**–ß—Ç–æ –ù–ï –¥–µ—Ç–µ–∫—Ç–∏—Ä—É–µ—Ç—Å—è (–Ω–æ –¥–æ–ª–∂–Ω–æ –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å Zapret):**
1. **TCP Retransmissions** ‚Äî –≥–ª–∞–≤–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä DPI (–∫–ª–∏–µ–Ω—Ç –ø–µ—Ä–µ–æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å—ã)
2. **HTTP redirect –Ω–∞ DPI-–∑–∞–≥–ª—É—à–∫—É** ‚Äî —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ –¥—Ä—É–≥–æ–π –¥–æ–º–µ–Ω
3. **RST packet inspection** ‚Äî –∞–Ω–∞–ª–∏–∑ —Å–∞–º–∏—Ö RST –ø–∞–∫–µ—Ç–æ–≤ (TTL, timing)
4. **Fail counter —Å time window** ‚Äî N —Ñ–µ–π–ª–æ–≤ –∑–∞ M —Å–µ–∫—É–Ω–¥ = –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞

---

### –ü—Ä–æ–±–ª–µ–º–∞ #3: FlowMonitorService ‚Äî Socket Layer –º—ë—Ä—Ç–≤

**`FlowMonitorService.cs` ‚Äî –¥–≤–∞ —Ä–µ–∂–∏–º–∞:**
1. **WinDivert (Socket/Flow)** ‚Äî —Å–æ–±—ã—Ç–∏–π–Ω—ã–π, —Ç–æ—á–Ω—ã–π ‚úÖ
2. **IP Helper API polling** ‚Äî –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É, –º–µ–Ω–µ–µ —Ç–æ—á–Ω—ã–π ‚ùå

**–ü—Ä–æ–±–ª–µ–º–∞:**
```csharp
// –ü—Ä–∏ AutoBypass=true (—É–º–æ–ª—á–∞–Ω–∏–µ) –í–°–ï–ì–î–ê UseWatcherMode=true
if (UseWatcherMode)
{
    _monitorTask = Task.Run(() => RunWatcherLoop(_cts.Token), _cts.Token);
}
else
{
    _monitorTask = Task.Run(() => RunMonitorLoop(_cts.Token), _cts.Token);
    _socketMonitorTask = Task.Run(() => RunSocketMonitorLoop(_cts.Token), _cts.Token);
}
```

**–ö–ª—é—á–µ–≤–æ–µ –æ—Ç–∫—Ä—ã—Ç–∏–µ:** `Sniff` —Ñ–ª–∞–≥ –ù–ï –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É–µ—Ç —Å bypass `None` —Ñ–ª–∞–≥–æ–º ‚Äî –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ!

---

### –ü—Ä–æ–±–ª–µ–º–∞ #4: –ú—ë—Ä—Ç–≤—ã–π –∫–æ–¥ (~30%)

**`MainViewModel.cs` ‚Äî –º—ë—Ä—Ç–≤—ã–π –∫–æ–¥ fix history:**
```csharp
public ObservableCollection<AppliedFix> ActiveFixes { get; set; } = new();
public bool HasActiveFixes => ActiveFixes.Count > 0;
public ICommand RollbackFixCommand { get; }
// ... LoadFixHistory(), RollbackFixAsync(), RollbackAllFixesAsync()
```

**`AuditRunner.cs` ‚Äî CLI –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä:**
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `BypassCoordinator` –ø—Ä–∞–≤–∏–ª—å–Ω–æ (–≤ –æ—Ç–ª–∏—á–∏–µ –æ—Ç GUI!)
- –ù–æ –≤–µ—Å—å CLI –∫–æ–¥ –ø–æ–º–µ—á–µ–Ω –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ

**`Config.ParseArgs()` ‚Äî CLI –ø–∞—Ä—Å–µ—Ä:**
- ~200 —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è CLI

---

## –†–∏—Å–∫–∏ –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

### üî¥ –í–´–°–û–ö–ò–ô –†–ò–°–ö

1. **–ì–ª–æ–±–∞–ª—å–Ω—ã–π bypass –ª–æ–º–∞–µ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã**
   - `WinDivertBypassManager` –ø—Ä–∏–º–µ–Ω—è–µ—Ç —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –ì–õ–û–ë–ê–õ–¨–ù–û (–≤—Å–µ HTTPS)
   - –ï—Å–ª–∏ –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –≤–æ –≤—Ä–µ–º—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è ‚Äî —Å–ª–æ–º–∞–µ—Ç —É–∂–µ —Ä–∞–±–æ—Ç–∞—é—â–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
   - **–†–µ—à–µ–Ω–∏–µ:** –û—á–µ—Ä–µ–¥—å —Å—Ç—Ä–∞—Ç–µ–≥–∏–π, –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–µ–∂–¥—É —Ç–µ—Å—Ç–∞–º–∏

2. **Socket Layer –º–æ–∂–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤–∞—Ç—å —Å RST blocker**
   - –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤ –∫–æ–¥–µ: "RST blocker –º–æ–∂–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤–∞—Ç—å —Å TrafficAnalyzer Flow layer"
   - –ù–æ `Sniff` —Ñ–ª–∞–≥ —Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏ –±–µ–∑–æ–ø–∞—Å–µ–Ω
   - **–†–∏—Å–∫:** –ù—É–∂–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–¥ –≤–∫–ª—é—á–µ–Ω–∏–µ–º

3. **–£–¥–∞–ª–µ–Ω–∏–µ CLI –∫–æ–¥–∞ —Å–ª–æ–º–∞–µ—Ç AuditRunner**
   - `AuditRunner.RunAsync()` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¢–û–õ–¨–ö–û –∏–∑ CLI (`Program.RunCliAsync()`)
   - –ù–æ `BypassCoordinator` –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Ç–∞–º –ü–†–ê–í–ò–õ–¨–ù–ê–Ø!
   - **–†–∏—Å–∫:** –ú–æ–∂–Ω–æ –ø–æ—Ç–µ—Ä—è—Ç—å —Ä–∞–±–æ—á—É—é –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏

### üü° –°–†–ï–î–ù–ò–ô –†–ò–°–ö

4. **WinDivertBypassEnforcer ‚Äî —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∞—è –≥–ª–æ–±–∞–ª—å–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è**
   ```csharp
   private static string? _globalWorkingStrategy;
   ```
   - –û–¥–Ω–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –Ω–∞ –≤—Å–µ —Ö–æ—Å—Ç—ã ‚Äî –º–æ–∂–µ—Ç –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç—å
   - **–†–∏—Å–∫:** –ù—É–∂–µ–Ω per-host –∫–µ—à (–∫–∞–∫ –≤ `BypassCoordinator`)

5. **StrategyMapping ‚Äî –∂—ë—Å—Ç–∫–∞—è –ª–æ–≥–∏–∫–∞**
   - –°—Ç—Ä–∞—Ç–µ–≥–∏–∏ –æ–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è –ø–æ –ø—Ä–æ—Å—Ç—ã–º –ø—Ä–∞–≤–∏–ª–∞–º (TCP OK/TLS FAIL ‚Üí TLS_FRAGMENT)
   - –ù–µ—Ç –∞–¥–∞–ø—Ç–∞—Ü–∏–∏ –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º —Ä–µ—Ç–µ—Å—Ç–æ–≤
   - **–†–∏—Å–∫:** –ù–µ–æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –≤—ã–±–æ—Ä —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏

### üü¢ –ù–ò–ó–ö–ò–ô –†–ò–°–ö

6. **–£–¥–∞–ª–µ–Ω–∏–µ FixHistory**
   - –§–∞–π–ª `fix_history.json` –≤ AppData
   - –ù–∏–∫—Ç–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç (UI –∫–Ω–æ–ø–∫–∏ —É–¥–∞–ª–µ–Ω—ã)
   - **–†–∏—Å–∫:** –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π, –º–æ–∂–Ω–æ —É–¥–∞–ª—è—Ç—å

7. **–£–¥–∞–ª–µ–Ω–∏–µ Output/**
   - CLI-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –∫–ª–∞—Å—Å—ã —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
   - GUI –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–≤–æ–∏ –º–æ–¥–µ–ª–∏
   - **–†–∏—Å–∫:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –Ω–µ—Ç –ø–µ—Ä–µ–∫—Ä—ë—Å—Ç–Ω—ã—Ö —Å—Å—ã–ª–æ–∫

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∫–ª—é—á–µ–≤—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

### BypassCoordinator (–≥–æ—Ç–æ–≤ –∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏)

```csharp
public class BypassCoordinator
{
    private readonly WinDivertBypassManager _manager;
    private readonly Dictionary<string, string> _workingStrategies = new(); // Host ‚Üí Strategy CACHE

    // –ì–ª–∞–≤–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è GUI:
    public async Task<FixResult> AutoFixLiveAsync(
        HostTested initialResult,
        Func<HostTested, Task<HostTested>> retestCallback,  // –§—É–Ω–∫—Ü–∏—è —Ä–µ—Ç–µ—Å—Ç–∞
        CancellationToken ct)
    {
        // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–µ—à–∞
        // 2. –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–π –∏–∑ StrategyMapping
        // 3. –¶–∏–∫–ª: –ø—Ä–∏–º–µ–Ω–∏—Ç—å ‚Üí —Ä–µ—Ç–µ—Å—Ç ‚Üí –µ—Å–ª–∏ OK ‚Üí –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ
        // 4. Cleanup –µ—Å–ª–∏ –≤—Å—ë –ø—Ä–æ–≤–∞–ª–∏–ª–æ—Å—å
    }
}
```

### WinDivertBypassEnforcer (–≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é)

```csharp
public class WinDivertBypassEnforcer : IBypassEnforcer
{
    public async Task ApplyBypassAsync(HostBlocked blocked, CancellationToken ct)
    {
        // 1. –ü—Ä–æ–±—É–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é —Å—Ç—Ä–∞—Ç–µ–≥–∏—é (–µ—Å–ª–∏ –µ—Å—Ç—å)
        // 2. –ü—Ä–æ–±—É–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω—É—é —Å—Ç—Ä–∞—Ç–µ–≥–∏—é
        // 3. –ü—Ä–æ–±—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
        // 4. –†–µ—Ç–µ—Å—Ç –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–π –ø–æ–ø—ã—Ç–∫–∏
    }
}
```

### LiveTestingPipeline (—Ç—Ä–µ–±—É–µ—Ç —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞)

**–¢–µ–∫—É—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:**
```
SnifferQueue ‚Üí TesterWorker ‚Üí TesterQueue ‚Üí ClassifierWorker ‚Üí BypassQueue ‚Üí UiWorker
                                                                             (–¢–û–õ–¨–ö–û –ª–æ–≥!)
```

**–¶–µ–ª–µ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:**
```
SnifferQueue ‚Üí TesterWorker ‚Üí TesterQueue ‚Üí ClassifierWorker ‚Üí BypassWorker ‚Üí UiWorker
                                                                   ‚Üì
                                                         BypassCoordinator.AutoFixLiveAsync()
```

---

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è Planning Agent

### –§–∞–∑–∞ 1: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª

#### Task 1.1: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è BypassCoordinator –≤ LiveTestingPipeline
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô  
**–û—Ü–µ–Ω–∫–∞:** 4-6 —á–∞—Å–æ–≤

**–®–∞–≥–∏:**
1. –î–æ–±–∞–≤–∏—Ç—å `BypassWorker` –º–µ–∂–¥—É `ClassifierWorker` –∏ `UiWorker`
2. –í `BypassWorker` –≤—ã–∑—ã–≤–∞—Ç—å `BypassCoordinator.AutoFixLiveAsync()`
3. –ü–µ—Ä–µ–¥–∞–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ `UiWorker` –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
4. –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ bypass (–æ—á–µ—Ä–µ–¥—å —Å—Ç—Ä–∞—Ç–µ–≥–∏–π?)

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:**
- `Bypass/BypassCoordinator.cs` ‚Äî –≥–æ—Ç–æ–≤
- `Core/Modules/WinDivertBypassEnforcer.cs` ‚Äî –≥–æ—Ç–æ–≤
- `Utils/LiveTestingPipeline.cs` ‚Äî —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥

**–†–∏—Å–∫–∏:**
- –ì–ª–æ–±–∞–ª—å–Ω—ã–π bypass –º–æ–∂–µ—Ç –ª–æ–º–∞—Ç—å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã
- –ù—É–∂–µ–Ω –º–µ—Ö–∞–Ω–∏–∑–º –æ—á–µ—Ä–µ–¥–∏ –∏–ª–∏ sequencing

#### Task 1.2: –£–¥–∞–ª–µ–Ω–∏–µ –º—ë—Ä—Ç–≤–æ–≥–æ –∫–æ–¥–∞
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü° –°–†–ï–î–ù–ò–ô  
**–û—Ü–µ–Ω–∫–∞:** 2 —á–∞—Å–∞

**–®–∞–≥–∏:**
1. –£–¥–∞–ª–∏—Ç—å `Models/FixHistory.cs`
2. –£–¥–∞–ª–∏—Ç—å –∏–∑ `MainViewModel.cs`: `ActiveFixes`, `HasActiveFixes`, `RollbackFixCommand`, `LoadFixHistory()`, `RollbackFixAsync()`, `RollbackAllFixesAsync()`
3. –£–¥–∞–ª–∏—Ç—å `AuditRunner.cs` (‚ö†Ô∏è –°–û–•–†–ê–ù–ò–¢–¨ –ª–æ–≥–∏–∫—É –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ `BypassCoordinator`!)
4. –£–¥–∞–ª–∏—Ç—å `Config.ParseArgs()` –∏ CLI –∫–æ–¥
5. –£–¥–∞–ª–∏—Ç—å `Output/` –ø–∞–ø–∫—É
6. –£–¥–∞–ª–∏—Ç—å `RunCliAsync()` –∏–∑ `Program.cs`

**–†–∏—Å–∫–∏:**
- –ü–æ—Ç–µ—Ä—è—Ç—å —Ä–∞–±–æ—á—É—é –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é `BypassCoordinator` –≤ `AuditRunner`

#### Task 1.3: –í–∫–ª—é—á–∏—Ç—å Socket Layer –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü° –°–†–ï–î–ù–ò–ô  
**–û—Ü–µ–Ω–∫–∞:** 1-2 —á–∞—Å–∞

**–®–∞–≥–∏:**
1. –¢–µ—Å—Ç: –≤–∫–ª—é—á–∏—Ç—å Socket Layer –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Å bypass, –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç
2. –ï—Å–ª–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç ‚Äî –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Socket –≤–º–µ—Å—Ç–æ polling
3. –û–±–Ω–æ–≤–∏—Ç—å `UseWatcherMode` –ª–æ–≥–∏–∫—É –≤ `FlowMonitorService`

**–†–∏—Å–∫–∏:**
- –í–æ–∑–º–æ–∂–Ω—ã–π –∫–æ–Ω—Ñ–ª–∏–∫—Ç —Å RST blocker

### –§–∞–∑–∞ 2: –£–ª—É—á—à–µ–Ω–∏–µ –¥–µ—Ç–µ–∫—Ü–∏–∏

#### Task 2.1: Retransmission tracking
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü° –°–†–ï–î–ù–ò–ô  
**–û—Ü–µ–Ω–∫–∞:** 4-6 —á–∞—Å–æ–≤

**–®–∞–≥–∏:**
1. –ß–µ—Ä–µ–∑ WinDivert Sniff layer –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å TCP seq numbers
2. –°—á—ë—Ç—á–∏–∫ —Ä–µ—Ç—Ä–∞–Ω—Å–º–∏—Å—Å–∏–π per-host
3. –ü–æ—Ä–æ–≥ (3 —Ä–µ—Ç—Ä–∞–Ω—Å–º–∏—Å—Å–∏–∏) ‚Üí –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞
4. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å `StandardBlockageClassifier`

#### Task 2.2: HTTP redirect detection
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü¢ –ù–ò–ó–ö–ò–ô  
**–û—Ü–µ–Ω–∫–∞:** 2-3 —á–∞—Å–∞

**–®–∞–≥–∏:**
1. –ê–Ω–∞–ª–∏–∑ HTTP –æ—Ç–≤–µ—Ç–æ–≤ (Location header)
2. –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –¥–æ–º–µ–Ω–∞ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞ —Å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–º
3. –ï—Å–ª–∏ SLD –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è ‚Üí DPI redirect

### –§–∞–∑–∞ 3: UX –∏ polish

#### Task 3.1: OutputType=WinExe
**–û—Ü–µ–Ω–∫–∞:** 5 –º–∏–Ω—É—Ç
- –ò–∑–º–µ–Ω–∏—Ç—å –≤ `.csproj` ‚Äî —É–±—Ä–∞—Ç—å –º–µ–ª—å–∫–∞–Ω–∏–µ –∫–æ–Ω—Å–æ–ª–∏

#### Task 3.2: Global exception handler
**–û—Ü–µ–Ω–∫–∞:** 30 –º–∏–Ω—É—Ç
- –î–æ–±–∞–≤–∏—Ç—å –≤ `App.xaml.cs`

---

## –í–∞–∂–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –∫–æ–¥–∞ (–¥–ª—è Coding Agent)

### Async –ø—Ä–∞–≤–∏–ª–∞
```csharp
// ‚úÖ –í–°–ï–ì–î–ê ConfigureAwait(false) –≤ library/test –∫–æ–¥–µ
var result = await DoWorkAsync().ConfigureAwait(false);

// ‚ùå –ù–ò–ö–û–ì–î–ê –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å async
var result = DoWorkAsync().Result; // DEADLOCK
```

### Progress reporting (GUI –∫–æ–Ω—Ç—Ä–∞–∫—Ç)
```csharp
progress?.Report($"[BYPASS] –ü—Ä–∏–º–µ–Ω—è—é {strategy} –¥–ª—è {host}...");
progress?.Report($"‚úì {strategy} bypass –∞–∫—Ç–∏–≤–µ–Ω");
progress?.Report($"‚úó {strategy} –Ω–µ –ø–æ–º–æ–≥");
```

### BypassCoordinator –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
```csharp
var coordinator = new BypassCoordinator(_bypassManager);
var result = await coordinator.AutoFixLiveAsync(
    testedHost,
    async (h) => await _tester.TestHostAsync(h.Host, ct),  // –†–µ—Ç–µ—Å—Ç callback
    ct
);
if (result.Success) {
    _progress.Report($"‚úì –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: {result.Strategy}");
}
```

---

## Checklist –¥–ª—è QA Agent

–ü–æ—Å–ª–µ –≤–Ω–µ—Å–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:

1. [ ] YouTube/Discord/rutracker —Ä–∞–±–æ—Ç–∞—é—Ç —Å bypass
2. [ ] Bypass –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
3. [ ] –ù–µ—Ç —Ä–µ–≥—Ä–µ—Å—Å–∏–π –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–µ
4. [ ] GUI –Ω–µ –∑–∞–≤–∏—Å–∞–µ—Ç –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏–π
5. [ ] –õ–æ–≥–∏ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ bypass
6. [ ] –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–∞—é—â–∏—Ö —Å—Ç—Ä–∞—Ç–µ–≥–∏–π —Ä–∞–±–æ—Ç–∞–µ—Ç
7. [ ] Socket Layer –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É–µ—Ç —Å RST blocker
