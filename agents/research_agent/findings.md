# Аудит тестов ISP_Audit

**Дата аудита:** 2025-10-29  
**Аудитор:** Claude (Sonnet 4.5)  
**Thoroughness level:** Very thorough

---

## Executive Summary

Проект ISP_Audit содержит 6 тестов для диагностики доступа к серверам Star Citizen. Анализ показал:

- **3 критически важных теста** (DNS, TCP, HTTP) - корректно реализованы, хорошо покрывают основные проблемы
- **2 теста с ограниченной полезностью** (Traceroute, RST Heuristic) - отключены по умолчанию, имеют низкую информативность
- **1 тест требует улучшений** (UDP) - работает, но логика определения блокировок неполная

---

## 1. DNS Test (Tests/DnsTest.cs)

### Что делает
Тест выполняет резолвинг доменов двумя способами: через системный DNS (Dns.GetHostAddresses()) и через DoH (DNS-over-HTTPS) к Cloudflare (1.1.1.1). Сравнивает результаты и классифицирует статус: OK, WARN, DNS_FILTERED, DNS_BOGUS.

### Какие проблемы выявляет

**1. DNS_FILTERED** - провайдер полностью блокирует резолвинг:
- Системный DNS возвращает пустой список (NXDOMAIN или timeout)
- DoH возвращает корректные IP
- **Сценарий:** ISP блокирует домен на уровне DNS, подменяет ответ на NXDOMAIN

**2. DNS_BOGUS** - провайдер возвращает мусорные IP:
- Системный DNS возвращает адреса из диапазонов: 0.0.0.0/8, 127.0.0.0/8, 10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16
- **Сценарий:** ISP перенаправляет на свою заглушку или локальный адрес (классическая блокировка РКН)

**3. WARN** - DNS ответы не совпадают:
- Системный и DoH DNS возвращают разные IP (но оба валидны)
- **Сценарий:** CDN-геолокация, split-brain DNS, или мягкая подмена провайдером

### Критические проблемы

**Проблема 1: Эвристика мусорных IP слишком жёсткая**

Код в NetUtils.cs проверяет RFC1918 адреса (10.x, 172.16-31.x, 192.168.x) как BOGUS. Это правильно для интернет-серверов, но создаёт ложные срабатывания в корпоративных сетях.

Последствия:
- Если DNS корректно возвращает внутренний корпоративный IP (например, кэширующий прокси) - тест покажет DNS_BOGUS
- Пользователь за корпоративным NAT получает ложную тревогу

Решение: Проверять только 0.0.0.0/8 и 127.0.0.0/8. RFC1918 адреса могут быть легитимными в корпоративных сетях.

**Проблема 2: Отсутствие retry для DoH**

Retry выполняется только при TaskCanceledException (timeout). Сетевые ошибки (NetworkException, HttpRequestException) не повторяются.

Последствия: Временные проблемы с DoH (перегрузка 1.1.1.1, разрыв соединения) интерпретируются как блокировка.

**Проблема 3: Статус WARN неоднозначен**

Не различает легитимные CDN-различия и частичную подмену DNS. Пользователь видит предупреждение, но не понимает - это нормально или проблема.

Решение: Добавить проверку GeoIP: если оба IP принадлежат разным AS, но одному владельцу (например, Cloudflare, AWS) - это OK, иначе - подозрительно.

### Полезность: ⭐⭐⭐⭐⭐ (5/5)

**Обоснование:**
- DNS-блокировки - основная причина проблем с доступом к Star Citizen в России
- Тест корректно выявляет подмену DNS на уровне провайдера
- DoH сравнение - правильный подход, даёт надёжную точку отсчёта
- **Рекомендация:** Смягчить эвристику RFC1918, добавить retry для DoH, улучшить интерпретацию WARN

---

## 2. TCP Test (Tests/TcpTest.cs)

### Что делает
Выполняет TCP-подключение (Socket.ConnectAsync) к списку IP:PORT с таймаутом 3 секунды. Проверяет порты 80, 443, 8000-8020 (для лаунчера Star Citizen). При неудаче повторяет попытку через 500ms.

### Какие проблемы выявляет

**1. TCP-порты заблокированы файрволом:**
- Все порты закрыты (connection refused / timeout)
- **Сценарий:** Корпоративный файрвол блокирует нестандартные порты 8000-8020

**2. Хост недоступен:**
- IP резолвится, но TCP-подключение падает по таймауту
- **Сценарий:** Routing-блокировка на уровне ISP (blackhole routing)

**3. Селективная блокировка:**
- Порт 443 открыт, но 80 или 8000-8020 закрыты
- **Сценарий:** DPI блокирует HTTP, но TLS ещё проходит (до анализа SNI)

### Критические проблемы

**Проблема 1: Порт открыт не равно игра работает**

Тест показывает SUCCESS, если хотя бы один порт открыт. Но лаунчеру нужны ВСЕ порты 8000-8020 + 443.

Последствия: Пользователь видит TCP - всё работает, но лаунчер зависает при обновлении (доступен только 443, остальные закрыты).

**Проблема 2: Retry-логика слишком простая**

Фиксированная задержка 500ms не учитывает причину отказа:
- Connection refused (RST) - смысла retry нет
- Timeout - нужен более длинный retry или другой порт

**Проблема 3: Порты проверяются последовательно**

При 3 IP и 23 портах = 69 последовательных проверок. С учётом retry и таймаута 3 сек - может занять до 3-4 минут.

Решение: Параллельные проверки (Task.WhenAll) с ограничением на 10-20 одновременных соединений.

**Проблема 4: Таймаут 3 секунды слишком короткий**

Для мобильных сетей (4G с плохим сигналом) или через VPN - 3 сек может быть недостаточно. TCP handshake в условиях потерь пакетов: SYN + retry (1s) + retry (2s) = 3s минимум.

### Полезность: ⭐⭐⭐⭐ (4/5)

**Обоснование:**
- Выявляет блокировки на уровне файрвола и routing
- Критично важен для диагностики портов лаунчера (8000-8020)
- **Проблема:** Интерпретация хотя бы один порт открыт = OK вводит в заблуждение
- **Рекомендация:** Различать Портал доступен (80/443) vs Лаунчер доступен (8000-8020), показывать отдельные статусы для разных групп портов, добавить параллельные проверки

---

## 3. HTTP Test (Tests/HttpTest.cs)

### Что делает
Выполняет HTTPS-запросы к целям, извлекает CN (Common Name) из TLS-сертификата, проверяет HTTP-статус. Проверяет 3 URL: https://host, https://www.host, https://host/generate_204.

### Какие проблемы выявляет

**1. DPI-блокировка на основе SNI:**
- TCP-порт 443 открыт (TCP test = OK)
- Но HTTPS-запрос падает по timeout или connection reset
- **Сценарий:** DPI инспектирует SNI в TLS ClientHello, детектирует запрещённый домен, инжектирует RST или дропает пакеты

**2. Подмена TLS-сертификата (MITM):**
- Запрос проходит, но cert_cn не совпадает с ожидаемым доменом
- **Сценарий:** Корпоративный прокси с SSL-interception или атака MITM

**3. HTTP-редирект на заглушку:**
- Запрос возвращает 200 OK, но это не оригинальный сайт (провайдер перенаправляет на свою страницу)
- **Сценарий:** Мягкая блокировка с информационной страницей

### Критические проблемы

**Проблема 1: Сертификат принимается без валидации**

Тест ВСЕГДА принимает сертификат, даже если он невалиден. ServerCertificateCustomValidationCallback возвращает true.

Последствия: 
- Не выявляет MITM-атаки (подмену сертификата корпоративным прокси)
- CN извлекается, но не проверяется соответствие домену
- Пользователь видит HTTPS работает, но на самом деле проходит через MITM

**Проблема 2: Статус SUSPECT слабо определён**

SUSPECT ставится, если TCP 443 открыт, но HTTP не отвечает. Но не проверяется ПРИЧИНА отказа: timeout vs connection reset vs wrong cert.

Последствия: Пользователь видит подозрение на блокировку, но не понимает - DPI, MITM или просто сайт недоступен.

**Проблема 3: Таймаут 12 секунд избыточен**

Если DPI блокирует, то RST приходит через 100-500ms. Ожидание 12 секунд замедляет диагностику.

Рекомендация: 5-6 секунд достаточно для большинства сценариев.

**Проблема 4: Не проверяется содержимое ответа**

Провайдер может возвращать 200 OK с HTML-заглушкой Сайт заблокирован. Тест интерпретирует это как OK.

Решение: Проверять Content-Type и первые байты ответа (например, для RSI ожидается HTML с определённым title).

### Полезность: ⭐⭐⭐⭐⭐ (5/5)

**Обоснование:**
- HTTP/TLS - основной вектор блокировок через DPI
- Извлечение CN - правильная идея для детекции MITM
- **Критический недостаток:** CN извлекается, но не используется для валидации
- **Рекомендация:** Проверять соответствие CN домену, различать DPI (connection reset) vs MITM (wrong CN) vs недоступность (timeout), добавить проверку содержимого ответа для детекции заглушек

---

## 4. UDP Test (Tests/UdpProbeRunner.cs)

### Что делает
Отправляет UDP-пакеты и ожидает ответы (или не ожидает, в зависимости от ExpectReply). Два типа проб:
1. **DNS probe** - отправляет DNS-запрос на 1.1.1.1:53, ожидает ответ
2. **Raw probe** - отправляет произвольный payload на игровые шлюзы (64090), НЕ ожидает ответ

### Какие проблемы выявляет

**1. UDP DNS заблокирован:**
- Запрос на 1.1.1.1:53 не получает ответ (timeout)
- **Сценарий:** ISP блокирует UDP/53 для принудительного использования своего DNS

**2. Игровые UDP-порты недоступны:**
- Пакеты на 64090 не отправляются (ошибка сокета)
- **Сценарий:** Корпоративный файрвол блокирует исходящий UDP на нестандартных портах

### Критические проблемы

**Проблема 1: Raw UDP probe с ExpectReply=false ничего не проверяет**

Тест показывает SUCCESS, если SendAsync() не упал с исключением. Но SendAsync() успешно возвращается, даже если пакет дропается на уровне ISP или игровой сервер недоступен.

Последствия: Пользователь видит UDP тест пройден, но игра не запускается (UDP-трафик блокируется провайдером).

Правильная логика: Для Raw probe без ExpectReply нельзя узнать, дошёл ли пакет. Статус должен быть INFO/UNKNOWN, а не SUCCESS.

**Проблема 2: DNS probe парсит ответ слабо**

Проверяется только длина >= 12 байт (размер DNS-заголовка). Не парсится RCODE (response code) - может быть SERVFAIL, NXDOMAIN. Не проверяется ID запроса - может быть ответ на другой запрос.

Последствия: Если приходит DNS-ответ с ошибкой - тест покажет SUCCESS.

**Проблема 3: Не обрабатывается ICMP Port Unreachable**

При блокировке UDP провайдер может отвечать ICMP Type 3 Code 3 (port unreachable). .NET UdpClient интерпретирует это как исключение SocketException.

Проблема: Пользователь видит техническую ошибку (Connection refused), а не понятное объяснение.

**Проблема 4: Таймаут 3 секунды для UDP DNS избыточен**

Корректный DNS-ответ от 1.1.1.1 приходит за 10-100ms. Если ответа нет за 1 секунду - он не придёт.

Рекомендация: Уменьшить до 1-2 секунд для DNS probe.

### Полезность: ⭐⭐⭐ (3/5)

**Обоснование:**
- DNS probe (1.1.1.1:53) - полезен для детекции блокировки UDP/53
- Raw probe на игровые шлюзы - БЕСПОЛЕЗЕН: успешная отправка не равно доступность сервера
- **Проблема:** Тест создаёт ложное чувство безопасности (UDP OK), но не гарантирует работу игры
- **Рекомендация:** DNS probe - улучшить парсинг ответа (проверять RCODE, ID). Raw probe - изменить статус на INFO/UNKNOWN (не SUCCESS), добавить пояснение пакет отправлен, но доступность не гарантируется. Добавить настоящую UDP-проверку с ответом (например, STUN-запрос)

---

## 5. Traceroute Test (Tests/TracerouteTest.cs)

### Что делает
Запускает системную утилиту tracert.exe с аргументами -d -h 15 -w 2000 <host>, парсит stdout построчно, извлекает IP хопов. Таймаут 35 секунд (15 хопов * 2 сек + запас).

### Какие проблемы выявляет

**Теоретически:**
- Определить точку блокировки (после какого хопа трафик дропается)
- Увидеть маршрутизацию через подозрительные AS (например, через ISP с известной блокировкой)

**На практике:**
- Для обычного пользователя traceroute бесполезен: список IP хопов ничего не говорит
- Технический специалист может проанализировать, но это edge case

### Критические проблемы

**Проблема 1: Парсинг stdout ненадёжен**

Регулярка захватывает только IP или *, но tracert может выводить доменные имена, ошибки (Request timed out, Destination host unreachable), множественные IP на одном хопе.

Последствия: Часть информации теряется, но для текущей задачи это некритично.

**Проблема 2: Кодировка OEM866 - хак для русской Windows**

Работает только для русской локали Windows. На английской/другой локали будет кракозябры (или exception).

Решение: Определять кодировку динамически через Console.OutputEncoding.

**Проблема 3: Таймаут 35 секунд блокирует UI**

Traceroute - самый долгий тест (до 35 секунд). При отмене процесс убивается, но может не успеть.

Последствия: GUI зависает, пользователь думает, что приложение зависло.

**Проблема 4: Traceroute не выявляет DPI-блокировки**

ICMP/UDP traceroute проходит через маршрутизацию, но не через DPI. Даже если traceroute показывает полный путь до сервера - это не значит, что HTTPS/TCP к нему работает.

Последствия: Тест может показать OK, но HTTPS всё равно заблокирован.

### Полезность: ⭐⭐ (2/5)

**Обоснование:**
- **Отключен по умолчанию** (EnableTrace = false) - правильное решение
- Для обычного пользователя - бесполезен (список IP ничего не говорит)
- Для техподдержки - может быть полезен для детекции routing-проблем, но не DPI
- **Рекомендация:** Оставить отключенным, использовать только для расширенной диагностики по запросу техподдержки

---

## 6. RST Heuristic (Tests/RstHeuristic.cs)

### Что делает
Пытается подключиться к заведомо закрытому порту (1.1.1.1:81) и измеряет время до отказа. Идея: если отказ мгновенный (< 100ms) - пришёл настоящий RST от сервера; если долгий (> 1s) - провайдер инжектирует RST или дропает пакеты.

### Какие проблемы выявляет

**Теория:**
- RST-инжекция провайдером (DPI отправляет RST при детекции запрещённого трафика)
- Timing-based атаки (провайдер задерживает RST, чтобы скрыть блокировку)

**Практика:**
- **Ничего не выявляет.** Код не анализирует время (elapsedMs), просто сохраняет в отчёт

### Критические проблемы

**Проблема 1: Отсутствует интерпретация результата**

Результат сохраняется, но НИКОГДА не используется. В ReportWriter.BuildSummary(): summary.rst_inject = UNKNOWN (всегда\!).

**Проблема 2: Эвристика по таймингу неточна**

Время отклика зависит от RTT до 1.1.1.1 (может быть 1-300ms), загрузки сервера Cloudflare, локальной сети (WiFi jitter, буферы маршрутизатора). Невозможно отличить настоящий RST через 50ms от инжектированный RST через 45ms.

**Проблема 3: 1.1.1.1:81 может быть открыт**

Cloudflare может в любой момент запустить сервис на порту 81. Тест не проверяет, что порт действительно ЗАКРЫТ.

Последствия: Если порт открыт - эвристика сломается (ok = true, но ожидалось false).

**Проблема 4: Не проверяется причина отказа**

TcpConnectTryAsync() возвращает только bool (успех/неудача). Не различает:
- Connection refused (RST от сервера) - ожидаемо
- Timeout (пакеты дропаются) - подозрительно
- Network unreachable (routing проблема) - неопределённо

### Полезность: ⭐ (1/5)

**Обоснование:**
- **Отключен по умолчанию** (EnableRst = false) - правильное решение
- Код реализован, но результат не анализируется (всегда UNKNOWN)
- Эвристика по таймингу слишком ненадёжна для продакшн-использования
- **Рекомендация:** Либо удалить тест, либо реализовать настоящую проверку RST-инжекции (анализ TCP-флагов через pcap, требует администраторских прав), либо добавить интерпретацию результата: elapsedMs < 100 → OK, > 1000 → SUSPECT, else → UNKNOWN

---

## Сравнительная таблица полезности

| Тест | Полезность | По умолчанию | Критические проблемы | Рекомендация |
|------|------------|--------------|---------------------|--------------|
| **DNS Test** | ⭐⭐⭐⭐⭐ | Включён | Эвристика RFC1918 слишком жёсткая | Смягчить проверку приватных IP |
| **TCP Test** | ⭐⭐⭐⭐ | Включён | Хотя бы 1 порт = OK вводит в заблуждение | Различать группы портов (портал/лаунчер) |
| **HTTP Test** | ⭐⭐⭐⭐⭐ | Включён | CN извлекается, но не валидируется | Проверять соответствие CN домену |
| **UDP Test** | ⭐⭐⭐ | Включён | Raw probe с ExpectReply=false бесполезен | Изменить статус на INFO, улучшить DNS probe |
| **Traceroute** | ⭐⭐ | Отключён | Медленный, бесполезен для пользователя | Оставить отключенным |
| **RST Heuristic** | ⭐ | Отключён | Результат не анализируется (всегда UNKNOWN) | Удалить или реализовать интерпретацию |

---

## Общие выводы

### Сильные стороны

1. **Правильная архитектура:** Тесты модульные, независимые, легко расширяемые
2. **DoH-сравнение в DNS Test:** Золотой стандарт для детекции DNS-подмен
3. **CN-извлечение в HTTP Test:** Правильная идея для MITM-детекции (но не реализовано до конца)
4. **Async/await + CancellationToken:** Корректная работа с асинхронностью
5. **Retry-логика:** TCP и DNS тесты повторяют запросы при неудаче

### Слабые стороны

1. **Интерпретация результатов неоднозначна:**
   - DNS WARN: CDN или подмена?
   - TCP OK: хотя бы 1 порт или все критичные порты?
   - HTTP SUSPECT: DPI, MITM или недоступность?
   - UDP SUCCESS: пакет отправлен, но сервер доступен?

2. **Эвристики слишком строгие или отсутствуют:**
   - RFC1918 IP в DNS = BOGUS (ложное срабатывание в корпсетях)
   - RST heuristic не анализирует результат

3. **Медленные тесты:**
   - TCP: последовательные проверки 69 портов (до 3-4 минут)
   - Traceroute: до 35 секунд

4. **Безопасность TLS не проверяется:**
   - HTTP Test принимает любые сертификаты, не валидирует CN

### Рекомендации по улучшению

#### Высокий приоритет

1. **DNS Test:**
   - Разрешить RFC1918 адреса (10.x, 172.16-31.x, 192.168.x) как легитимные
   - Добавить retry для DoH на все типы ошибок
   - Улучшить интерпретацию WARN (различать CDN и подмену)

2. **TCP Test:**
   - Различать группы портов: Портал (80/443), Лаунчер (8000-8020)
   - Показывать отдельные статусы: Портал доступен, Лаунчер недоступен
   - Добавить параллельные проверки (Task.WhenAll) для ускорения

3. **HTTP Test:**
   - Проверять соответствие CN домену
   - Различать типы отказа: DPI (RST), MITM (wrong CN), недоступность (timeout)
   - Добавить проверку содержимого ответа для детекции заглушек

4. **UDP Test:**
   - Изменить статус Raw probe с ExpectReply=false на INFO (не SUCCESS)
   - Улучшить DNS probe: парсить RCODE, проверять ID
   - Добавить STUN-проверку для валидной UDP-диагностики

#### Средний приоритет

5. **Общее:**
   - Добавить параллельные проверки для ускорения
   - Улучшить таймауты (HTTP 12s → 6s, UDP 3s → 1-2s)
   - Добавить детальную классификацию ошибок в отчёт

6. **GUI:**
   - Показывать детали отказов (не только OK/FAIL, но и причину)
   - Добавить расширенный режим с traceroute для техподдержки

#### Низкий приоритет

7. **RST Heuristic:**
   - Либо реализовать интерпретацию результата
   - Либо удалить тест (сейчас бесполезен)

8. **Traceroute:**
   - Оставить отключенным по умолчанию
   - Использовать только для расширенной диагностики

---

## Заключение

Проект ISP_Audit содержит **хорошо реализованное ядро** из 3 критических тестов (DNS, TCP, HTTP), которые корректно выявляют основные типы блокировок. Однако **интерпретация результатов требует улучшений** - текущие статусы (OK, WARN, FAIL) не всегда отражают реальную проблему.

**Главная рекомендация:** Сфокусироваться на улучшении DNS/TCP/HTTP тестов (смягчить эвристики, улучшить классификацию ошибок, добавить валидацию CN), а не на добавлении новых тестов. Два теста (Traceroute, RST) правильно отключены по умолчанию и должны остаться в таком состоянии.

**Для обычного пользователя (игрока Star Citizen)** текущий набор тестов **достаточен** для диагностики проблем с доступом. Основное улучшение - это **понятные рекомендации** в GUI, которые уже хорошо реализованы в ReportWriter.BuildAdviceText().

---

## Дополнительные находки

### Профили сервисов (TargetServiceProfiles.cs)

Хорошая архитектурная идея - разные цели требуют разных тестов:

- **Портал** (robertsspaceindustries.com): только 80/443, нужны DNS+HTTP
- **Лаунчер** (launcher.robertsspaceindustries.com): 443 + 8000-8020, нужны DNS+TCP+HTTP
- **CDN** (cdn.robertsspaceindustries.com): 80/443, нужны DNS+HTTP
- **Игровые сервера** (p4eu-live.cloudimperiumgames.com): 8000-8020, HTTP не нужен (игровой трафик)

Это правильное решение, которое избавляет от бесполезных проверок (например, HTTPS на игровых серверах, которые не говорят HTTP).

### Таймауты по умолчанию (Config.cs)

- HTTP: 12 секунд - избыточно, можно 6
- TCP: 3 секунды - нормально
- UDP: 3 секунды - избыточно для DNS (можно 1-2)

### Список целей (star_citizen_targets.json)

Полный и актуальный:
- Все критичные домены Star Citizen включены
- Игровые шлюзы EU/US/AUS - правильно
- UDP проверки на 64090 (игровой порт) - правильный порт

### Отчёты (ReportWriter.cs)

Генерация отчётов реализована отлично:
- HTML/PDF экспорт для техподдержки
- Понятные рекомендации на русском языке
- Правильная интерпретация статусов (BuildAdviceText)

**Единственная проблема:** В BuildAdviceText() рекомендации строятся на основе текущих статусов, которые могут быть неоднозначны (см. проблемы выше).

---

**Итог аудита:** Проект качественный, основные тесты работают корректно. Основные улучшения - это уточнение эвристик и улучшение интерпретации результатов, а не добавление новых тестов.
