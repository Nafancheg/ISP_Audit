# ISP_Audit โ ะััะธัะตะบัััะฐ ะธ ะะปะฐะฝ ะะฐะฑะพั

**ะะฐัะฐ:** 01.12.2025  
**ะฆะตะปั:** ะะฑัะพะด ะฑะปะพะบะธัะพะฒะพะบ ะฟัะพะฒะฐะนะดะตัะฐ (DPI, DNS-ัะธะปัััะฐัะธั, TCP RST injection)  
**ะกัะฐััั:** โ BypassCoordinator ะธะฝัะตะณัะธัะพะฒะฐะฝ, ะผัััะฒัะน ะบะพะด ัะดะฐะปัะฝ. ะะตัะตะบัะธั ะฑะปะพะบะธัะพะฒะพะบ โ ะฑะฐะทะพะฒะฐั.

---

## ะะณะปะฐะฒะปะตะฝะธะต

### ะงะฐััั I: ะงะขะ ะงะะะะขะฌ (ะัะธะพัะธัะตัั)
1. [ะัะธัะธัะตัะบะธะต ะฟัะพะฑะปะตะผั](#1-ะบัะธัะธัะตัะบะธะต-ะฟัะพะฑะปะตะผั)
2. [ะะปะฐะฝ ัะฐะฑะพั (ะฟัะธะพัะธัะธะทะธัะพะฒะฐะฝะฝัะน)](#2-ะฟะปะฐะฝ-ัะฐะฑะพั)
3. [ะัะธะฝัััะต ะฐััะธัะตะบัััะฝัะต ัะตัะตะฝะธั](#3-ะฟัะธะฝัััะต-ัะตัะตะฝะธั)

### ะงะฐััั II: ะะะ ะฃะกะขะะะะะ (ะกะฟัะฐะฒะพัะฝะธะบ)
4. [ะะฑัะฐั ะฐััะธัะตะบัััะฐ](#4-ะพะฑัะฐั-ะฐััะธัะตะบัััะฐ)
5. [Bypass ัะธััะตะผะฐ](#5-bypass-ัะธััะตะผะฐ)
6. [ะะพะฝะธัะพัะธะฝะณ ะธ ะดะตัะตะบัะธั](#6-ะผะพะฝะธัะพัะธะฝะณ-ะธ-ะดะตัะตะบัะธั)
7. [UI ะธ ViewModel](#7-ui-ะธ-viewmodel)
8. [ะคะฐะนะปะพะฒะฐั ััััะบัััะฐ ะธ ะผัััะฒัะน ะบะพะด](#8-ัะฐะนะปะพะฒะฐั-ััััะบัััะฐ)

---

# ะงะฐััั I: ะงะขะ ะงะะะะขะฌ

## 1. ะัะธัะธัะตัะบะธะต ะฟัะพะฑะปะตะผั

### โ ะะะจะะะ: Bypass ัะตะฟะตัั ะฟัะธะผะตะฝัะตััั ะดะธะฝะฐะผะธัะตัะบะธ

**ะัะปะพ:** Pipeline ัะตััะธัะพะฒะฐะป ัะพััั, ะบะปะฐััะธัะธัะธัะพะฒะฐะป ะฑะปะพะบะธัะพะฒะบะธ, ะฝะพ ะะ ะฟัะธะผะตะฝัะป bypass ัััะฐัะตะณะธะธ.

**ะกัะฐะปะพ:** `BypassCoordinator` ะธะฝัะตะณัะธัะพะฒะฐะฝ ะฒ `LiveTestingPipeline.UiWorker`. ะัะธ ะพะฑะฝะฐััะถะตะฝะธะธ ะฑะปะพะบะธัะพะฒะบะธ:
1. Coordinator ะฟัะพะฒะตััะตั ะบะตั ัะฐะฑะพัะฐััะธั ัััะฐัะตะณะธะน
2. ะะตัะตะฑะธัะฐะตั ะฟัะธะผะตะฝะธะผัะต ัััะฐัะตะณะธะธ ะฟะพ ะฟัะธะพัะธัะตัั
3. ะะพัะปะต ะบะฐะถะดะพะน ัััะฐัะตะณะธะธ ะดะตะปะฐะตั ัะตัะตัั
4. ะะตัะธััะตั ััะฟะตัะฝัั ัััะฐัะตะณะธั ะดะปั ัะพััะฐ

```
ะขะตะบััะธะน flow:
HostDiscovered โ TesterWorker โ ClassifierWorker โ UiWorker
                                                      โ
                                            BypassCoordinator.AutoFixLiveAsync()
                                                      โ
                                            ะกััะฐัะตะณะธั ะะะะะะะฏะะขะกะฏ + ัะตัะตัั!
```

---

### ๐ด ะะะะะะะะ #2: ะะตัะตะบัะธั ะฑะปะพะบะธัะพะฒะพะบ โ ะะ ะะะะกะฌ

**ะกััั:** ISP_Audit ะพะฟัะตะดะตะปัะตั ะฑะปะพะบะธัะพะฒะบะธ ะฟัะธะผะธัะธะฒะฝะพ, ะฟัะพะฟััะบะฐั ะณะปะฐะฒะฝัะต ะธะฝะดะธะบะฐัะพัั DPI.

| ะะตัะพะด ะดะตัะตะบัะธะธ | ISP_Audit | Zapret | ะะฐะถะฝะพััั |
|----------------|-----------|--------|----------|
| **TCP Retransmissions** | โ | โ | ๐ด **ะะะะะะซะ** |
| **HTTP redirect detect** | โ | โ | ๐ด ะัะธัะธัะตัะบะฐั |
| **RST packet inspection** | โ | โ | ๐ด ะัะธัะธัะตัะบะฐั |
| **Fail counter + time window** | โ | โ | ๐ก ะกัะตะดะฝัั |
| TCP RST (socket error) | โ | โ | โ |
| TLS handshake fail | โ | โ | โ |

**ะะฐะบ ISP_Audit ะพะฟัะตะดะตะปัะตั (StandardHostTester.cs):**
```csharp
// ะขะพะปัะบะพ socket exceptions ะธ fixed timeout 3ัะตะบ
catch (SocketException ex) {
    if (ex.SocketErrorCode == ConnectionReset) blockageType = "TCP_RST";
}
var completedTask = await Task.WhenAny(connectTask, Task.Delay(3000));
```

**ะะฐะบ Zapret ะพะฟัะตะดะตะปัะตั (ะณะปะฐะฒะฝะพะต):**
```c
// Retransmissions โ ะบะปะธะตะฝั ะฟะตัะตะพัะฟัะฐะฒะปัะตั ะทะฐะฟัะพั = DPI ะทะฐะฑะปะพะบะธัะพะฒะฐะป
if (ctrack->req_retrans_counter >= threshold) auto_hostlist_failed(hostname);
// HTTP redirect ะฝะฐ ะดััะณะพะน ะดะพะผะตะฝ = DPI ะทะฐะณะปััะบะฐ
if (HttpReplyLooksLikeDPIRedirect(payload, hostname)) bFail = true;
```

**ะะตัะตะฝะธะต:** ะกะผ. ะะปะฐะฝ ัะฐะฑะพั #3

---

### ๐ด ะะะะะะะะ #3: ะะตัะพะดั ะพะฑัะพะดะฐ โ 20% ะพั Zapret

**ะกััั:** ISP_Audit ัะตะฐะปะธะทัะตั ะผะธะฝะธะผัะผ ะผะตัะพะดะพะฒ ะพะฑัะพะดะฐ.

| ะะฐัะตะณะพัะธั | ISP_Audit | GoodbyeDPI/Zapret |
|-----------|-----------|-------------------|
| TCP RST drop | โ | โ |
| TLS Fragment/Disorder | โ | โ |
| Fake TTL | โ ะฑะฐะทะพะฒะพ | โ ั autottl |
| Bad checksum/seq | โ | โ |
| HTTP Host tricks | โ | โ |
| QUIC obfuscation | โ | โ |
| Hostlist ัะธะปัััะฐัะธั | โ | โ |
| Auto-hostlist | โ | โ |

**ะะตัะตะฝะธะต:** ะะฝัะตะณัะฐัะธั ั GoodbyeDPI/Zapret ะธะปะธ ัะฐััะธัะตะฝะธะต WinDivertBypassManager (ะฝะธะทะบะธะน ะฟัะธะพัะธัะตั โ ัะฝะฐัะฐะปะฐ ะฟะพัะธะฝะธัั ัะพ ััะพ ะตััั)

---

### โ ะะะจะะะ: ะัััะฒัะน ะบะพะด ัะดะฐะปัะฝ

| ะะพะผะฟะพะฝะตะฝั | ะกัะฐััั |
|-----------|--------|
| `BypassCoordinator` | โ ะะฝัะตะณัะธัะพะฒะฐะฝ ะฒ LiveTestingPipeline |
| `WinDivertBypassEnforcer` | โ ะฃะดะฐะปัะฝ (ะทะฐะผะตะฝัะฝ ะฝะฐ BypassCoordinator) |
| `IBypassEnforcer` | โ ะฃะดะฐะปัะฝ (ะฝะต ะฝัะถะตะฝ) |
| `FixHistory` + UI ะพัะบะฐั | โ ะฃะดะฐะปัะฝ |
| `AuditRunner.cs` | โ ะฃะดะฐะปัะฝ |
| `Output/` ะฟะฐะฟะบะฐ | โ ะฃะดะฐะปะตะฝะฐ |
| Flow/Socket WinDivert layers | โณ TODO: ะฒะบะปััะธัั Socket Layer |
| `TrafficAnalyzer.cs` | โ๏ธ DEPRECATED (ะทะฐะผะตะฝัะฝ ะฝะฐ TrafficCollector) |
| `TrafficAnalyzerDualLayer.cs` | ๐๏ธ ะัััะฒัะน ะบะพะด (ะฝะต ะธัะฟะพะปัะทัะตััั) |

---

## 2. ะะปะฐะฝ ัะฐะฑะพั

### ะคะฐะทะฐ 1: ะัะธัะธัะตัะบะธะน ััะฝะบัะธะพะฝะฐะป (ะะะะะะ)

#### โ #1 ะะฝัะตะณัะฐัะธั BypassCoordinator โ ะะะขะะะ
**ะฆะตะปั:** Bypass ะฟัะธะผะตะฝัะตััั ะดะธะฝะฐะผะธัะตัะบะธ ะฝะฐ ะพัะฝะพะฒะต ัะตะทัะปััะฐัะพะฒ ัะตััะธัะพะฒะฐะฝะธั

**ะัะฟะพะปะฝะตะฝะพ:**
- [x] `LiveTestingPipeline` ะธัะฟะพะปัะทัะตั `BypassCoordinator`
- [x] ะ `UiWorker` ะฒัะทัะฒะฐะตััั `BypassCoordinator.AutoFixLiveAsync()`
- [x] ะะพะพัะดะธะฝะฐัะพั ะฟัะพะฑัะตั ัััะฐัะตะณะธะธ, ะบะตัะธััะตั ัะฐะฑะพัะฐััะธะต
- [ ] ะขะตััั: YouTube, Discord, rutracker (ัััะฝะพะต ัะตััะธัะพะฒะฐะฝะธะต)

---

### ๐ฏ ะฆะตะปะตะฒะฐั ะฐััะธัะตะบัััะฐ (โ ะะะะะะะะะะะ 02.12.2025)

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                     MainViewModelRefactored โ NEW                           โ
โ                      (ะขะพะฝะบะธะน ะบะพะพัะดะธะฝะฐัะพั, ~430 ัััะพะบ)                        โ
โ                                                                             โ
โ  โข ะัะพะบัะธ-ัะฒะพะนััะฒะฐ ะดะปั UI binding                                           โ
โ  โข ะะพะผะฐะฝะดั                                                                  โ
โ  โข ะกะฒัะทั ะผะตะถะดั ะบะพะฝััะพะปะปะตัะฐะผะธ                                                โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                                      โ
       โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
       โ                              โ                              โ
       โผ                              โผ                              โผ
โโโโโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโโโโ
โ  BypassController  โ    โDiagnosticOrchestra-โ    โ TestResultsManager โ
โ     โ NEW         โ    โ    tor โ NEW      โ    โ      โ NEW        โ
โ   (~510 ัััะพะบ)     โ    โ   (~560 ัััะพะบ)     โ    โ   (~490 ัััะพะบ)     โ
โ                    โ    โ                    โ    โ                    โ
โ โข Toggle ะบะฝะพะฟะบะธ    โ    โ โข RunAsync()       โ    โ โข TestResults      โ
โ โข VPN detection    โ    โ โข Lifecycle        โ    โ โข ParseMessage()   โ
โ โข DoH              โ    โ   ัะตัะฒะธัะพะฒ         โ    โ โข Heuristics       โ
โ โข WinDivertBypass- โ    โ โข ะะพะพัะดะธะฝะฐัะธั      โ    โ โข PreResolve       โ
โ   Manager ะฒะปะฐะดะตะฝะธะต โ    โ   Collector+Pipe   โ    โ                    โ
โโโโโโโโโโโฌโโโโโโโโโโโ    โโโโโโโโโโโฌโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโโโโ
          โ                         โ
          โ                         โ
          โผ                         โผ
โโโโโโโโโโโโโโโโโโโโ      โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ WinDivertBypass- โ      โ            TrafficCollector โ NEW           โ
โ     Manager      โ      โ          (ะงะธัััะน ัะฑะพััะธะบ, ~290 ัััะพะบ)        โ
โ  (ะัะฟะพะปะฝะธัะตะปั)   โ      โ                                              โ
โ                  โ      โ  โข IAsyncEnumerable<HostDiscovered>          โ
โ โข RST Blocker    โ      โ  โข ะกะพะฑััะธั OnHostDiscovered                  โ
โ โข TLS Fragment   โ      โ  โข ะะตั ะปะพะณะธะบะธ bypass/UI                      โ
โ โข Fake TTL       โ      โ  โข ะัะฟะพะปัะทัะตั FlowMonitor, DnsParser         โ
โโโโโโโโโโโโโโโโโโโโ      โโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                                              โ
                                              โผ
                          โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                          โ         LiveTestingPipeline (~216 ัััะพะบ)     โ
                          โ                                              โ
                          โ  TesterWorker โ ClassifierWorker โ UiWorker  โ
                          โ                                     โ        โ
                          โ                             BypassCoordinatorโ
                          โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

**ะะปััะตะฒะพะต ะธะทะผะตะฝะตะฝะธะต:** TrafficAnalyzer โ TrafficCollector
- ะะฐะฝััะต: TrafficAnalyzer ัะพะทะดะฐะฒะฐะป LiveTestingPipeline ะฒะฝัััะธ ัะตะฑั (ะธะฝะฒะตััะธั ะทะฐะฒะธัะธะผะพััะตะน)
- ะขะตะฟะตัั: DiagnosticOrchestrator ะบะพะพัะดะธะฝะธััะตั ะพะฑะฐ ะบะพะผะฟะพะฝะตะฝัะฐ

**ะกัะฐััั ัะตัะฐะบัะพัะธะฝะณะฐ:**
| ะะพะดัะปั | ะคะฐะนะป | ะกััะพะบ | ะกัะฐััั |
|--------|------|-------|--------|
| MainViewModelRefactored | `ViewModels/MainViewModelRefactored.cs` | ~430 | โ ะกะพะทะดะฐะฝ |
| BypassController | `ViewModels/BypassController.cs` | ~510 | โ ะกะพะทะดะฐะฝ |
| DiagnosticOrchestrator | `ViewModels/DiagnosticOrchestrator.cs` | ~560 | โ ะะฑะฝะพะฒะปัะฝ |
| TestResultsManager | `ViewModels/TestResultsManager.cs` | ~490 | โ ะกะพะทะดะฐะฝ |
| TrafficCollector | `Utils/TrafficCollector.cs` | ~290 | โ NEW |
| LiveTestingPipeline | `Utils/LiveTestingPipeline.cs` | ~216 | โ ะะตัะฐะบัะพััะฝ |
| TrafficAnalyzer | `Utils/TrafficAnalyzer.cs` | ~1034 | โ๏ธ DEPRECATED |
| TrafficAnalyzerDualLayer | `Utils/TrafficAnalyzerDualLayer.cs` | ~752 | ๐๏ธ ะฃะดะฐะปะธัั |
| MainWindow ะฟะตัะตะบะปััะตะฝะธะต | `MainWindow.xaml.cs` | โณ TODO |

**ะะฐะบ ะฐะบัะธะฒะธัะพะฒะฐัั ะฝะพะฒัั ะฐััะธัะตะบัััั:**
```csharp
// MainWindow.xaml.cs โ ะทะฐะผะตะฝะธัั:
DataContext = new MainViewModel();
// ะะฐ:
DataContext = new MainViewModelRefactored();
```

**ะะปััะตะฒัะต ะธะทะผะตะฝะตะฝะธั ะดะปั ัะตะปะตะฒะพะน ะฐััะธัะตะบัััั:**

| ะกะตะนัะฐั (ะฟะปะพัะพ) | ะฆะตะปะตะฒะฐั (ะฟัะฐะฒะธะปัะฝะพ) |
|----------------|---------------------|
| TrafficAnalyzer ัะพะทะดะฐัั Pipeline | MainViewModel ัะพะทะดะฐัั ะพะฑะฐ |
| Pipeline ะฒะฝัััะธ Analyzer | Analyzer ะธ Pipeline โ ัะฐะฒะฝะพะฟัะฐะฒะฝัะต |
| ะัััะบะฐั ัะฒัะทั | ะกะฒัะทั ัะตัะตะท ัะพะฑััะธั |
| TrafficAnalyzer ะทะฝะฐะตั ะฟัะพ bypass | TrafficAnalyzer ัะพะปัะบะพ ัะพะฑะธัะฐะตั |

**ะัะธะฝัะธะฟั ัะตะปะตะฒะพะน ะฐััะธัะตะบัััั:**
1. **Single Responsibility** โ ะบะฐะถะดัะน ะบะพะผะฟะพะฝะตะฝั ะดะตะปะฐะตั ะพะดะฝะพ
2. **Dependency Inversion** โ ะบะพะผะฟะพะฝะตะฝัั ะฝะต ะทะฝะฐัั ะดััะณ ะพ ะดััะณะต
3. **Event-driven** โ ัะฒัะทั ัะตัะตะท `OnHostDiscovered`, `OnBlockageDetected`

---

#### โ #2 ะฃะดะฐะปะตะฝะธะต ะผัััะฒะพะณะพ ะบะพะดะฐ โ ะะะขะะะ
**ะฆะตะปั:** ะงะธััะฐั ะบะพะดะพะฒะฐั ะฑะฐะทะฐ, ะผะตะฝััะต ะฟััะฐะฝะธัั

**ะฃะดะฐะปะตะฝะพ:**
- [x] `Models/FixHistory.cs`
- [x] `AuditRunner.cs`
- [x] `Output/` ะฟะฐะฟะบะฐ
- [x] `WinDivertBypassEnforcer.cs` + `IBypassEnforcer.cs`
- [x] `OutputType` โ `WinExe` (ัะฑัะฐะฝะพ ะผะตะปัะบะฐะฝะธะต ะบะพะฝัะพะปะธ)

---

#### #3 ะะบะปััะธัั Socket Layer ะผะพะฝะธัะพัะธะฝะณ โฑ๏ธ 1-2ั
**ะฆะตะปั:** ะกะพะฑััะธะนะฝัะน ะผะพะฝะธัะพัะธะฝะณ ะฒะผะตััะพ polling (ัะพัะฝะตะต + ะผะตะฝััะต ะฝะฐะณััะทะบะธ)

**ะะพะฝัะตะบัั:** ะัะธ `AutoBypass=true` (ัะผะพะปัะฐะฝะธะต) FlowMonitor ะะกะะะะ ะฒ Watcher (polling) ัะตะถะธะผะต. Flow/Socket WinDivert layers ะฝะธะบะพะณะดะฐ ะฝะต ะธัะฟะพะปัะทััััั. ะะ: `Sniff` ัะปะฐะณ ะะ ะบะพะฝัะปะธะบััะตั ั bypass `None` ัะปะฐะณะพะผ!

**ะะฐะดะฐัะธ:**
- [ ] ะขะตัั: ะฒะบะปััะธัั Socket Layer ะฟะฐัะฐะปะปะตะปัะฝะพ ั bypass, ะฟัะพะฒะตัะธัั ะบะพะฝัะปะธะบั
- [ ] ะัะปะธ ัะฐะฑะพัะฐะตั โ ะธัะฟะพะปัะทะพะฒะฐัั Socket ะฒะผะตััะพ polling
- [ ] ะฃะดะฐะปะธัั Flow Layer ะบะพะด (`RunMonitorLoop`) โ ะธะทะฑััะพัะตะฝ ะฟัะธ Socket
- [ ] ะะฑะฝะพะฒะธัั `UseWatcherMode` ะปะพะณะธะบั

---

### ะคะฐะทะฐ 2: ะฃะปัััะตะฝะธะต ะดะตัะตะบัะธะธ (ะะะะะ)

#### #4 Retransmission tracking โฑ๏ธ 4-6ั
**ะฆะตะปั:** ะะปะฐะฒะฝัะน ะธะฝะดะธะบะฐัะพั DPI โ ะบะปะธะตะฝั ะฟะตัะตะพัะฟัะฐะฒะปัะตั ะทะฐะฟัะพัั

**ะะฐะดะฐัะธ:**
- [ ] ะงะตัะตะท WinDivert Sniff layer ะพััะปะตะถะธะฒะฐัั TCP seq numbers
- [ ] ะกััััะธะบ ัะตััะฐะฝัะผะธััะธะน per-host
- [ ] ะะพัะพะณ (3 ัะตััะฐะฝัะผะธััะธะธ) โ ะฑะปะพะบะธัะพะฒะบะฐ
- [ ] ะะฝัะตะณัะฐัะธั ั `StandardBlockageClassifier`

---

#### #5 HTTP redirect detection โฑ๏ธ 2-3ั
**ะฆะตะปั:** ะะตัะตะบัะธัะพะฒะฐัั DPI ะทะฐะณะปััะบะธ ะฟัะพะฒะฐะนะดะตัะฐ

**ะะฐะดะฐัะธ:**
- [ ] ะะฝะฐะปะธะท HTTP ะพัะฒะตัะพะฒ (Location header)
- [ ] ะกัะฐะฒะฝะตะฝะธะต ะดะพะผะตะฝะฐ ัะตะดะธัะตะบัะฐ ั ะพัะธะณะธะฝะฐะปัะฝัะผ
- [ ] ะัะปะธ SLD ะพัะปะธัะฐะตััั โ DPI redirect
- [ ] BlockageType = "HTTP_REDIRECT"

---

#### #6 Fail counter ั time window โฑ๏ธ 1ั
**ะฆะตะปั:** ะะฐัะธัะฐ ะพั false positives

**ะะฐะดะฐัะธ:**
- [ ] N ัะตะนะปะพะฒ ะทะฐ M ัะตะบัะฝะด = ะฑะปะพะบะธัะพะฒะบะฐ (default: 3/60)
- [ ] ะกะฑัะพั ัััััะธะบะฐ ะฟัะธ ััะฟะตัะต
- [ ] ะะพะฝัะธะณััะธััะตะผัะต ะฟะฐัะฐะผะตััั

---

### ะคะฐะทะฐ 3: UX ะธ polish (ะะะะะะ ะะะะะะะขะะข)

#### #7 UI ะธะฝะดะธะบะฐัะธั ะพัะธะฑะพะบ bypass โฑ๏ธ 1ั
- [ ] ะกะพััะพัะฝะธะต `Faulted` ะฟะพะบะฐะทัะฒะฐัั ะฒ UI (ะบัะฐัะฝัะน ะฑะตะนะดะถ)
- [ ] Tooltip ั ะฟัะธัะธะฝะพะน ะพัะธะฑะบะธ

#### #8 OutputType=WinExe โฑ๏ธ 5ะผะธะฝ
- [ ] ะะทะผะตะฝะธัั ะฒ `.csproj` โ ัะฑัะฐัั ะผะตะปัะบะฐะฝะธะต ะบะพะฝัะพะปะธ

#### #9 Global exception handler โฑ๏ธ 30ะผะธะฝ
- [ ] ะะพะฑะฐะฒะธัั ะฒ `App.xaml.cs`
- [ ] MessageBox ั ะพัะธะฑะบะพะน ะฒะผะตััะพ ะบัััะฐ

#### #10 ะัะตะดัะฟัะตะถะดะตะฝะธะต ะฑะตะท ะฐะดะผะธะฝ ะฟัะฐะฒ โฑ๏ธ 30ะผะธะฝ
- [ ] ะฏะฒะฝะพะต ัะพะพะฑัะตะฝะธะต "ะะฐะฟัััะธัะต ะพั ะฐะดะผะธะฝะธัััะฐัะพัะฐ"

---

## 3. ะัะธะฝัััะต ัะตัะตะฝะธั

### โ ะะะจะะะะ: Flow/Socket ะผะพะฝะธัะพัะธะฝะณ
**ะะฐัะธะฐะฝั C: ะะบะปััะธัั Socket Layer ะฟะฐัะฐะปะปะตะปัะฝะพ ั bypass**
- Socket Layer (Sniff+RecvOnly) ะะ ะบะพะฝัะปะธะบััะตั ั BypassManager (None)
- ะกะพะฑััะธะนะฝะฐั ะผะพะดะตะปั ัะพัะฝะตะต polling
- Flow Layer ัะดะฐะปะธัั โ ะธะทะฑััะพัะตะฝ ะฟัะธ Socket

### โ ะะะจะะะะ: GameProfile
**ะฃะดะฐะปะธัั** โ ัะพััะฐะฝัะตััั ะฝะพ ะฝะต ะธัะฟะพะปัะทัะตััั, ะผัััะฒัะน ะบะพะด

### โ ะะะจะะะะ: BypassCoordinator
**ะะฝัะตะณัะธัะพะฒะฐัั** โ ัะถะต ะฝะฐะฟะธัะฐะฝ, ัะพะดะตัะถะธั ะฝัะถะฝัั ะปะพะณะธะบั:
- ะัะพะฑัะตั ัััะฐัะตะณะธะธ ะฟะพ ะพัะตัะตะดะธ
- ะะตัะธััะตั ัะฐะฑะพัะฐััะธะต ะดะปั ัะพััะพะฒ
- ะะตัะตััะธััะตั ะฟะพัะปะต ะฟัะธะผะตะฝะตะฝะธั

### โ ะะะจะะะะ: LiveTestingPipeline
**ะะตัะตะดะตะปะฐัั** โ ัะฑัะฐัั ัะพะทะดะฐะฝะธะต pipeline ะฒะฝัััะธ TrafficAnalyzer:
- TrafficAnalyzer โ ัะพะปัะบะพ `IAsyncEnumerable<HostDiscovered>`
- BypassCoordinator ะฟะพะดะฟะธััะฒะฐะตััั, ะบะพะพัะดะธะฝะธััะตั
- Pipeline ััะฐะฝะพะฒะธััั helper ะดะปั ะฟะฐัะฐะปะปะตะปัะฝะพะณะพ ัะตััะธัะพะฒะฐะฝะธั

---

# ะงะฐััั II: ะะะ ะฃะกะขะะะะะ (ะกะฟัะฐะฒะพัะฝะธะบ)

## 4. ะะฑัะฐั ะฐััะธัะตะบัััะฐ

### ะขะพัะบะฐ ะฒัะพะดะฐ
```
Program.Main()
โโโ GUI Mode (args.Length == 0)
โ   โโโ TryHideConsoleWindow()  โ ะฃะะะะะขะฌ ะฟะพัะปะต OutputType=WinExe
โ   โโโ new App().Run() โ MainWindow โ MainViewModel
โ
โโโ CLI Mode โ ะฃะะะะะขะฌ ะฒะตัั CLI ะบะพะด
```

### ะัะฝะพะฒะฝะพะน flow ะดะธะฐะณะฝะพััะธะบะธ
```
MainViewModel.RunLivePipelineAsync()
โ
โโโ 1. ะัะพะฒะตัะบะฐ ะฟัะฐะฒ ะฐะดะผะธะฝะฐ
โโโ 2. ScreenState = "running"
โโโ 3. DNS flush
โโโ 4. ะกะพะทะดะฐะฝะธะต OverlayWindow
โโโ 5. ะะฐะฟััะบ ะผะพะฝะธัะพัะธะฝะณะฐ (FlowMonitor, NetworkMonitor, DnsParser, PidTracker)
โโโ 6. ะะฐะฟััะบ ัะตะปะตะฒะพะณะพ ะฟัะพัะตััะฐ
โโโ 7. Bypass ะฒะบะปััะตะฝะธะต (ะตัะปะธ admin)
โโโ 8. TrafficAnalyzer.AnalyzeProcessTrafficAsync() โ ะะะะะะะฃะฎะฉะะ
โโโ 9. ะะฐะบัััะธะต overlay
โโโ 10. ScreenState = "done"
```

### ะกะพััะพัะฝะธั UI
```
"start"   โ ะฝะฐัะฐะปัะฝัะน ัะบัะฐะฝ
"running" โ ะดะธะฐะณะฝะพััะธะบะฐ ะธะดัั (+ OverlayWindow)
"done"    โ ัะตะทัะปััะฐัั
```

---

## 5. Bypass ัะธััะตะผะฐ

### WinDivertBypassManager

**ะกะพััะพัะฝะธั:** `Disabled โ Enabling โ Enabled โ Disabling โ Disabled` (+ `Faulted`)

**TLS ัััะฐัะตะณะธะธ:**
| ะกััะฐัะตะณะธั | ะะฟะธัะฐะฝะธะต |
|-----------|----------|
| Fragment | ะคัะฐะณะผะตะฝัั ะฒ ะฟะพััะดะบะต 1โ2 |
| Disorder | ะคัะฐะณะผะตะฝัั ะฒ ะฟะพััะดะบะต 2โ1 (ัััะตะบัะธะฒะฝะตะต) |
| Fake | Fake ะฟะฐะบะตั ั ะบะพัะพัะบะธะผ TTL |
| FakeFragment | Fake + Fragment |
| FakeDisorder | Fake + Disorder |

**Worker'ั:**
| Worker | ะัะธะพัะธัะตั | ะงัะพ ะดะตะปะฐะตั |
|--------|-----------|------------|
| RstBlocker | 0 (ะฒััะพะบะธะน) | ะัะพะฟะฐะตั TCP RST ะพั ะฟัะพะฒะฐะนะดะตัะฐ |
| TlsFragmenter | 200 (ะฝะธะทะบะธะน) | ะคัะฐะณะผะตะฝัะธััะตั TLS ClientHello |

**ะคะธะปััั:** ะกะตะนัะฐั ะณะปะพะฑะฐะปัะฝัะน `tcp.DstPort == 443` โ ะฒะปะธัะตั ะฝะฐ ะะกะ HTTPS.

### BypassCoordinator (โ ะะะขะะะะะะะะะ)

**ะะพะปั:** ะฆะตะฝััะฐะปัะฝัะน "ะผะพะทะณ" ัะฟัะฐะฒะปะตะฝะธั bypass-ัััะฐัะตะณะธัะผะธ.

**ะะปััะตะฒัะต ะผะตัะพะดั:**
- `AutoFixLiveAsync()` โ ะณะปะฐะฒะฝัะน ะผะตัะพะด ะดะปั live-ัะตััะธัะพะฒะฐะฝะธั
- `AutoFixAsync()` โ ะดะปั ะฟัะพัะธะปัะฝะพะณะพ ัะตััะธัะพะฒะฐะฝะธั
- `SuggestFixes()` โ ัะตะบะพะผะตะฝะดะฐัะธะธ ะฑะตะท ะฟัะธะผะตะฝะตะฝะธั

**ะะพะณะธะบะฐ:**
1. ะัะพะฒะตััะตั ะบะตั ัะฐะฑะพัะฐััะธั ัััะฐัะตะณะธะน ะดะปั ัะพััะฐ
2. ะะตัะตะฑะธัะฐะตั `StrategyMapping.GetStrategiesFor(result).Applicable`
3. ะะพัะปะต ะบะฐะถะดะพะน ัััะฐัะตะณะธะธ ะดะตะปะฐะตั ัะตัะตัั ัะตัะตะท callback
4. ะะตัะธััะตั ััะฟะตัะฝัั ัััะฐัะตะณะธั
5. ะัะธ ะฝะตัะดะฐัะต ะฒัะตั ัััะฐัะตะณะธะน โ `DisableAsync()`

---

## 6. ะะพะฝะธัะพัะธะฝะณ ะธ ะดะตัะตะบัะธั

### WinDivert Layers

| Layer | Flags | ะะฐะทะฝะฐัะตะฝะธะต |
|-------|-------|------------|
| Network + Sniff | ะขะพะปัะบะพ ะบะพะฟะธััะตั | DNS ะทะฐัะฒะฐั (NetworkMonitor) |
| Flow + Sniff+RecvOnly | ะขะพะปัะบะพ ัะธัะฐะตั | ะกะพะฑััะธั ัะพะตะดะธะฝะตะฝะธะน (ะะ ะะกะะะะฌะะฃะะขะกะฏ) |
| Socket + Sniff+RecvOnly | ะขะพะปัะบะพ ัะธัะฐะตั | ะกะพะฑััะธั connect (ะะ ะะกะะะะฌะะฃะะขะกะฏ) |
| Network + None | ะะตัะตัะฒะฐััะฒะฐะตั | RST blocker, TLS fragmenter |

**ะะปััะตะฒะพะต:** `Sniff` ะะ ะบะพะฝัะปะธะบััะตั ั `None` โ ะผะพะถะฝะพ ะธัะฟะพะปัะทะพะฒะฐัั ะฟะฐัะฐะปะปะตะปัะฝะพ!

### FlowMonitorService

**ะะฒะฐ ัะตะถะธะผะฐ:**
1. **WinDivert (Socket/Flow)** โ ัะพะฑััะธะนะฝัะน, ัะพัะฝัะน
2. **IP Helper API polling** โ ะบะฐะถะดัั ัะตะบัะฝะดั, ะผะตะฝะตะต ัะพัะฝัะน

**ะขะตะบััะตะต:** ะัะธ `AutoBypass=true` (ัะผะพะปัะฐะฝะธะต) ะะกะะะะ polling. WinDivert ัะตะถะธะผ โ ะผัััะฒัะน ะบะพะด.

### ะะตัะตะบัะธั ะฑะปะพะบะธัะพะฒะพะบ (StandardHostTester + StandardBlockageClassifier)

**BlockageType:**
- `TCP_RST` โ SocketError.ConnectionReset
- `TCP_TIMEOUT` โ Task.Delay(3000) ะฒัะธะณัะฐะป
- `TLS_DPI` โ AuthenticationException
- `PORT_CLOSED` โ SocketError.ConnectionRefused
- `FAKE_IP` โ IP ะฒ 198.18.x.x ะดะธะฐะฟะฐะทะพะฝะต

**ะกััะฐัะตะณะธะธ (StrategyMapping):**
```
DNS_FILTERED/DNS_BOGUS โ DOH (ัััะฝะพะต)
TcpOk && !TlsOk โ DROP_RST, TLS_FRAGMENT, TLS_FAKE
!TcpOk && ะฑััััะพ (<200ms) โ DROP_RST (RST injection)
!TcpOk && ะผะตะดะปะตะฝะฝะพ (>2000ms) โ PROXY (ัััะฝะพะต)
```

---

## 7. UI ะธ ViewModel

### MainViewModel (~2400 ัััะพะบ)

**ะะฝะธัะธะฐะปะธะทะฐัะธั:**
```csharp
MainViewModel()
โโโ InitializeTestResults()
โโโ ะกะพะทะดะฐะฝะธะต ะบะพะผะฐะฝะด
โโโ LoadFixHistory()  โ ะฃะะะะะขะฌ (ะผัััะฒัะน ะบะพะด)
โโโ InitializeBypassOnStartupAsync()  // ะะฒัะพ-ะฒะบะปััะตะฝะธะต bypass
โโโ CheckVpnStatus()
```

**ะะฒัะพ-bypass ะฟัะธ ััะฐััะต (ั ะฐะดะผะธะฝ ะฟัะฐะฒะฐะผะธ):**
```csharp
_isFragmentEnabled = true;
_isDropRstEnabled = true;
_isDoHEnabled = true;
await ApplyBypassOptionsAsync();
```

### Bypass Control Panel

| ะะฝะพะฟะบะฐ | ะกะฒะพะนััะฒะพ | ะะฟะธัะฐะฝะธะต |
|--------|----------|----------|
| Fragment | IsFragmentEnabled | TLS ััะฐะณะผะตะฝัะฐัะธั 1โ2 |
| Disorder | IsDisorderEnabled | TLS ััะฐะณะผะตะฝัะฐัะธั 2โ1 |
| Fake | IsFakeEnabled | Fake TTL ะฟะฐะบะตั |
| DROP RST | IsDropRstEnabled | ะะปะพะบะธัะพะฒะบะฐ TCP RST |
| DoH | IsDoHEnabled | DNS-over-HTTPS |

**Fragment ะธ Disorder ะฒะทะฐะธะผะพะธัะบะปััะฐััะธะต** โ ะฒะบะปััะตะฝะธะต ะพะดะฝะพะณะพ ะพัะบะปััะฐะตั ะดััะณะพะต.

---

## 8. ะคะฐะนะปะพะฒะฐั ััััะบัััะฐ

### ะขะตะบััะฐั ััััะบัััะฐ (ะฟะพัะปะต ัะตัะฐะบัะพัะธะฝะณะฐ 01.12.2025)
```
ISP_Audit/
โโโ Program.cs                    # ะขะพัะบะฐ ะฒัะพะดะฐ (GUI only)
โโโ App.xaml(.cs)                 # WPF Application
โโโ MainWindow.xaml(.cs)          # ะะปะฐะฒะฝะพะต ะพะบะฝะพ
โ
โโโ ViewModels/
โ   โโโ MainViewModel.cs          # ะะปะฐะฒะฝะฐั ะปะพะณะธะบะฐ
โ
โโโ Bypass/
โ   โโโ WinDivertBypassManager.cs # ะฃะฟัะฐะฒะปะตะฝะธะต WinDivert
โ   โโโ BypassProfile.cs          # ะัะพัะธะปั bypass
โ   โโโ BypassCoordinator.cs      # โ ะฆะตะฝััะฐะปัะฝัะน ะผะพะทะณ bypass
โ   โโโ StrategyMapping.cs        # ะะฐะฟะฟะธะฝะณ ัััะฐัะตะณะธะน
โ   โโโ WinDivertNative.cs        # P/Invoke
โ
โโโ Core/
โ   โโโ Interfaces/
โ   โ   โโโ IHostTester.cs
โ   โ   โโโ IBlockageClassifier.cs
โ   โโโ Models/
โ   โโโ Modules/
โ       โโโ StandardHostTester.cs
โ       โโโ StandardBlockageClassifier.cs
โ
โโโ Utils/
โ   โโโ TrafficAnalyzer.cs        # ะกะฑะพั ััะฐัะธะบะฐ
โ   โโโ LiveTestingPipeline.cs    # โ ะัะฟะพะปัะทัะตั BypassCoordinator
โ   โโโ FlowMonitorService.cs     # โณ TODO: Socket Layer
โ   โโโ ...
โ
โโโ Models/
โ   โโโ Target.cs
โ   โโโ TestResult.cs
โ
โโโ Profiles/
โ   โโโ Default.json
โ
โโโ native/
โ   โโโ WinDivert64.sys
โ   โโโ WinDivert.dll
โ
โโโ TestNetworkApp/               # ะขะตััะพะฒะพะต ะฟัะธะปะพะถะตะฝะธะต
```

### ะกะปะตะดัััะธะต ัะฐะณะธ (TODO)
- [ ] ะะบะปััะธัั Socket Layer ะผะพะฝะธัะพัะธะฝะณ (ัะพะฑััะธะนะฝะฐั ะผะพะดะตะปั)
- [ ] ะฃะปัััะธัั ะดะตัะตะบัะธั: TCP Retransmissions, HTTP redirects
- [ ] ะััะฝะพะต ัะตััะธัะพะฒะฐะฝะธะต: YouTube, Discord, rutracker

---

## ะกะธััะตะผะฝัะต ััะตะฑะพะฒะฐะฝะธั

### ะัะฐะฒะฐ ะฐะดะผะธะฝะธัััะฐัะพัะฐ
- **ะขัะตะฑััััั** โ `app.manifest` ัะพะดะตัะถะธั `requireAdministrator`
- WinDivert ะฝะต ัะฐะฑะพัะฐะตั ะฑะตะท ะฐะดะผะธะฝ ะฟัะฐะฒ
- ะะตะท ะฐะดะผะธะฝะฐ: bypass ะพัะบะปัััะฝ, ะบะฝะพะฟะบะธ ะฝะตะฐะบัะธะฒะฝั

### VPN ะดะตัะตะบัะธั
```csharp
// NetUtils.LikelyVpnActive() ะฟัะพะฒะตััะตั:
// - TAP/TUN ะฐะดะฐะฟัะตัั
// - WireGuard, OpenVPN, IKEv2
// - ะะผะตะฝะฐ ัะพะดะตัะถะฐัะธะต "vpn"
```

### WinDivert
- ะัะฐะนะฒะตั `WinDivert64.sys` ะฒ `native/`
- ะฃะดะฐะปะตะฝะธะต: `sc delete WinDivert`

---

## Changelog ะดะพะบัะผะตะฝัะฐ

| ะะฐัะฐ | ะะทะผะตะฝะตะฝะธั |
|------|-----------|
| 02.12.2025 | **TrafficCollector:** TrafficAnalyzer ะทะฐะผะตะฝัะฝ ะฝะฐ TrafficCollector (SRP, IAsyncEnumerable). DiagnosticOrchestrator ัะตะฟะตัั ะบะพะพัะดะธะฝะธััะตั Collector + Pipeline. TrafficAnalyzer ะฟะพะผะตัะตะฝ ะบะฐะบ DEPRECATED |
| 02.12.2025 | **ะะตัะฐะบัะพัะธะฝะณ MainViewModel:** ะดะพะฑะฐะฒะปะตะฝั BypassController, DiagnosticOrchestrator, TestResultsManager, MainViewModelRefactored. ะะธะฐะณัะฐะผะผะฐ ะพะฑะฝะพะฒะปะตะฝะฐ ั ะฟะพะผะตัะบะฐะผะธ โ NEW |
| 01.12.2025 | **ะฆะตะปะตะฒะฐั ะฐััะธัะตะบัััะฐ:** ะดะพะฑะฐะฒะปะตะฝะฐ ะดะธะฐะณัะฐะผะผะฐ ะธ ะฟัะธะฝัะธะฟั ัะตัะฐะบัะพัะธะฝะณะฐ (TrafficAnalyzer ะฝะต ะดะพะปะถะตะฝ ัะพะทะดะฐะฒะฐัั Pipeline) |
| 01.12.2025 | **ะะตัะฐะบัะพัะธะฝะณ:** BypassCoordinator ะธะฝัะตะณัะธัะพะฒะฐะฝ, WinDivertBypassEnforcer/IBypassEnforcer ัะดะฐะปะตะฝั, ะผัััะฒัะน ะบะพะด ะพัะธัะตะฝ |
| 01.12.2025 | ะะตััััะบัััะธะทะฐัะธั: ะบัะธัะธัะตัะบะธะต ะฟัะพะฑะปะตะผั ะฒ ะฝะฐัะฐะปะพ, ะฟะปะฐะฝ ัะฐะฑะพั, ะฟัะธะฝัััะต ัะตัะตะฝะธั |
| 27.11.2025 | ะะพะฑะฐะฒะปะตะฝะพ ััะฐะฒะฝะตะฝะธะต ะดะตัะตะบัะธะธ ั Zapret |
| 27.11.2025 | ะะพะฑะฐะฒะปะตะฝะพ ััะฐะฒะฝะตะฝะธะต bypass ะผะตัะพะดะพะฒ ั GoodbyeDPI/Zapret |
| 27.11.2025 | ะะตัะฒะธัะฝัะน ะฐะฝะฐะปะธะท ะฐััะธัะตะบัััั |
