# ISP_Audit (русская версия)

Автономный однофайловый инструмент для Windows (single‑file, self‑contained .NET), который выполняет быстрые сетевые проверки для диагностики поведения провайдера: DNS‑подмена/фильтрация, доступность TCP портов, доступность UDP/QUIC (через UDP‑DNS), HTTPS/TLS/SNI, трассировка (обёртка над `tracert`) и эвристика RST‑инжекции. Результаты выводятся в человекочитаемом виде и сохраняются в структурированный JSON‑отчёт.

По умолчанию запускается GUI. CLI доступен при запуске с аргументами.

## Сборка

Требуется .NET 9 SDK.

- Отладочная сборка: `dotnet build -c Debug`
- Публикация single‑file: `dotnet publish -c Release -r win-x64 /p:PublishSingleFile=true /p:SelfContained=true /p:PublishTrimmed=false -o ./publish`

GitHub Actions workflow: `.github/workflows/build.yml` — собирает `ISP_Audit.exe` и выкладывает артефакт.

## Использование (GUI)

- Запустите `ISP_Audit.exe` без аргументов — откроется окно.
- Верхняя панель (авто‑размер, не обрезает текст, DPI‑дружелюбно):
- Кнопки: `Запустить`, `Отмена`, `Сохранить JSON`, `Экспорт HTML/PDF`, `Показать отчёт` (немодально, основная форма не блокируется), а также `Сохранить профиль` / `Загрузить профиль` для обмена настройками.
  - Чекбоксы включения тестов: `DNS`, `TCP`, `HTTP`, `Traceroute`, `UDP`, `RST`.
- Поля `Порты` (список/диапазоны TCP для проверки) и `Таймаут, с` — глобальный таймаут для сетевых операций (по умолчанию HTTP=12с, TCP/UDP=3с).
- Справа сверху — таблица шагов с живыми статусами: ожидание → выполняется… → пройден (зелёный)/не пройден (красный). Отдельная строка состояния и прогресс‑бар.
- Справа снизу — подробный лог (моноширинный шрифт Consolas). Для `Traceroute` хопы выводятся потоково в реальном времени; кодировка фикcирована (OEM866) — без «кракозябр».
- Слева — список целей (имя/домен/сервис), редактируемый: Add/Update, Remove.
- Блок «Обход блокировок» отображает подсказку о необходимости прав администратора, текущий статус драйвера WinDivert и кнопку включения обхода. Кнопка становится активной только после обнаружения проблем в диагностике, чтобы избежать лишних манипуляций без показаний.
- Кнопка `Сохранить JSON` не блокирует форму: файл сохраняется в выбранный путь; ошибки отображаются диалогом. Рядом расположена кнопка `Экспорт HTML/PDF`, которая собирает наглядный отчёт с версткой для вложения в тикет или письма.
- В блоке итогов доступны кнопки `Скопировать итог` (компактный текст со статусами и рекомендациями) и `Скопировать отчёт`.
- Профили диагностики (`*.iaprofile`) позволяют сохранить текущие цели, набор портов и включённые тесты и отправить файл другому пользователю для воспроизведения проверки.

## Использование (CLI)

Примеры:

- По умолчанию + сохранить отчёт:  
  `ISP_Audit.exe --report isp_report.json`
- Явные цели и короткий JSON в stdout:  
  `ISP_Audit.exe --targets youtube.com,discord.com --json --report result.json`
- Отключить трассировку и увеличить таймауты:  
  `ISP_Audit.exe --no-trace --timeout 12 --verbose`

Флаги:

- `--targets <file|list>` список через запятую или путь к JSON/CSV
- `--report <path>` путь для JSON‑отчёта (по умолчанию `isp_report.json` в CWD)
- `--timeout <s>` таймаут в секундах (HTTP=12с, TCP/UDP=3с по умолчанию)
- `--ports <list>` список TCP‑портов (по умолчанию `80,443,8000-8020`)
- `--no-trace` отключить вызов системного `tracert`
- `--verbose` подробный лог в консоли
- `--json` вывести короткий JSON‑сводку в stdout
- `--help` показать справку

Цели по умолчанию: инфраструктура Star Citizen — портал и аккаунты (`*.robertsspaceindustries.com`), лаунчер, CDN и игровые шлюзы (`p4*-live.cloudimperiumgames.com`).
Предустановки (домены, TCP и UDP проверки) описаны в файле `star_citizen_targets.json`, который копируется рядом с исполняемым файлом; при необходимости обновите его вручную.

Примечание: при запуске с аргументами всегда используется CLI; без аргументов — открывается GUI.

## Формат отчёта (JSON)

Пример верхнего уровня:

``` 
{ 
  "run_at": "2025-10-24T15:00:00Z", 
  "cli": "--report report.json", 
  "ext_ip": "185.53.46.108", 
  "summary": { 
    "dns": "OK|WARN|DNS_FILTERED|DNS_BOGUS", 
    "tcp": "OK|FAIL|UNKNOWN", 
    "udp": "OK|FAIL|INFO|UNKNOWN", 
    "tls": "OK|SUSPECT|FAIL|UNKNOWN", 
    "rst_inject": "UNKNOWN" 
  }, 
  "targets": { 
    "RSI Лаунчер": { 
      "host": "launcher.robertsspaceindustries.com", 
      "service": "Лаунчер", 
      "system_dns": ["23.215.0.138"], 
      "doh": ["23.215.0.140"], 
      "dns_status": "OK", 
      "tcp": [ 
        {"ip":"23.215.0.138","port":80,"open":true,"elapsed_ms":45}, 
        {"ip":"23.215.0.138","port":443,"open":true,"elapsed_ms":48} 
      ], 
      "http": [ 
        {"url":"https://launcher.robertsspaceindustries.com","success":true,"status":200,"serverHeader":"", "cert_cn":"*.robertsspaceindustries.com"} 
      ], 
      "traceroute": {"hops":[{"hop":1,"ip":"10.0.0.1","status":"TtlExpired"}]} 
    } 
  }, 
  "udp_tests": [ 
    { 
      "name": "Cloudflare DNS", 
      "service": "Базовая сеть", 
      "host": "1.1.1.1", 
      "port": 53, 
      "expect_reply": true, 
      "success": true, 
      "reply": true, 
      "rtt_ms": 12, 
      "reply_bytes": 128, 
      "note": "ответ получен", 
      "description": "Проверка UDP DNS" 
    }, 
    { 
      "name": "Star Citizen EU шлюз", 
      "service": "Игровые сервера", 
      "host": "p4eu-live.cloudimperiumgames.com", 
      "port": 64090, 
      "expect_reply": false, 
      "success": true, 
      "reply": false, 
      "rtt_ms": 1, 
      "reply_bytes": 0, 
      "note": "пакет отправлен", 
      "description": "Отправка тестового пакета, ответ не ожидается" 
    } 
  ] 
} 
``` 

## Правила определения статусов

- DNS:
  - `DNS_FILTERED` — системный DNS пуст, а DoH возвращает A‑записи.
  - `DNS_BOGUS` — системный DNS вернул 0.0.0.0/8, 127.0.0.0/8, 10/8, 172.16/12, 192.168/16.
  - `WARN` — множества системных и DoH‑адресов не пересекаются (возможно CDN/гео, но обратите внимание).
  - `OK` — остальные случаи.
- TCP: `OK`, если где‑то порт открыт; иначе `FAIL`.
- UDP: `OK`, если все тесты с ожидаемым ответом успешны; `FAIL`, если хотя бы один ожидаемый ответ не пришёл; `INFO`, если выполнялись только тесты без ожидания ответа (например, UDP-зонд к игровому шлюзу).
- TLS: `SUSPECT`, если 443 открыт, но HTTPS не проходит; `OK`, если есть 2xx/3xx; `FAIL`, если ни одного успеха.
- RST: `UNKNOWN` — эвристика по таймингам без pcap.

## Советы по устранению проблем

- `DNS_FILTERED / DNS_BOGUS`
  - Включите DoH/DoT (Chrome/Firefox/Windows 11), смените резолвер (1.1.1.1/8.8.8.8).
  - Возможные обходы: DoH/DoT, DNSCrypt, VPN, локальный резолвер (unbound) c TLS.
- `TCP = FAIL`
  - Проверьте локальный фаервол/антивирус/роутер/MTU, задержки DNS.
  - Обход: VPN/HTTPS‑прокси, смена сети/роутера.
- `UDP = FAIL`
  - Возможна блокировка UDP/QUIC. Используйте DoH/DoT вместо UDP‑DNS или VPN.
- `TLS = SUSPECT`
  - Возможна блокировка TLS/SNI. Обход: VPN, HTTPS‑прокси/HTTP2, ECH/ESNI (если доступно), временно зеркала по HTTP (без чувствительных данных).

## Соответствие текущей реализации

- GUI по умолчанию, современная верхняя панель (FlowLayoutPanel, AutoSize), русские подписи — есть.
- Прогресс по шагам, статус/цвета, прогресс‑бар, отмена выполнения — есть.
- Traceroute через системный `tracert`, потоковый вывод хопов, фикс кодировки — есть.
- UDP‑DNS на `1.1.1.1:53`, минимальный парсинг ответа — есть.
- DNS сравнение System vs DoH (Cloudflare), эвристика мусорных IP — есть.
- TCP‑порты по умолчанию 80/443 с повторной попыткой — есть.
- HTTP(S) запросы с SNI, чтение CN сертификата, таймауты — есть.
- JSON‑отчёт (summary + по целям) и человекочитаемые рекомендации — есть.
- Сборка single‑file win‑x64 + workflow GitHub Actions — есть.

## Ограничения и безопасность

- Во время запуска не используются внешние бинарники, кроме системного `tracert` (если недоступен — шаг пропускается).
- Raw‑сокеты, pcap и пр. не используются в основном билде (не требуются права администратора).
- По умолчанию ничего никуда не отправляется; отчёт хранится локально. Внешняя загрузка отчётов — только по явному флагу (не реализовано) и с токеном.
- Модуль обхода на базе WinDivert включается вручную, требует запуска от имени администратора и безопасно отключается при закрытии программы.

## Обход блокировок (WinDivert)

- Возможности: отбрасывание входящих/исходящих TCP RST, фрагментация TLS ClientHello, выборочная переадресация трафика Star Citizen (правила задаются в `bypass_profile.json`).
- Конфигурация `bypass_profile.json` копируется рядом с исполняемым файлом; правила можно включать/выключать и указывать альтернативные IP/порты.
- Для запуска требуется WinDivert.dll (одной версии с драйвером) и права администратора. При отсутствии условий драйвер не активируется, а статус в интерфейсе подсвечивается предупреждением.
- При обнаружении проблем в диагностике блок «Обход блокировок» позволяет включить WinDivert одним кликом, а повторное нажатие выключает фильтрацию.

## Частые вопросы

- Кнопки «узкие»/обрезается текст?
  - Верхняя панель авто‑размерная, элементы растягиваются под текст и DPI. Если всё же узко — укажите ваш масштаб/DPI и скриншот, подстроим отступы.
- «Показать отчёт» зависает?
  - Окно отчёта немодальное (`Show`), основная форма остаётся активной. Если видите зависание — укажите шаги воспроизведения.
- Трассировка «висит»?
  - Во время traceroute в лог идут строки хопов; в строке состояния видно текущий шаг. Можно прервать `Отмена`.
