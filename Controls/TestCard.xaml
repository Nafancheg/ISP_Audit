<UserControl x:Class="IspAudit.Controls.TestCard"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:local="clr-namespace:IspAudit.Controls">
    <Border Style="{StaticResource CardStyle}" Padding="20" Margin="0,0,0,0">
        <Border.ContextMenu>
            <ContextMenu>
                <MenuItem x:Name="CopyHostItem" Header="ÐšÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Host" Click="CopyHost_Click"/>
                <MenuItem x:Name="CopyFallbackIpItem" Header="ÐšÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Fallback IP" Click="CopyFallbackIp_Click"/>
            </ContextMenu>
        </Border.ContextMenu>
        <Grid>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="16"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <!-- Status Dot -->
            <local:StatusDot x:Name="statusDot" Grid.Column="0" VerticalAlignment="Top" Margin="0,2,0,0"/>

            <!-- Content -->
            <StackPanel Grid.Column="2">
                <!-- Title and Critical Badge -->
                <StackPanel Orientation="Horizontal" Margin="0,0,0,4">
                    <TextBlock x:Name="titleText" Style="{StaticResource BodyStyle}" FontWeight="Medium"/>
                    <Border x:Name="criticalBadge"
                            Background="#FEF3F2"
                            CornerRadius="6"
                            Padding="8,2"
                            Margin="8,0,0,0"
                            Visibility="Collapsed">
                        <TextBlock Text="ÐšÑ€Ð¸Ñ‚Ð¸Ñ‡Ð½Ñ‹Ð¹"
                                   Style="{StaticResource CaptionStyle}"
                                   Foreground="{StaticResource FailBrush}"/>
                    </Border>
                </StackPanel>

                <!-- Service -->
                <TextBlock x:Name="serviceText"
                           Style="{StaticResource BodyStyle}"
                           Foreground="{StaticResource MutedBrush}"
                           Margin="0,0,0,6"/>

                <!-- Host and Fallback -->
                <StackPanel Orientation="Horizontal">
                    <Border Background="#F3F4F6" CornerRadius="4" Padding="8,4" BorderBrush="#E5E7EB" BorderThickness="1">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="SNI / IP / rDNS: " Foreground="#6B7280" FontSize="11" VerticalAlignment="Center"/>
                            <TextBlock x:Name="hostText"
                                       Style="{StaticResource CaptionStyle}"
                                       FontFamily="Consolas"
                                       FontWeight="SemiBold"
                                       Foreground="#374151"
                                       TextWrapping="Wrap"/>
                        </StackPanel>
                    </Border>
                    <TextBlock x:Name="fallbackText"
                               Style="{StaticResource CaptionStyle}"
                               Margin="8,0,0,0"
                               Visibility="Collapsed"/>
                </StackPanel>

                <!-- Detection Badges -->
                <WrapPanel Orientation="Horizontal" Margin="0,6,0,0">
                    <!-- RST Injection Badge -->
                    <Border Background="#FEF2F2" CornerRadius="4" Padding="6,2" Margin="0,0,4,4"
                            Visibility="{Binding TestResult.IsRstInjection, Converter={StaticResource BoolToVisibilityConverter}}">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="âš¡ TCP RST" FontSize="10" FontWeight="SemiBold" Foreground="#DC2626"/>
                        </StackPanel>
                    </Border>

                    <!-- HTTP Redirect Badge -->
                    <Border Background="#FFF7ED" CornerRadius="4" Padding="6,2" Margin="0,0,4,4"
                            Visibility="{Binding TestResult.IsHttpRedirect, Converter={StaticResource BoolToVisibilityConverter}}">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="â†ª HTTP Redirect" FontSize="10" FontWeight="SemiBold" Foreground="#EA580C"/>
                        </StackPanel>
                    </Border>

                    <!-- Retransmission Badge -->
                    <Border Background="#EFF6FF" CornerRadius="4" Padding="6,2" Margin="0,0,4,4"
                            Visibility="{Binding TestResult.IsRetransmissionHeavy, Converter={StaticResource BoolToVisibilityConverter}}">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="ðŸ“‰ Packet Loss" FontSize="10" FontWeight="SemiBold" Foreground="#2563EB"/>
                        </StackPanel>
                    </Border>

                    <!-- UDP Blockage Badge -->
                    <Border Background="#FEF2F2" CornerRadius="4" Padding="6,2" Margin="0,0,4,4"
                            Visibility="{Binding TestResult.IsUdpBlockage, Converter={StaticResource BoolToVisibilityConverter}}">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="ðŸš« UDP Block" FontSize="10" FontWeight="SemiBold" Foreground="#DC2626"/>
                        </StackPanel>
                    </Border>

                    <!-- Semantic Groups status (P0.2 Stage 5.3) -->
                    <Border Background="#F3F4F6" CornerRadius="4" Padding="6,2" Margin="0,0,4,4"
                            Visibility="{Binding DataContext.BypassSemanticGroupsSummaryText, RelativeSource={RelativeSource AncestorType=Window}, Converter={StaticResource StringToVisibilityConverter}}">
                        <TextBlock Text="{Binding DataContext.BypassSemanticGroupsSummaryText, RelativeSource={RelativeSource AncestorType=Window}}"
                                   FontSize="10" FontWeight="SemiBold" Foreground="#374151" TextWrapping="Wrap"/>
                    </Border>

                    <!-- Applied strategy (per-card, after Apply/Connect) -->
                    <Border Background="#ECFDF3" CornerRadius="4" Padding="6,2" Margin="0,0,4,4"
                            Visibility="{Binding TestResult.AppliedBypassStrategy, Converter={StaticResource StringToVisibilityConverter}}">
                        <TextBlock Text="{Binding TestResult.AppliedBypassStrategy, StringFormat=ÐŸÑ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ð¾: {0}}"
                                   FontSize="10" FontWeight="SemiBold" Foreground="#166534" TextWrapping="Wrap"/>
                    </Border>

                    <!-- Post-Apply check status (P1.8) -->
                    <Border CornerRadius="4" Padding="6,2" Margin="0,0,4,4"
                            Visibility="{Binding TestResult.ShowPostApplyCheck, Converter={StaticResource BoolToVisibilityConverter}}">
                        <Border.Style>
                            <Style TargetType="Border">
                                <Setter Property="Background" Value="#F3F4F6"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding TestResult.PostApplyCheckStatus}" Value="Ok">
                                        <Setter Property="Background" Value="#ECFDF3"/>
                                    </DataTrigger>
                                    <DataTrigger Binding="{Binding TestResult.PostApplyCheckStatus}" Value="Fail">
                                        <Setter Property="Background" Value="#FEF2F2"/>
                                    </DataTrigger>
                                    <DataTrigger Binding="{Binding TestResult.PostApplyCheckStatus}" Value="Partial">
                                        <Setter Property="Background" Value="#FFF7ED"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Border.Style>
                        <TextBlock Text="{Binding TestResult.PostApplyCheckText}"
                                   FontSize="10" FontWeight="SemiBold" Foreground="#374151" TextWrapping="Wrap">
                            <TextBlock.Style>
                                <Style TargetType="TextBlock">
                                    <Setter Property="Foreground" Value="#374151"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding TestResult.PostApplyCheckStatus}" Value="Ok">
                                            <Setter Property="Foreground" Value="#166534"/>
                                        </DataTrigger>
                                        <DataTrigger Binding="{Binding TestResult.PostApplyCheckStatus}" Value="Fail">
                                            <Setter Property="Foreground" Value="#DC2626"/>
                                        </DataTrigger>
                                        <DataTrigger Binding="{Binding TestResult.PostApplyCheckStatus}" Value="Partial">
                                            <Setter Property="Foreground" Value="#EA580C"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </TextBlock.Style>
                        </TextBlock>
                    </Border>
                </WrapPanel>

                <!-- Status Text -->
                <TextBlock x:Name="statusText"
                           Style="{StaticResource CaptionStyle}"
                           Margin="0,8,0,0"
                           Visibility="Collapsed"/>
            </StackPanel>

            <!-- Action Button -->
            <StackPanel Grid.Column="3" VerticalAlignment="Center">
                <Button x:Name="detailsButton"
                        Style="{StaticResource SecondaryButtonStyle}"
                        Content="ÐŸÐ¾Ð´Ñ€Ð¾Ð±Ð½Ð¾ÑÑ‚Ð¸"
                        Command="{Binding DataContext.DetailsCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                        CommandParameter="{Binding TestResult, RelativeSource={RelativeSource AncestorType=local:TestCard}}"
                        Visibility="Collapsed"/>
            </StackPanel>
        </Grid>
    </Border>
</UserControl>
