using System;
using System.IO;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;

namespace IspAudit
{
    public class GuiForm : Form
    {
        private readonly Button btnRun;
        private readonly Button btnSaveJson;
        private readonly Button btnShowReport;
        private readonly CheckBox chkNoTrace;
        private readonly CheckBox chkDns;
        private readonly CheckBox chkTcp;
        private readonly CheckBox chkHttp;
        private readonly CheckBox chkUdp;
        private readonly CheckBox chkRst;
        private readonly TextBox txtTimeout;
        private readonly Label lblExtIp;
        private readonly ListView lvTargets;
        private readonly ListView lvSteps;
        private readonly TextBox txtName;
        private readonly TextBox txtHost;
        private readonly Button btnAdd;
        private readonly Button btnRemove;
        private readonly TextBox txtLog;
        private readonly TextBox txtAnalysis;
        private readonly ProgressBar pbOverall;
        private readonly Label lblStatus;

        // Store log for post-run analysis
        private readonly StringBuilder _logBuffer = new();
        private IspAudit.Output.RunReport? _lastRun;
        private IspAudit.Config _lastConfig = IspAudit.Config.Default();

        public GuiForm()\n        {\n            this.Font = new System.Drawing.Font("Segoe UI", 9F);
            Text = "ISP Audit";
            Width = 1100;
            Height = 720;

            btnRun = new Button { Text = "Запустить", Left = 10, Top = 10, Width = 100 };
            btnRun.Click += BtnRun_Click;

            btnSaveJson = new Button { Text = "Сохранить JSON", Left = 120, Top = 10, Width = 120 };
            btnSaveJson.Click += BtnSaveJson_Click;

            btnShowReport = new Button { Text = "Показать отчёт", Left = 245, Top = 10, Width = 120 };
            btnShowReport.Click += BtnShowReport_Click;

            chkDns = new CheckBox { Left = 370, Top = 14, Width = 60, Text = "DNS", Checked = true };
            chkTcp = new CheckBox { Left = 430, Top = 14, Width = 60, Text = "TCP", Checked = true };
            chkHttp = new CheckBox { Left = 490, Top = 14, Width = 65, Text = "HTTP", Checked = true };
            chkNoTrace = new CheckBox { Left = 555, Top = 14, Width = 100, Text = "Traceroute", Checked = true };
            chkUdp = new CheckBox { Left = 660, Top = 14, Width = 70, Text = "UDP", Checked = true };
            chkRst = new CheckBox { Left = 730, Top = 14, Width = 60, Text = "RST", Checked = true };
            txtTimeout = new TextBox { Left = 795, Top = 12, Width = 40, Text = "12" };
            var lblTimeout = new Label { Left = 840, Top = 15, Width = 90, Text = "Таймаут, с" };
            lblExtIp = new Label { Left = 940, Top = 15, Width = 200, Text = "Внешний IP: —" };

            lvTargets = new ListView { Left = 10, Top = 45, Width = 320, Height = 450, View = View.Details, FullRowSelect = true, Anchor = AnchorStyles.Top | AnchorStyles.Bottom | AnchorStyles.Left };
            lvTargets.Columns.Add("Name", 140);
            lvTargets.Columns.Add("Host", 160);

            txtName = new TextBox { Left = 10, Top = 505, Width = 150 };
            txtHost = new TextBox { Left = 170, Top = 505, Width = 160 };
            btnAdd = new Button { Text = "Add / Update", Left = 10, Top = 535, Width = 120 };
            btnRemove = new Button { Text = "Remove", Left = 140, Top = 535, Width = 80 };
            btnAdd.Click += BtnAdd_Click;
            btnRemove.Click += BtnRemove_Click;

            lvSteps = new ListView { Left = 340, Top = 45, Width = 620, Height = 200, View = View.Details, FullRowSelect = true, GridLines = true, Anchor = AnchorStyles.Top | AnchorStyles.Left | AnchorStyles.Right };
            lvSteps.Columns.Add("Тест", 160);
            lvSteps.Columns.Add("Статус", 120);
            lvSteps.Columns.Add("Детали", 320);

            pbOverall = new ProgressBar { Left = 340, Top = 250, Width = 620, Height = 14, Style = ProgressBarStyle.Blocks, Anchor = AnchorStyles.Top | AnchorStyles.Left | AnchorStyles.Right };
            lblStatus = new Label { Left = 340, Top = 268, Width = 620, Height = 18, Text = "Готов", Anchor = AnchorStyles.Top | AnchorStyles.Left | AnchorStyles.Right };

            txtLog = new TextBox { Left = 340, Top = 290, Width = 730, Height = 205, Multiline = true, ScrollBars = ScrollBars.Both, ReadOnly = true, Anchor = AnchorStyles.Top | AnchorStyles.Bottom | AnchorStyles.Left | AnchorStyles.Right };

            txtAnalysis = new TextBox { Left = 10, Top = 580, Width = 1050, Height = 80, Multiline = true, ReadOnly = true, ScrollBars = ScrollBars.Vertical, Anchor = AnchorStyles.Bottom | AnchorStyles.Left | AnchorStyles.Right };

            Controls.Add(btnRun);
            Controls.Add(btnSaveJson);
            Controls.Add(btnShowReport);
            Controls.Add(chkDns);
            Controls.Add(chkTcp);
            Controls.Add(chkHttp);
            Controls.Add(chkNoTrace);
            Controls.Add(chkUdp);
            Controls.Add(chkRst);
            Controls.Add(txtTimeout);
            Controls.Add(lblTimeout);
            Controls.Add(lblExtIp);
            Controls.Add(lvTargets);
            Controls.Add(lvSteps);
            Controls.Add(txtName);
            Controls.Add(txtHost);
            Controls.Add(btnAdd);
            Controls.Add(btnRemove);
            Controls.Add(pbOverall);
            Controls.Add(lblStatus);
            Controls.Add(txtLog);
            Controls.Add(txtAnalysis);

            LoadTargetsToListView();
            lvTargets.SelectedIndexChanged += LvTargets_SelectedIndexChanged;
        }

        private void LvTargets_SelectedIndexChanged(object? sender, EventArgs e)
        {
            if (lvTargets.SelectedItems.Count == 0) return;
            var it = lvTargets.SelectedItems[0];
            txtName.Text = it.SubItems[0].Text;
            txtHost.Text = it.SubItems[1].Text;
        }

        private void BtnAdd_Click(object? sender, EventArgs e)
        {
            string name = txtName.Text.Trim();
            string host = txtHost.Text.Trim();
            if (string.IsNullOrEmpty(name) || string.IsNullOrEmpty(host)) return;

            // If exists, update
            foreach (ListViewItem it in lvTargets.Items)
            {
                if (it.SubItems[0].Text.Equals(name, StringComparison.OrdinalIgnoreCase))
                {
                    it.SubItems[1].Text = host;
                    return;
                }
            }
            var item = new ListViewItem(new[] { name, host });
            lvTargets.Items.Add(item);
        }

        private void BtnRemove_Click(object? sender, EventArgs e)
        {
            if (lvTargets.SelectedItems.Count == 0) return;
            lvTargets.Items.Remove(lvTargets.SelectedItems[0]);
        }

        private void LoadTargetsToListView()
        {
            lvTargets.Items.Clear();
            foreach (var kv in Program.Targets)
            {
                lvTargets.Items.Add(new ListViewItem(new[] { kv.Key, kv.Value }));
            }
        }

        private void SaveListViewToProgramTargets()
        {
            Program.Targets.Clear();
            foreach (ListViewItem it in lvTargets.Items)
            {
                var name = it.SubItems[0].Text;
                var host = it.SubItems[1].Text;
                if (!Program.Targets.ContainsKey(name)) Program.Targets.Add(name, host);
            }
        }

        private async void BtnRun_Click(object? sender, EventArgs e)
        {
            btnRun.Enabled = false;
            pbOverall.Style = ProgressBarStyle.Marquee;
            lblStatus.Text = "Выполняется…";
            txtLog.Clear();
            txtAnalysis.Clear();
            _logBuffer.Clear();

            SaveListViewToProgramTargets();

            try
            {
                // Подготовим конфигурацию из UI
                var cfg = Config.Default();
                cfg.Targets = Program.Targets.Values.ToList();
                cfg.NoTrace = !chkNoTrace.Checked;
                cfg.EnableDns = chkDns.Checked;
                cfg.EnableTcp = chkTcp.Checked;
                cfg.EnableHttp = chkHttp.Checked;
                cfg.EnableTrace = chkNoTrace.Checked;
                cfg.EnableUdp = chkUdp.Checked;
                cfg.EnableRst = chkRst.Checked;
                if (int.TryParse(txtTimeout.Text.Trim(), out int t) && t > 0)
                {
                    cfg.HttpTimeoutSeconds = t;
                    cfg.TcpTimeoutSeconds = Math.Min(10, t);
                    cfg.UdpTimeoutSeconds = Math.Min(10, t);
                }

                InitSteps();
                var progress = new Progress<IspAudit.Tests.TestProgress>(UpdateStepUI);
                _cts = new System.Threading.CancellationTokenSource();
                var run = await AuditRunner.RunAsync(cfg, progress, _cts.Token).ConfigureAwait(false);
                _lastRun = run;
                _lastConfig = cfg;

                // Обновим UI
                BeginInvoke(new Action(() =>
                {
                    lblExtIp.Text = "Внешний IP: " + (run.ext_ip ?? "—");
                    txtLog.Text = Output.ReportWriter.BuildHumanText(run, cfg);
                    txtAnalysis.Text = BuildGuiSummary(run);
                }));
            }
            catch (Exception ex)
            {
                AppendText($"Exception: {ex}\r\n");
            }
            finally
            {
                pbOverall.Style = ProgressBarStyle.Blocks;
                lblStatus.Text = "Готов";
                btnRun.Enabled = true;
        }
        }

        private async void BtnSaveJson_Click(object? sender, EventArgs e)
        {
            if (_lastRun == null)
            {
                MessageBox.Show(this, "Сначала запустите тесты.", "ISP Audit", MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }
            using var sfd = new SaveFileDialog { Filter = "JSON (*.json)|*.json", FileName = "isp_report.json" };
            if (sfd.ShowDialog(this) == DialogResult.OK)
            {
                await Output.ReportWriter.SaveJsonAsync(_lastRun, sfd.FileName);
                MessageBox.Show(this, "Отчёт сохранён:\r\n" + sfd.FileName, "ISP Audit", MessageBoxButtons.OK, MessageBoxIcon.Information);
            }
        }

        private void BtnShowReport_Click(object? sender, EventArgs e)
        {
            if (_lastRun == null)
            {
                MessageBox.Show(this, "Сначала запустите тесты.", "ISP Audit", MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }
            var txt = Output.ReportWriter.BuildAdviceText(_lastRun);
            ShowTextDialog("Человеческий отчёт", txt);
        }

        private void AppendText(string s)
        {
            if (InvokeRequired)
            {
                BeginInvoke(new Action(() => AppendText(s)));
                return;
            }
            txtLog.AppendText(s);
        }

        // Краткое резюме для GUI, без парсинга лога — напрямую из объекта RunReport
        private string BuildGuiSummary(Output.RunReport run)
        {
            var sb = new StringBuilder();
            sb.AppendLine($"Итог: DNS={run.summary.dns} TCP={run.summary.tcp} UDP={run.summary.udp} TLS={run.summary.tls}");
            sb.AppendLine();
            foreach (var kv in run.targets)
            {
                var t = kv.Value;
                bool anyOpen = t.tcp.Exists(r => r.open);
                bool httpOk = t.http.Exists(h => h.success && h.status is >= 200 and < 400);
                sb.AppendLine($"— {kv.Key}: DNS={t.dns_status}; Порты={(anyOpen ? "есть" : "нет")}; HTTPS={(httpOk ? "ОК" : "нет")}");
            }
            if (run.udp_test != null)
            {
                sb.AppendLine();
                sb.AppendLine($"UDP DNS {run.udp_test.target}: {(run.udp_test.reply ? "ответ" : "нет ответа")}, RTT={run.udp_test.rtt_ms?.ToString() ?? "-"}мс");
            }
            return sb.ToString();
        }

        private void InitSteps()
        {
            if (InvokeRequired) { BeginInvoke(new Action(InitSteps)); return; }
            lvSteps.Items.Clear();
            if (chkDns.Checked) AddStepRow("DNS", "ожидание");
            if (chkTcp.Checked) AddStepRow("TCP", "ожидание");
            if (chkHttp.Checked) AddStepRow("HTTP", "ожидание");
            if (chkNoTrace.Checked) AddStepRow("Traceroute", "ожидание");
            if (chkUdp.Checked) AddStepRow("UDP", "ожидание");
            if (chkRst.Checked) AddStepRow("RST", "ожидание");
        }

        private void AddStepRow(string name, string status)
        {
            var it = new ListViewItem(new[] { name, status, string.Empty });
            lvSteps.Items.Add(it);
        }

        private void UpdateStepUI(IspAudit.Tests.TestProgress p)
        {
            if (InvokeRequired) { BeginInvoke(new Action<IspAudit.Tests.TestProgress>(UpdateStepUI), p); return; }
            string name = p.Kind switch
            {
                IspAudit.Tests.TestKind.DNS => "DNS",
                IspAudit.Tests.TestKind.TCP => "TCP",
                IspAudit.Tests.TestKind.HTTP => "HTTP",
                IspAudit.Tests.TestKind.TRACEROUTE => "Traceroute",
                IspAudit.Tests.TestKind.UDP => "UDP",
                IspAudit.Tests.TestKind.RST => "RST",
                _ => p.Kind.ToString()
            };
            foreach (ListViewItem it in lvSteps.Items)
            {
                if (it.SubItems[0].Text.Equals(name, StringComparison.OrdinalIgnoreCase))
                {
                    it.SubItems[1].Text = p.Success == null ? "выполняется…" : (p.Success.Value ? "пройден" : "не пройден");
                    it.SubItems[2].Text = p.Message ?? string.Empty;
                    it.ForeColor = p.Success == null ? System.Drawing.Color.DodgerBlue : (p.Success.Value ? System.Drawing.Color.ForestGreen : System.Drawing.Color.Crimson);
                    if (p.Success == null)
                        lblStatus.Text = $"{name}: {p.Status}";
                    else
                        lblStatus.Text = $"{name}: {(p.Success.Value ? "OK" : "ошибка")}";
                    if (p.Kind == IspAudit.Tests.TestKind.TRACEROUTE && !string.IsNullOrWhiteSpace(p.Message))
                    {
                        // прокручиваем подробный лог, чтобы было видно движение
                        txtLog.AppendText(p.Message + Environment.NewLine);
                    }
                    break;
                }
            }
        }

        private void ShowTextDialog(string title, string text)
        {
            using var dlg = new Form { Text = title, Width = 800, Height = 600, StartPosition = FormStartPosition.CenterParent };
            var tb = new TextBox { Multiline = true, ReadOnly = true, ScrollBars = ScrollBars.Both, Dock = DockStyle.Fill, Font = new System.Drawing.Font("Consolas", 10) };
            tb.Text = text;
            dlg.Controls.Add(tb);
            dlg.ShowDialog(this);
        }

        // Custom TextWriter that appends to the TextBox on the UI thread and records to buffer
        private class TextBoxWriter : TextWriter
        {
            private readonly TextBox _box;
            private readonly Control _owner;
            private readonly StringBuilder _buf;
            public override Encoding Encoding => Encoding.UTF8;

            public TextBoxWriter(TextBox box, Control owner, StringBuilder buf)
            {
                _box = box;
                _owner = owner;
                _buf = buf;
            }

            public override void Write(char value)
            {
                if (_owner.IsHandleCreated && !_owner.IsDisposed)
                {
                    _owner.BeginInvoke(new Action(() => _box.AppendText(value.ToString())));
                }
                _buf.Append(value);
            }

            public override void Write(string? value)
            {
                if (value == null) return;
                if (_owner.IsHandleCreated && !_owner.IsDisposed)
                {
                    _owner.BeginInvoke(new Action(() => _box.AppendText(value)));
                }
                _buf.Append(value);
            }

            public override void WriteLine(string? value)
            {
                Write(value + "\r\n");
            }
        }
    }
}



